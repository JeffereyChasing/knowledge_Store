"use strict";(self.webpackChunkbagu=self.webpackChunkbagu||[]).push([[792],{1674:(e,s,t)=>{t(9848);var a=t(6540),n=t(5338),c=t(6868),i=t(7865),r=t(7665);const l=new class{constructor(){this.baseUrl="http://localhost:3001",this.sessions=new Map}async checkServerStatus(){try{console.log("🔍 检查代理服务器状态...");const e=await fetch(`${this.baseUrl}/api/health`),s=await e.json();return console.log("📊 服务器状态:",s),e.ok}catch(e){return console.error("❌ 代理服务器未响应:",e.message),!1}}async sendWelcome(e){if(console.log("🔄 开始发送欢迎消息..."),console.log("用户ID:",e),console.log("目标URL:",`${this.baseUrl}/api/dialogflow/welcome`),!await this.checkServerStatus())return console.error("❌ 代理服务器未运行"),this.getFallbackWelcome();try{console.log("📤 发送欢迎消息请求...");const s={userId:e};console.log("请求体:",s);const t=await fetch(`${this.baseUrl}/api/dialogflow/welcome`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(console.log("📥 收到响应状态:",t.status,t.statusText),!t.ok){const e=await t.text();throw console.error("❌ HTTP 错误:",t.status,e),new Error(`HTTP error! status: ${t.status}`)}const a=await t.json();return console.log("✅ 欢迎消息响应数据:",a),a.success?(console.log("🎉 欢迎消息成功"),{text:a.text,intent:a.intent,success:!0}):(console.warn("⚠️ 欢迎消息返回失败:",a.error),this.getFallbackWelcome())}catch(e){return console.error("💥 欢迎消息请求失败:",e.message),console.error("错误堆栈:",e.stack),this.getFallbackWelcome()}}async detectIntent(e,s){if(console.log("🔄 开始检测意图..."),console.log("消息:",e),console.log("用户ID:",s),!await this.checkServerStatus())return console.error("❌ 代理服务器未运行"),this.getFallbackResponse(e);try{console.log("📤 发送聊天消息请求...");const t={message:e,userId:s};console.log("请求体:",t);const a=await fetch(`${this.baseUrl}/api/dialogflow/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(console.log("📥 收到响应状态:",a.status,a.statusText),!a.ok){const e=await a.text();throw console.error("❌ HTTP 错误:",a.status,e),new Error(`HTTP error! status: ${a.status}`)}const n=await a.json();return console.log("✅ 聊天消息响应数据:",n),n.success?(console.log("🎉 聊天消息成功"),{text:n.text,intent:n.intent,confidence:n.confidence,parameters:n.parameters,success:!0}):(console.warn("⚠️ 聊天消息返回失败:",n.error),this.getFallbackResponse(e))}catch(s){return console.error("💥 聊天消息请求失败:",s.message),this.getFallbackResponse(e)}}getFallbackWelcome(){return console.log("🔄 使用回退欢迎消息"),{text:"👋 你好！我是你的学习助手，我可以帮你：\n\n📚 管理学习分类和题目\n🔍 搜索特定内容\n🔄 安排复习计划\n📊 查看学习统计\n\n请问需要什么帮助？",intent:"welcome_fallback",success:!0}}getFallbackResponse(e){console.log("🔄 使用回退响应");const s=e.toLowerCase();return s.includes("分类")||s.includes("类别")?{text:"📚 正在加载学习分类...",intent:"categories_fallback",success:!0}:s.includes("搜索")||s.includes("查找")||s.includes("找题")?{text:"🔍 请告诉我你想搜索什么题目？",intent:"search_fallback",success:!0}:s.includes("复习")?{text:"🔄 开始复习！我会安排合适的学习计划。",intent:"review_fallback",success:!0}:s.includes("统计")||s.includes("数据")?{text:"📊 正在生成学习统计报告...",intent:"stats_fallback",success:!0}:s.includes("你好")||s.includes("hello")||s.includes("hi")?{text:"👋 你好！我是学习助手，可以帮你管理分类、搜索题目、安排复习。",intent:"greeting_fallback",success:!0}:{text:"🤔 我不太明白。你可以问我关于分类、题目、复习或统计的问题。",intent:"general_fallback",success:!0}}};var o=t(4848);const d=({onNavigate:e,categories:s,questions:t,currentUser:n})=>{const[c,i]=(0,a.useState)(!1),[r,d]=(0,a.useState)([]),[h,u]=(0,a.useState)(""),[m,g]=(0,a.useState)(!1),x=(0,a.useRef)(null);(0,a.useEffect)(()=>{c&&0===r.length&&j()},[c]);const j=async()=>{g(!0);try{const e=await l.sendWelcome(n?.id),s={id:Date.now(),text:e.text,isBot:!0,timestamp:new Date,quickReplies:["查看所有分类","需要复习的题目","学习统计","创建新分类"]};d([s])}catch(e){console.error("Welcome message error:",e);const s={id:1,text:`👋 你好${n?` ${n.getUsername()}`:""}！我是你的学习助手，我可以帮你：\n\n• 导航到不同功能页面\n• 查找分类和题目\n• 管理复习计划\n• 查看学习统计\n\n请问需要什么帮助？`,isBot:!0,timestamp:new Date,quickReplies:["查看所有分类","需要复习的题目","学习统计","创建新分类"]};d([s])}finally{g(!1)}};(0,a.useEffect)(()=>{x.current?.scrollIntoView({behavior:"smooth"})},[r]);const p=async()=>{if(!h.trim())return;const e={id:Date.now(),text:h,isBot:!1,timestamp:new Date};d(s=>[...s,e]),u("");const s=await(async e=>{g(!0);try{const s=await l.detectIntent(e,n?.id);return g(!1),{text:s.text,quickReplies:["查看分类","搜索题目","开始复习","学习统计"],actions:[]}}catch(e){return console.error("Message processing error:",e),g(!1),{text:"网络错误，请稍后重试。",quickReplies:["查看分类","搜索题目","开始复习","学习统计"]}}})(h),t={id:Date.now()+1,text:s.text,isBot:!0,timestamp:new Date,actions:s.actions,quickReplies:s.quickReplies};d(e=>[...e,t])};return(0,o.jsxs)(o.Fragment,{children:[!c&&(0,o.jsxs)("button",{className:"chatbox-floating-btn",onClick:()=>i(!0),title:"AI学习助手",children:[(0,o.jsx)("span",{className:"chatbot-icon",children:"🤖"}),(0,o.jsx)("span",{className:"pulse-dot"})]}),c&&(0,o.jsxs)("div",{className:"chatbox-container",children:[(0,o.jsxs)("div",{className:"chatbox-header",children:[(0,o.jsxs)("div",{className:"chatbox-title",children:[(0,o.jsx)("span",{className:"bot-avatar",children:"🤖"}),(0,o.jsxs)("div",{className:"title-text",children:[(0,o.jsx)("h4",{children:"AI学习助手"}),(0,o.jsx)("span",{className:"status",children:"AI在线"})]})]}),(0,o.jsxs)("div",{className:"header-actions",children:[(0,o.jsx)("button",{className:"clear-btn",onClick:()=>{d([]),j()},title:"清除对话",children:"🗑️"}),(0,o.jsx)("button",{className:"close-btn",onClick:()=>i(!1),children:"×"})]})]}),(0,o.jsxs)("div",{className:"chatbox-messages",children:[r.map(s=>(0,o.jsx)("div",{className:"message "+(s.isBot?"bot-message":"user-message"),children:(0,o.jsxs)("div",{className:"message-content",children:[(0,o.jsx)("div",{className:"message-text",children:s.text.split("\n").map((e,s)=>(0,o.jsxs)("span",{children:[e,(0,o.jsx)("br",{})]},s))}),(0,o.jsx)("div",{className:"message-time",children:s.timestamp.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})}),s.quickReplies&&(0,o.jsx)("div",{className:"quick-replies",children:s.quickReplies.map((e,s)=>(0,o.jsx)("button",{className:"quick-reply-btn",onClick:()=>(u(e),void setTimeout(()=>{p()},100)),children:e},s))}),s.actions&&(0,o.jsx)("div",{className:"action-buttons",children:s.actions.map((s,t)=>(0,o.jsx)("button",{className:"action-btn",onClick:()=>(s=>{if("navigate"===s.type&&e){e(s.target);const t={id:Date.now(),text:`✅ 正在为你跳转到 ${s.label}...`,isBot:!0,timestamp:new Date};d(e=>[...e,t])}else"function"===s.type&&(e=>{if("searchQuestions"===e.target){const e={id:Date.now(),text:"请告诉我你想搜索题目的关键词：",isBot:!0,timestamp:new Date};d(s=>[...s,e])}else console.log("Function action:",e)})(s)})(s),children:s.label},t))})]})},s.id)),m&&(0,o.jsx)("div",{className:"message bot-message",children:(0,o.jsx)("div",{className:"message-content",children:(0,o.jsxs)("div",{className:"typing-indicator",children:[(0,o.jsx)("span",{children:"AI正在思考"}),(0,o.jsxs)("div",{className:"typing-dots",children:[(0,o.jsx)("span",{}),(0,o.jsx)("span",{}),(0,o.jsx)("span",{})]})]})})}),(0,o.jsx)("div",{ref:x})]}),(0,o.jsxs)("div",{className:"chatbox-input",children:[(0,o.jsxs)("div",{className:"input-container",children:[(0,o.jsx)("textarea",{value:h,onChange:e=>u(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),p())},placeholder:"向AI助手提问...",rows:"1",className:"message-input"}),(0,o.jsx)("button",{onClick:p,disabled:!h.trim()||m,className:"send-btn",children:m?"⏳":"📤"})]}),(0,o.jsx)("div",{className:"input-hint",children:"按 Enter 发送，Shift + Enter 换行"})]})]})]})};var h=t(6068),u=t.n(h);const m=new class{constructor(){this.isOnline=!0,this.setupOnlineListeners()}setupOnlineListeners(){"undefined"!=typeof window&&(window.addEventListener("online",()=>{console.log("🌐 网络已连接"),this.isOnline=!0,this.dispatchEvent("online")}),window.addEventListener("offline",()=>{console.log("📶 网络已断开"),this.isOnline=!1,this.dispatchEvent("offline")}),this.isOnline=navigator.onLine)}isOnlineMode(){return this.isOnline}shouldUseOfflineData(){return!this.isOnline}simulateNetworkRequest(){return new Promise((e,s)=>{this.shouldUseOfflineData()?s(new Error("网络不可用，当前处于离线模式")):e()})}dispatchEvent(e,s){"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent(`offline:${e}`,{detail:s}))}addEventListener(e,s){"undefined"!=typeof window&&window.addEventListener(`offline:${e}`,s)}removeEventListener(e,s){"undefined"!=typeof window&&window.removeEventListener(`offline:${e}`,s)}},g=()=>{m.shouldUseOfflineData()?console.log("📦 离线模式：跳过 LeanCloud 初始化"):u().init({appId:"JjTQ2R5rn16RRhUdrcjUSBxW-gzGzoHsz",appKey:"UkvR0e4OPaeW5rYMQwNTvD7Z",serverURL:"https://jjtq2r5r.lc-cn-n1-shared.com"})},x={SORT_BY_NAME:"name",SORT_BY_QUESTION_COUNT:"questionCount",SORT_BY_UPDATED_AT:"updatedAt"},j={categories:{data:null,timestamp:0,ttl:3e5},categoryDetails:new Map,categoryDetailTtl:18e4,questionCounts:new Map,questionCountTtl:12e4},p="offline_categories",v=(e,s)=>e&&Date.now()-e<s,N=()=>{try{const e=localStorage.getItem(p);if(e){const s=JSON.parse(e);return console.log("📦 从离线存储加载分类数据:",s.data.length,"个分类"),s}return{data:[],total:0,page:1,pageSize:50}}catch(e){return console.error("获取离线分类数据失败:",e),{data:[],total:0,page:1,pageSize:50}}},y=e=>{try{const s={data:e,total:e.length,page:1,pageSize:50,timestamp:Date.now()};localStorage.setItem(p,JSON.stringify(s))}catch(e){console.error("保存分类数据到离线存储失败:",e)}},f=async e=>{if(m.shouldUseOfflineData()){console.log("📦 离线模式：跳过题目数量统计");const s={};return e.forEach(e=>{s[e.id]=0}),s}try{const s=e.map(e=>e.id),t={},a=Date.now();s.forEach(e=>{t[e]=0});const n=[];if(s.forEach(e=>{const s=j.questionCounts.get(e);s&&v(s.timestamp,j.questionCountTtl)?t[e]=s.count:n.push(e)}),n.length>0)try{const e=n.map(async e=>{try{const s=u().Object.createWithoutData("Category",e),t=new(u().Query)("Question");return t.equalTo("category",s),{categoryId:e,count:await t.count()}}catch(s){return console.warn(`获取分类 ${e} 题目数量失败:`,s),{categoryId:e,count:0}}}),s=await Promise.all(e);s.forEach(({categoryId:e,count:s})=>{t[e]=s}),s.forEach(({categoryId:e,count:s})=>{j.questionCounts.set(e,{count:s,timestamp:a})})}catch(e){console.warn("批量获取题目数量失败，尝试备用方案:",e);try{const e=n.map(e=>u().Object.createWithoutData("Category",e)),s=new(u().Query)("Question");s.containedIn("category",e),s.select(["category"]),(await s.find()).forEach(e=>{const s=e.get("category");if(s){const e=s.id;t[e]=(t[e]||0)+1}}),n.forEach(e=>{const s=t[e]||0;j.questionCounts.set(e,{count:s,timestamp:a})})}catch(e){console.warn("备用方案也失败:",e)}}return t}catch(e){return console.warn("批量获取题目数量失败:",e),{}}},w=async()=>{if(m.shouldUseOfflineData())return console.log("📦 离线模式：从本地存储获取分类数据"),N().data||[];try{const e=u().User.current();if(!e)throw new Error("用户未登录");const s=Date.now();if(j.categories.data&&v(j.categories.timestamp,j.categories.ttl))return j.categories.data;const t=new(u().Query)("Category");t.equalTo("createdBy",e),t.include("createdBy"),t.descending("updatedAt");const a=await t.find(),n=await f(a),c=a.map(e=>({id:e.id,name:e.get("name"),description:e.get("description"),questionCount:void 0!==n[e.id]?n[e.id]:e.get("questionCount")||0,createdAt:e.get("createdAt"),updatedAt:e.get("updatedAt"),createdBy:e.get("createdBy")}));return j.categories.data=c,j.categories.timestamp=s,y(c),c}catch(e){if(console.error("获取所有分类失败:",e),e.message.includes("offline")||e.message.includes("network")||e.message.includes("CORS"))return console.log("🌐 网络请求失败，尝试使用离线数据"),N().data||[];throw e}},b=async(e={})=>{if(m.shouldUseOfflineData())return console.log("📦 离线模式：从本地存储获取分类数据"),N();try{const s=u().User.current();if(!s)throw new Error("用户未登录");const t=!(e.page||e.pageSize||e.sortBy&&e.sortBy!==x.SORT_BY_UPDATED_AT),a=Date.now();if(t&&j.categories.data&&v(j.categories.timestamp,j.categories.ttl))return{data:j.categories.data,total:j.categories.data.length,page:1,pageSize:j.categories.data.length};const n=new(u().Query)("Category");if(n.equalTo("createdBy",s),e.sortBy===x.SORT_BY_UPDATED_AT?n.descending("updatedAt"):e.sortBy===x.SORT_BY_CREATED_AT?n.descending("createdAt"):n.descending("updatedAt"),e.page&&e.pageSize){const s=(e.page-1)*e.pageSize;n.limit(e.pageSize),n.skip(s)}const c=await n.find(),i=await f(c),r=c.map(e=>({id:e.id,name:e.get("name"),description:e.get("description"),questionCount:void 0!==i[e.id]?i[e.id]:e.get("questionCount")||0,createdAt:e.get("createdAt"),updatedAt:e.get("updatedAt"),createdBy:e.get("createdBy")})),l={data:r,total:r.length,page:e.page||1,pageSize:e.pageSize||r.length};return t&&(j.categories.data=r,j.categories.timestamp=a,y(r)),l}catch(e){if(console.error("获取分类失败:",e),e.message.includes("offline")||e.message.includes("network")||e.message.includes("CORS"))return console.log("🌐 网络请求失败，尝试使用离线数据"),N();throw e}},C=async e=>{if(m.shouldUseOfflineData())throw new Error("离线模式下无法创建分类");try{const s=u().User.current();if(!s)throw new Error("用户未登录");const t=new(u().Object.extend("Category"));t.set("name",e.name),t.set("description",e.description||""),t.set("createdBy",s);const a=new(u().ACL);return a.setReadAccess(s,!0),a.setWriteAccess(s,!0),a.setPublicReadAccess(!1),t.setACL(a),await t.save(),j.categories.data=null,j.categories.timestamp=0,j.categoryDetails.clear(),j.questionCounts.clear(),{id:t.id,name:t.get("name"),description:t.get("description"),questionCount:0,createdAt:t.get("createdAt"),updatedAt:t.get("updatedAt")}}catch(e){throw console.error("创建分类失败:",e),e}},S=new class{constructor(){this.isSupported=this.checkSupport(),this.cacheLimit=30,this.cacheVersion="2.0.0",this.cacheExpiry=6048e5,this.CACHE_KEYS={SW_CACHE:"questions-data-v2",LOCAL_STORAGE:"offline_questions_v2",FALLBACK:"offline_questions_fallback_v2",META:"cache_metadata_v2"},this.cacheState={swAvailable:!1,localStorageAvailable:!1,lastSync:null,strategy:"dual"},this.init()}async init(){try{this.cacheState.swAvailable=await this.checkSWCacheSupport(),this.cacheState.localStorageAvailable=this.checkLocalStorageSupport(),this.determineCacheStrategy(),console.log(`🔄 缓存服务初始化完成 - 策略: ${this.cacheState.strategy}`,{sw:this.cacheState.swAvailable,ls:this.cacheState.localStorageAvailable})}catch(e){console.error("❌ 缓存服务初始化失败:",e),this.cacheState.strategy="none"}}checkSupport(){return"undefined"!=typeof window&&("serviceWorker"in navigator||"caches"in window)}async checkSWCacheSupport(){try{if(!("caches"in window))return!1;const e=await caches.open("test-cache-support");return await e.put(new Request("/test-support"),new Response("test")),await e.delete("/test-support"),!0}catch{return!1}}checkLocalStorageSupport(){try{const e="test_local_storage_support";return localStorage.setItem(e,"test"),localStorage.removeItem(e),!0}catch{return!1}}determineCacheStrategy(){this.cacheState.swAvailable&&this.cacheState.localStorageAvailable?this.cacheState.strategy="dual":this.cacheState.swAvailable?this.cacheState.strategy="sw-only":this.cacheState.localStorageAvailable?this.cacheState.strategy="ls-only":this.cacheState.strategy="none"}setCacheLimit(e){return e>0&&e<=500?(this.cacheLimit=e,console.log(`🔄 缓存题目数量限制设置为: ${e}`),this.updateCacheMetadata(),!0):(console.warn("❌ 缓存数量限制必须在 1-500 之间"),!1)}getCacheLimit(){return this.cacheLimit}async cacheQuestions(e){if(m.shouldUseOfflineData())return console.log("📦 离线模式下跳过缓存操作"),!1;if("none"===this.cacheState.strategy)return console.warn("❌ 当前环境不支持任何缓存策略"),!1;try{const s={questions:e.slice(0,this.cacheLimit),timestamp:Date.now(),version:this.cacheVersion,count:Math.min(e.length,this.cacheLimit),cacheLimit:this.cacheLimit,strategy:this.cacheState.strategy},t=[];return this.cacheState.swAvailable&&t.push(this.cacheToServiceWorker(s)),this.cacheState.localStorageAvailable&&t.push(this.cacheToLocalStorage(s)),await Promise.allSettled(t),this.cacheState.lastSync=Date.now(),this.updateCacheMetadata(s),console.log(`✅ 题目数据双缓存成功: ${s.count} 道题目`,{strategy:this.cacheState.strategy,limit:this.cacheLimit}),this.dispatchEvent("cacheUpdated",{count:s.count,timestamp:s.timestamp,cacheLimit:this.cacheLimit,strategy:this.cacheState.strategy}),!0}catch(e){return console.error("❌ 双缓存策略失败:",e),!1}}async cacheToServiceWorker(e){try{const s=await caches.open(this.CACHE_KEYS.SW_CACHE),t=new Request("/api/cached/questions"),a=new Response(JSON.stringify(e),{headers:{"Content-Type":"application/json"}});return await s.put(t,a),console.log("✅ Service Worker 缓存成功"),!0}catch(e){throw console.error("❌ Service Worker 缓存失败:",e),e}}async cacheToLocalStorage(e){try{return localStorage.setItem(this.CACHE_KEYS.LOCAL_STORAGE,JSON.stringify(e)),console.log("✅ localStorage 缓存成功"),!0}catch(s){console.error("❌ localStorage 缓存失败:",s);try{const s={...e,version:e.version+"-fallback"};return localStorage.setItem(this.CACHE_KEYS.FALLBACK,JSON.stringify(s)),console.log("✅ 使用回退方案缓存成功"),!0}catch(e){throw console.error("❌ 回退方案也失败:",e),s}}}async getCachedQuestions(){if("none"===this.cacheState.strategy)return this.getEmptyCacheData();try{let e=null;return"dual"!==this.cacheState.strategy&&"sw-only"!==this.cacheState.strategy||(e=await this.getFromServiceWorker()),e||"dual"!==this.cacheState.strategy&&"ls-only"!==this.cacheState.strategy||(e=this.getFromLocalStorage()),e?this.isCacheExpired(e.timestamp)?(console.log("🕒 缓存已过期，清理旧数据"),await this.clearCache(),this.getEmptyCacheData()):e:this.getEmptyCacheData()}catch(e){return console.error("❌ 获取缓存数据失败:",e),this.getEmptyCacheData()}}async getFromServiceWorker(){try{const e=await caches.open(this.CACHE_KEYS.SW_CACHE),s=await e.match("/api/cached/questions");if(s){const e=await s.json();return console.log("✅ 从 Service Worker 缓存读取数据"),e}return null}catch(e){return console.error("❌ 从 Service Worker 读取失败:",e),null}}getFromLocalStorage(){try{const e=localStorage.getItem(this.CACHE_KEYS.LOCAL_STORAGE);if(e){const s=JSON.parse(e);return console.log("✅ 从 localStorage 读取数据"),s}const s=localStorage.getItem(this.CACHE_KEYS.FALLBACK);if(s){const e=JSON.parse(s);return console.log("✅ 从回退存储读取数据"),e}return null}catch(e){return console.error("❌ 从 localStorage 读取失败:",e),null}}isCacheExpired(e){return Date.now()-e>this.cacheExpiry}getEmptyCacheData(){return{questions:[],timestamp:null,version:null,count:0,cacheLimit:this.cacheLimit,strategy:this.cacheState.strategy}}getCacheStatus(){if("none"===this.cacheState.strategy)return this.getDefaultCacheStatus();try{let e=null;if(("dual"===this.cacheState.strategy||"sw-only"===this.cacheState.strategy||"ls-only"===this.cacheState.strategy)&&(e=this.getFromLocalStorage()),!e)return this.getDefaultCacheStatus();if(this.isCacheExpired(e.timestamp))return console.log("🕒 缓存状态：已过期"),{...this.getDefaultCacheStatus(),isExpired:!0};const s=this.getCacheMetadata();return{supported:"none"!==this.cacheState.strategy,hasCache:!0,count:e.questions.length,timestamp:e.timestamp,cacheLimit:this.cacheLimit,strategy:this.cacheState.strategy,swAvailable:this.cacheState.swAvailable,lsAvailable:this.cacheState.localStorageAvailable,isExpired:!1,lastSync:this.cacheState.lastSync,metadata:s}}catch(e){return console.error("❌ 获取缓存状态失败:",e),this.getDefaultCacheStatus()}}getDefaultCacheStatus(){return{supported:"none"!==this.cacheState.strategy,hasCache:!1,count:0,timestamp:null,cacheLimit:this.cacheLimit,strategy:this.cacheState.strategy,swAvailable:this.cacheState.swAvailable,lsAvailable:this.cacheState.localStorageAvailable,isExpired:!1,lastSync:this.cacheState.lastSync,metadata:this.getCacheMetadata()}}updateCacheMetadata(e=null){try{const s={version:this.cacheVersion,cacheLimit:this.cacheLimit,lastUpdated:Date.now(),strategy:this.cacheState.strategy,dataInfo:e?{count:e.count,timestamp:e.timestamp}:null};this.cacheState.localStorageAvailable&&localStorage.setItem(this.CACHE_KEYS.META,JSON.stringify(s))}catch(e){console.error("❌ 更新缓存元数据失败:",e)}}getCacheMetadata(){try{if(this.cacheState.localStorageAvailable){const e=localStorage.getItem(this.CACHE_KEYS.META);return e?JSON.parse(e):null}return null}catch{return null}}async clearCache(){try{const e=[];return this.cacheState.swAvailable&&e.push(caches.delete(this.CACHE_KEYS.SW_CACHE).catch(()=>{})),this.cacheState.localStorageAvailable&&Object.values(this.CACHE_KEYS).forEach(e=>{localStorage.removeItem(e)}),await Promise.allSettled(e),this.cacheState.lastSync=null,console.log("🗑️ 所有缓存已清理"),this.dispatchEvent("cacheCleared",{strategy:this.cacheState.strategy}),!0}catch(e){return console.error("❌ 清理缓存失败:",e),!1}}getCacheConfig(){return{cacheLimit:this.cacheLimit,strategy:this.cacheState.strategy,swAvailable:this.cacheState.swAvailable,lsAvailable:this.cacheState.localStorageAvailable,maxLimit:500,minLimit:1,defaultLimit:30,expiryDays:7,version:this.cacheVersion}}resetToDefault(){return this.cacheLimit=30,this.updateCacheMetadata(),console.log("🔄 缓存配置已重置为默认值"),this.cacheLimit}async testCachePerformance(){const e={questions:Array.from({length:10},(e,s)=>({id:s,question:`测试问题 ${s}`,answer:`测试答案 ${s}`})),timestamp:Date.now(),count:10},s=performance.now();try{await this.cacheQuestions(e.questions);const t=await this.getCachedQuestions(),a=performance.now(),n=t.questions.length===e.questions.length,c=a-s;return console.log("📊 缓存性能测试: "+(n?"成功":"失败"),{耗时:`${c.toFixed(2)}ms`,策略:this.cacheState.strategy,数据量:e.questions.length}),{success:n,duration:c,strategy:this.cacheState.strategy}}catch(e){return console.error("❌ 缓存性能测试失败:",e),{success:!1,duration:0,strategy:this.cacheState.strategy}}}dispatchEvent(e,s){"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent(`cache:${e}`,{detail:{...s,timestamp:Date.now(),service:"CacheService"}}))}addEventListener(e,s){"undefined"!=typeof window&&window.addEventListener(`cache:${e}`,s)}removeEventListener(e,s){"undefined"!=typeof window&&window.removeEventListener(`cache:${e}`,s)}},k="medium",A="beginner",E=e=>e&&e.objectId?e.objectId:"string"==typeof e?e:e&&e.id?e.id:null,q=e=>e?u().Object.createWithoutData("Category",e):null;let L=[],D=null;const T=(e,s)=>{if(m.shouldUseOfflineData())return;const t=E(e);t&&(L.push({categoryId:t,change:s}),D&&clearTimeout(D),D=setTimeout(()=>{const e=[...L];L=[],D=null,(async e=>{if(m.shouldUseOfflineData())console.log("📦 离线模式：跳过分类计数更新");else if(0!==e.length)try{const s={};e.forEach(({categoryId:e,change:t})=>{e&&!s[e]&&(s[e]=0),e&&(s[e]+=t)});const t=Object.entries(s).map(async([e,s])=>{try{const t=new(u().Query)("Category"),a=await t.get(e),n=a.get("questionCount")||0,c=Math.max(0,n+s);a.set("questionCount",c),await a.save(),console.log(`分类 ${a.get("name")} 题目数量批量更新: ${n} -> ${c}`)}catch(s){console.error(`更新分类 ${e} 题目数量失败:`,s)}});await Promise.all(t)}catch(e){console.error("批量更新分类题目数量失败:",e)}})(e)},2e3))},$=e=>{const s=e.get("category");return{id:e.id,objectId:e.id,title:e.get("title"),detailedAnswer:e.get("detailedAnswer"),oralAnswer:e.get("oralAnswer"),code:e.get("code"),url:e.get("url"),tags:e.get("tags")||[],difficulty:e.get("difficulty"),proficiency:e.get("proficiency"),appearanceLevel:e.get("appearanceLevel")||50,category:s?{id:s.id,objectId:s.id,name:s.get("name"),description:s.get("description"),questionCount:s.get("questionCount")||0}:null,createdAt:e.get("createdAt"),updatedAt:e.get("updatedAt"),lastReviewedAt:e.get("lastReviewedAt")}},P=e=>new Promise(s=>setTimeout(s,e)),I=()=>{const e=u().User.current();if(!e)throw new Error("用户未登录");return e},Q=(e="操作")=>{if(m.shouldUseOfflineData())throw console.log(`📦 离线模式：无法${e}`),new Error(`离线模式下无法${e}`)},O=async e=>{Q("创建题目");try{const s=I(),t=new(u().Object.extend("Question"));if(t.set("title",e.title||""),t.set("detailedAnswer",e.detailedAnswer||""),t.set("oralAnswer",e.oralAnswer||""),t.set("code",e.code||""),t.set("url",e.url||""),t.set("tags",e.tags||[]),t.set("difficulty",e.difficulty||k),t.set("proficiency",e.proficiency||A),t.set("appearanceLevel",e.appearanceLevel||50),t.set("createdBy",s),e.categoryId){const s=q(e.categoryId);t.set("category",s)}const a=new(u().ACL);return a.setReadAccess(s,!0),a.setWriteAccess(s,!0),a.setPublicReadAccess(!1),t.setACL(a),await t.save(),e.categoryId&&await _(e.categoryId,1),$(t)}catch(e){throw console.error("创建题目失败:",e),e}},U=async e=>{Q("删除题目");try{const s=I(),t=new(u().Query)("Question");t.equalTo("objectId",e),t.equalTo("createdBy",s),t.include("category");const a=await t.first();if(!a)throw new Error("题目不存在或无权删除");const n=a.get("category");return await a.destroy(),n&&await _(n,-1),!0}catch(e){throw console.error("删除题目失败:",e),e}},R=async()=>{if(m.shouldUseOfflineData())return console.log("📦 离线模式：从缓存获取所有题目数据"),(await S.getCachedQuestions()).questions;await P(1e3);try{const e=I(),s=[];let t=0;const a=100;let n=!0;for(;n;){const c=new(u().Query)("Question");c.equalTo("createdBy",e),c.include("category"),c.descending("updatedAt"),c.limit(a),c.skip(t);const i=await c.find();s.push(...i),n=i.length===a,t+=a,console.log(`📦 批量获取题目: 第 ${t/a} 批, 获取 ${i.length} 条`)}const c=s.map(e=>$(e));return console.log("📊 getAllQuestions 实时查询结果:",{题目总数:c.length,批次:t/a+" 批",最新题目:c.slice(0,3).map(e=>({id:e.id,title:e.title}))}),await S.cacheQuestions(c),c}catch(e){if(console.error("获取所有题目失败:",e),e.message.includes("offline")||e.message.includes("network")||e.message.includes("CORS"))return console.log("🌐 网络请求失败，尝试使用缓存数据"),(await S.getCachedQuestions()).questions;throw e}},M=async(e,s)=>{Q("更新题目");try{console.log("questionService: 更新题目",e,s);const t=u().Object.createWithoutData("Question",e);let a=null;s.categoryId&&(a=(await new(u().Query)("Question").include("category").get(e)).get("category")),Object.keys(s).forEach(e=>{if(void 0!==s[e])if("categoryId"===e){const a=q(s[e]);t.set("category",a)}else t.set(e,s[e])});const n=await t.save();if(console.log("questionService: 更新成功",n),s.categoryId&&a){const e=s.categoryId,t=E(a);t!==e&&(t&&T(t,-1),e&&T(e,1))}const c=await new(u().Query)("Question").include("category").get(e);return $(c)}catch(e){throw console.error("questionService: 更新题目失败:",e),e}},_=async(e,s)=>{if(m.shouldUseOfflineData())return;if(!e)return;const t=E(e);if(t)try{const e=new(u().Query)("Category"),a=await e.get(t),n=a.get("questionCount")||0,c=Math.max(0,n+s);a.set("questionCount",c),await a.save(),console.log(`分类 ${a.get("name")} 题目数量立即更新: ${n} -> ${c}`)}catch(e){console.error(`立即更新分类 ${t} 题目数量失败:`,e)}},F=()=>{const[e,s]=(0,a.useState)(!0),[t,n]=(0,a.useState)({});return(0,a.useEffect)(()=>{s(m.isOnlineMode()),n(S.getCacheStatus());const e=()=>s(!0),t=()=>s(!1);m.addEventListener("online",e),m.addEventListener("offline",t);const a=setInterval(()=>{n(S.getCacheStatus())},5e3);return()=>{m.removeEventListener("online",e),m.removeEventListener("offline",t),clearInterval(a)}},[]),e?null:(0,o.jsx)("div",{className:"offline-indicator",children:(0,o.jsxs)("div",{className:"offline-content",children:[(0,o.jsx)("div",{className:"offline-icon",children:"📶"}),(0,o.jsxs)("div",{className:"offline-text",children:[(0,o.jsx)("strong",{children:"离线模式"}),(0,o.jsx)("span",{children:"使用缓存的题目数据"}),t.hasCache&&(0,o.jsxs)("span",{className:"cache-info",children:["已缓存 ",t.count," 道题目"]})]})]})})},W=({questions:e=[],onCacheUpdate:s,currentUser:t})=>{const n=(0,c.Zp)(),[i,r]=(0,a.useState)({}),[l,d]=(0,a.useState)(!1),[h,u]=(0,a.useState)(!0),[g,x]=(0,a.useState)({cacheLimit:30,autoCache:!0,cacheStrategy:"recent"}),[j,p]=(0,a.useState)(30),[v,N]=(0,a.useState)(!1),y=(e=>{const[s,t]=(0,a.useState)(e);return(0,a.useEffect)(()=>{const s=setTimeout(()=>{t(e)},300);return()=>{clearTimeout(s)}},[e,300]),s})(j),f=(e=>{const[s,t]=(0,a.useState)(e),n=(0,a.useRef)(Date.now());return(0,a.useEffect)(()=>{const s=setTimeout(()=>{Date.now()-n.current>=100&&(t(e),n.current=Date.now())},100-(Date.now()-n.current));return()=>{clearTimeout(s)}},[e,100]),s})(j);(0,a.useEffect)(()=>{const e=S.getCacheStatus();r(e),x(e=>({...e,cacheLimit:S.getCacheLimit()})),p(S.getCacheLimit()),u(m.isOnlineMode());const s=()=>u(!0),t=()=>u(!1);return m.addEventListener("online",s),m.addEventListener("offline",t),()=>{m.removeEventListener("online",s),m.removeEventListener("offline",t)}},[]),(0,a.useEffect)(()=>{y!==g.cacheLimit&&(x(e=>({...e,cacheLimit:y})),S.setCacheLimit(y))},[y,g.cacheLimit]);const w=(0,a.useCallback)(async()=>{if(t){d(!0);try{if(await S.cacheQuestions(e)){const e=S.getCacheStatus();r(e),s?.(e),setTimeout(()=>{},100)}}catch(e){console.error("缓存失败:",e)}finally{d(!1)}}else alert("请先登录")},[t,e,s]),b=(0,a.useCallback)(()=>{S.clearCache();const e=S.getCacheStatus();r(e),s?.(e)},[s]),C=(0,a.useCallback)(e=>{p(e)},[]),k=()=>(0,o.jsx)("div",{className:"modal-overlay",children:(0,o.jsxs)("div",{className:"modal-content",children:[(0,o.jsxs)("div",{className:"modal-header",children:[(0,o.jsx)("h3",{children:"⚙️ 缓存设置"}),(0,o.jsx)("button",{className:"close-btn",onClick:()=>N(!1),children:"×"})]}),(0,o.jsxs)("div",{className:"cache-settings-form",children:[(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsxs)("label",{htmlFor:"cacheLimit",children:["缓存题目数量: ",(0,o.jsx)("span",{className:"limit-value",children:f})," 题"]}),(0,o.jsx)("div",{className:"slider-container",children:(0,o.jsx)("input",{id:"cacheLimit",type:"range",min:"10",max:"100",step:"10",value:j,onChange:e=>{const s=parseInt(e.target.value);C(s)},onInput:e=>{const s=(parseInt(e.target.value)-10)/90*100;e.target.style.setProperty("--slider-progress",`${s}%`)},className:"cache-limit-slider"})}),(0,o.jsxs)("div",{className:"slider-labels",children:[(0,o.jsx)("span",{children:"10"}),(0,o.jsx)("span",{children:"30"}),(0,o.jsx)("span",{children:"50"}),(0,o.jsx)("span",{children:"70"}),(0,o.jsx)("span",{children:"90"}),(0,o.jsx)("span",{children:"100"})]}),(0,o.jsx)("div",{className:"setting-feedback",children:j!==g.cacheLimit?(0,o.jsxs)("span",{children:["🔄 将更新为: ",j," 题"]}):(0,o.jsxs)("span",{children:["✅ 当前设置: ",g.cacheLimit," 题"]})})]}),(0,o.jsxs)("div",{className:"form-actions",children:[(0,o.jsx)("button",{type:"button",className:"cancel-btn",onClick:()=>N(!1),children:"取消"}),(0,o.jsx)("button",{type:"button",className:"submit-btn",onClick:()=>{S.setCacheLimit(j),N(!1)},children:"保存设置"})]})]})]})});return(0,o.jsxs)("section",{className:"cache-management-section",children:[(0,o.jsxs)("div",{className:"container",children:[(0,o.jsxs)("div",{className:"cache-overview",children:[(0,o.jsxs)("div",{className:"cache-header",children:[(0,o.jsx)("h2",{children:"💾 缓存管理"}),(0,o.jsx)("p",{children:"管理离线缓存数据，确保在无网络环境下也能正常使用"})]}),(0,o.jsxs)("div",{className:"cache-stats-cards",children:[(0,o.jsxs)("div",{className:"cache-stat-card",children:[(0,o.jsx)("div",{className:"stat-icon",children:"📦"}),(0,o.jsxs)("div",{className:"stat-content",children:[(0,o.jsx)("div",{className:"stat-number",children:i.hasCache?i.count:0}),(0,o.jsx)("div",{className:"stat-label",children:"已缓存题目"})]})]}),(0,o.jsxs)("div",{className:"cache-stat-card",children:[(0,o.jsx)("div",{className:"stat-icon",children:"⚡"}),(0,o.jsxs)("div",{className:"stat-content",children:[(0,o.jsx)("div",{className:"stat-number",children:g.cacheLimit}),(0,o.jsx)("div",{className:"stat-label",children:"缓存限制"})]})]}),(0,o.jsxs)("div",{className:"cache-stat-card",children:[(0,o.jsx)("div",{className:"stat-icon",children:"🕒"}),(0,o.jsxs)("div",{className:"stat-content",children:[(0,o.jsx)("div",{className:"stat-number",children:i.hasCache?"7天":"无"}),(0,o.jsx)("div",{className:"stat-label",children:"缓存有效期"})]})]}),(0,o.jsxs)("div",{className:"cache-stat-card",children:[(0,o.jsx)("div",{className:"stat-icon",children:"🌐"}),(0,o.jsxs)("div",{className:"stat-content",children:[(0,o.jsx)("div",{className:"stat-number",children:h?"在线":"离线"}),(0,o.jsx)("div",{className:"stat-label",children:"网络状态"})]})]})]})]}),(0,o.jsxs)("div",{className:"cache-actions-panel",children:[(0,o.jsxs)("div",{className:"cache-action-group",children:[(0,o.jsx)("h3",{children:"缓存操作"}),(0,o.jsxs)("div",{className:"action-buttons",children:[(0,o.jsx)("button",{onClick:w,disabled:l||!h,className:"cache-action-btn primary "+(l?"loading":""),children:l?(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("div",{className:"loading-spinner"}),"缓存中..."]}):(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("span",{className:"btn-icon",children:"💾"}),"立即缓存题目"]})}),(0,o.jsxs)("button",{onClick:b,disabled:!i.hasCache,className:"cache-action-btn secondary",children:[(0,o.jsx)("span",{className:"btn-icon",children:"🗑️"}),"清理缓存"]}),(0,o.jsxs)("button",{onClick:()=>N(!0),className:"cache-action-btn outline",children:[(0,o.jsx)("span",{className:"btn-icon",children:"⚙️"}),"缓存设置"]})]})]}),i.hasCache&&(0,o.jsxs)("div",{className:"cache-preview",children:[(0,o.jsx)("h3",{children:"缓存预览"}),(0,o.jsxs)("div",{className:"preview-content",children:[(0,o.jsxs)("p",{children:["已缓存 ",i.count," 道题目，点击查看离线题目："]}),(0,o.jsxs)("button",{onClick:()=>n("/offline/questions"),className:"view-offline-btn",children:["📚 查看离线题目 (",i.count,")"]})]})]}),(0,o.jsxs)("div",{className:"cache-tips",children:[(0,o.jsx)("h3",{children:"使用提示"}),(0,o.jsxs)("ul",{children:[(0,o.jsx)("li",{children:"💡 缓存题目后可在无网络环境下查看和复习"}),(0,o.jsx)("li",{children:"⏰ 缓存数据有效期为7天，过期后自动清理"}),(0,o.jsx)("li",{children:"📱 建议在网络良好时进行缓存操作"}),(0,o.jsx)("li",{children:"🔄 题目更新后建议重新缓存以获取最新内容"})]})]})]})]}),v&&(0,o.jsx)(k,{})]})};var B=t(4653),z=t(630),J=t(3161),V=t(2050),H=t(8687),K=t(7018),G=t(8224),Y=t(9107),Z=t(7984),X=t(3495),ee=t(1222);const se=({reviewQuestions:e,setReviewQuestions:s,reviewThreshold:t,setReviewThreshold:n,showReviewSettings:c,setShowReviewSettings:i,onQuestionClick:r,onUpdateQuestionTime:l,questions:d})=>{const[h,m]=(0,a.useState)("all"),[g,x]=(0,a.useState)(""),[j,p]=(0,a.useState)(new Set),[v,N]=(0,a.useState)(u().User.current()),y=e=>{const s=new Date-new Date(e),t=Math.floor(s/864e5),a=Math.floor(t/7),n=Math.floor(t/30);return 0===t?"今天":1===t?"昨天":t<7?`${t}天前`:a<4?`${a}周前`:`${n}月前`},f=e=>{const s=new Date(e.lastReviewedAt||e.createdAt),t=Math.floor((new Date-s)/864e5);return t>=5?"high":t>=3?"medium":"low"},w=e=>{switch(e){case"high":return"急需复习";case"medium":return"建议复习";case"low":return"可稍后复习";default:return"未知"}},b=e=>{switch(e){case"high":return"5天以上未复习";case"medium":return"3-4天未复习";case"low":return"1-2天未复习";default:return""}},C=e=>{if(!e.category?.id)return console.warn("题目没有分类信息，无法跳转"),void alert("该题目没有分类信息，无法跳转");const s=`/category/${e.category.id}`;window.history.pushState?(window.history.pushState(null,"",s),window.dispatchEvent(new PopStateEvent("popstate"))):window.location.href=s,setTimeout(()=>{window.dispatchEvent(new CustomEvent("scrollToQuestion",{detail:{questionId:e.id}}))},100)},S=e.filter(e=>{const s=e.title.toLowerCase().includes(g.toLowerCase())||(e.category?.name||"").toLowerCase().includes(g.toLowerCase());if("all"===h)return s;const t=f(e);return s&&t===h}),k={high:S.filter(e=>"high"===f(e)),medium:S.filter(e=>"medium"===f(e)),low:S.filter(e=>"low"===f(e))},A=()=>{const s=d.length,t=s-e.length;return s>0?t/s*100:0};return v?(0,o.jsx)("section",{className:"review-reminder-section",children:(0,o.jsxs)("div",{className:"container",children:[(0,o.jsxs)("div",{className:"user-welcome-banner",children:[(0,o.jsxs)("h3",{children:["📚 复习提醒 - ",v.getUsername()]}),(0,o.jsx)("p",{children:"及时复习是巩固知识的关键，以下是需要您关注的题目"})]}),(0,o.jsxs)("div",{className:"review-header",children:[(0,o.jsxs)("div",{className:"review-stats",children:[(0,o.jsxs)("div",{className:"stat-card urgent",children:[(0,o.jsx)("div",{className:"stat-icon",children:"🔥"}),(0,o.jsxs)("div",{className:"stat-content",children:[(0,o.jsx)("div",{className:"stat-number",children:k.high.length}),(0,o.jsx)("div",{className:"stat-label",children:"急需复习"}),(0,o.jsx)("div",{className:"stat-description",children:"5天以上"})]})]}),(0,o.jsxs)("div",{className:"stat-card medium",children:[(0,o.jsx)("div",{className:"stat-icon",children:"⚠️"}),(0,o.jsxs)("div",{className:"stat-content",children:[(0,o.jsx)("div",{className:"stat-number",children:k.medium.length}),(0,o.jsx)("div",{className:"stat-label",children:"建议复习"}),(0,o.jsx)("div",{className:"stat-description",children:"3-4天"})]})]}),(0,o.jsxs)("div",{className:"stat-card low",children:[(0,o.jsx)("div",{className:"stat-icon",children:"💡"}),(0,o.jsxs)("div",{className:"stat-content",children:[(0,o.jsx)("div",{className:"stat-number",children:k.low.length}),(0,o.jsx)("div",{className:"stat-label",children:"可稍后复习"}),(0,o.jsx)("div",{className:"stat-description",children:"1-2天"})]})]}),(0,o.jsxs)("div",{className:"stat-card total",children:[(0,o.jsx)("div",{className:"stat-icon",children:"📚"}),(0,o.jsxs)("div",{className:"stat-content",children:[(0,o.jsx)("div",{className:"stat-number",children:e.length}),(0,o.jsx)("div",{className:"stat-label",children:"待复习题目"}),(0,o.jsx)("div",{className:"stat-description",children:"总计"})]})]})]}),(0,o.jsxs)("div",{className:"review-progress",children:[(0,o.jsxs)("div",{className:"progress-header",children:[(0,o.jsx)("span",{children:"复习进度"}),(0,o.jsxs)("span",{children:[Math.round(A()),"%"]})]}),(0,o.jsx)("div",{className:"progress-bar",children:(0,o.jsx)("div",{className:"progress-fill",style:{width:`${A()}%`}})}),(0,o.jsx)("div",{className:"progress-stats",children:(0,o.jsxs)("span",{children:[d.length-e.length," / ",d.length," 题目已及时复习"]})})]})]}),(0,o.jsxs)("div",{className:"review-controls",children:[(0,o.jsxs)("div",{className:"controls-left",children:[(0,o.jsxs)("div",{className:"search-box",children:[(0,o.jsx)("span",{className:"search-icon",children:"🔍"}),(0,o.jsx)("input",{type:"text",placeholder:"搜索题目或分类...",value:g,onChange:e=>x(e.target.value),className:"search-input"})]}),(0,o.jsxs)("div",{className:"urgency-filter",children:[(0,o.jsx)("button",{className:"urgency-btn "+("all"===h?"active":""),onClick:()=>m("all"),children:"全部"}),(0,o.jsx)("button",{className:"urgency-btn high "+("high"===h?"active":""),onClick:()=>m("high"),children:"🔥 急需 (5天+)"}),(0,o.jsx)("button",{className:"urgency-btn medium "+("medium"===h?"active":""),onClick:()=>m("medium"),children:"⚠️ 建议 (3-4天)"}),(0,o.jsx)("button",{className:"urgency-btn low "+("low"===h?"active":""),onClick:()=>m("low"),children:"💡 稍后 (1-2天)"})]})]}),(0,o.jsx)("div",{className:"controls-right",children:(0,o.jsx)("button",{className:"settings-btn",onClick:()=>i(!0),children:"⚙️ 复习设置"})})]}),c&&(0,o.jsx)("div",{className:"modal-overlay",children:(0,o.jsxs)("div",{className:"modal-content",children:[(0,o.jsxs)("div",{className:"modal-header",children:[(0,o.jsx)("h3",{children:"复习提醒设置"}),(0,o.jsx)("button",{className:"close-btn",onClick:()=>i(!1),children:"×"})]}),(0,o.jsxs)("div",{className:"settings-content",children:[(0,o.jsxs)("div",{className:"setting-item",children:[(0,o.jsxs)("label",{htmlFor:"reviewThreshold",children:["复习提醒阈值",(0,o.jsx)("span",{className:"hint",children:"（超过这个天数的题目会出现在复习列表中）"})]}),(0,o.jsxs)("div",{className:"threshold-control",children:[(0,o.jsx)("input",{id:"reviewThreshold",type:"range",min:"1",max:"30",step:"1",value:t,onChange:e=>n(parseInt(e.target.value)),className:"threshold-slider"}),(0,o.jsxs)("span",{className:"threshold-value",children:[t," 天"]})]}),(0,o.jsx)("div",{className:"threshold-presets",children:[1,3,5,7,14,30].map(e=>(0,o.jsxs)("button",{className:"preset-btn "+(t===e?"active":""),onClick:()=>n(e),children:[e,"天"]},e))})]}),(0,o.jsxs)("div",{className:"urgency-explanation",children:[(0,o.jsx)("h4",{children:"📋 紧急程度说明"}),(0,o.jsxs)("div",{className:"urgency-levels",children:[(0,o.jsxs)("div",{className:"urgency-level high",children:[(0,o.jsx)("span",{className:"urgency-color",style:{backgroundColor:"#ff6b6b"}}),(0,o.jsxs)("div",{className:"urgency-info",children:[(0,o.jsx)("strong",{children:"急需复习 (红色)"}),(0,o.jsx)("span",{children:"5天以上未复习的题目"})]})]}),(0,o.jsxs)("div",{className:"urgency-level medium",children:[(0,o.jsx)("span",{className:"urgency-color",style:{backgroundColor:"#ffa726"}}),(0,o.jsxs)("div",{className:"urgency-info",children:[(0,o.jsx)("strong",{children:"建议复习 (橙色)"}),(0,o.jsx)("span",{children:"3-4天未复习的题目"})]})]}),(0,o.jsxs)("div",{className:"urgency-level low",children:[(0,o.jsx)("span",{className:"urgency-color",style:{backgroundColor:"#4ecdc4"}}),(0,o.jsxs)("div",{className:"urgency-info",children:[(0,o.jsx)("strong",{children:"可稍后复习 (青色)"}),(0,o.jsx)("span",{children:"1-2天未复习的题目"})]})]})]})]})]}),(0,o.jsxs)("div",{className:"modal-actions",children:[(0,o.jsx)("button",{className:"cancel-btn",onClick:()=>i(!1),children:"取消"}),(0,o.jsx)("button",{className:"confirm-btn",onClick:()=>i(!1),children:"确认设置"})]})]})}),(0,o.jsx)("div",{className:"review-questions",children:0===S.length?(0,o.jsxs)("div",{className:"empty-review-state",children:[(0,o.jsx)("div",{className:"empty-icon",children:"🎉"}),(0,o.jsx)("h3",{children:"太棒了！没有需要复习的题目"}),(0,o.jsx)("p",{children:"继续保持良好的复习习惯，或者调整复习设置来查看更多题目"}),(0,o.jsx)("button",{className:"adjust-settings-btn",onClick:()=>i(!0),children:"调整复习设置"})]}):(0,o.jsx)("div",{className:"questions-grid",children:S.map((e,t)=>{const a=f(e),n=(e=>{switch(e){case"high":return"#ff6b6b";case"medium":return"#ffa726";case"low":return"#4ecdc4";default:return"#95a5a6"}})(a),c=new Date(e.lastReviewedAt||e.createdAt),i=Math.floor((new Date-c)/864e5),h=j.has(e.id);return(0,o.jsxs)("div",{className:"review-question-card "+(h?"updating":""),onClick:()=>C(e),style:{"--urgency-color":n},children:[(0,o.jsxs)("div",{className:"card-header",children:[(0,o.jsx)("div",{className:"urgency-indicator",style:{backgroundColor:n}}),(0,o.jsxs)("div",{className:"question-meta",children:[(0,o.jsx)("span",{className:"urgency-badge",style:{backgroundColor:n},children:w(a)}),(0,o.jsx)("span",{className:"category-tag",children:e.category?.name||"未分类"})]}),(0,o.jsxs)("div",{className:"time-info",children:[(0,o.jsxs)("span",{className:"last-reviewed",children:["上次复习: ",y(e.lastReviewedAt||e.createdAt)]}),(0,o.jsxs)("span",{className:"days-ago",children:["(",i,"天前)"]}),(0,o.jsx)("span",{className:"urgency-description",children:b(a)})]})]}),(0,o.jsxs)("div",{className:"card-content",children:[(0,o.jsx)("h4",{className:"question-title",children:e.title}),e.detailedAnswer&&(0,o.jsxs)("div",{className:"answer-preview",children:[e.detailedAnswer.substring(0,100),"..."]}),(0,o.jsxs)("div",{className:"question-tags",children:[(0,o.jsx)("span",{className:`difficulty-tag difficulty-${e.difficulty}`,children:"easy"===e.difficulty?"简单":"medium"===e.difficulty?"中等":"困难"}),e.tags&&e.tags.slice(0,3).map((e,s)=>(0,o.jsxs)("span",{className:"tag",children:["#",e]},s))]})]}),(0,o.jsx)("div",{className:"card-footer",children:(0,o.jsxs)("div",{className:"review-actions",children:[(0,o.jsx)("button",{className:"review-now-btn",onClick:t=>(async(e,t)=>{if(t.stopPropagation(),!v)return void alert("请先登录");const a=d.find(s=>s.id===e);if(!a)return console.error("未找到题目:",e),void alert("题目不存在，请刷新页面重试");p(s=>new Set(s).add(e));try{console.log("开始调用 onUpdateQuestionTime..."),await l(e),console.log("onUpdateQuestionTime 调用成功"),s(s=>{const t=s.filter(s=>s.id!==e);return console.log("从复习列表移除后:",t.length),t}),console.log("准备跳转到题目..."),a&&a.category?(console.log("跳转到分类:",a.category.id),r?r(e):C(a)):(console.warn("无法找到题目对应的分类信息"),alert("复习时间已更新，但无法跳转到题目位置"))}catch(s){console.error("更新复习时间失败:",s),console.error("错误详情:",{questionId:e,currentUser:v?.id,errorMessage:s.message});let t="更新失败，请重试";s.message.includes("permission")?t="更新失败：没有权限修改此题目":s.message.includes("Object not found")?t="更新失败：题目不存在或已被删除":s.message.includes("未找到对应的题目")?t="更新失败：本地数据中未找到该题目":s.message.includes("reserved")&&(t="更新失败：数据字段冲突，请刷新页面重试"),alert(t)}finally{p(s=>{const t=new Set(s);return t.delete(e),t})}})(e.id,t),disabled:h,children:h?"🔄 更新中...":"🔍 立即复习"}),(0,o.jsx)("button",{className:"postpone-btn",onClick:s=>((e,s)=>{s.stopPropagation(),alert("已推迟提醒，该题目将在明天再次出现在复习列表中")})(e.id,s),disabled:h,children:"⏰ 稍后提醒"})]})}),h&&(0,o.jsxs)("div",{className:"updating-overlay",children:[(0,o.jsx)("div",{className:"updating-spinner"}),(0,o.jsx)("span",{children:"更新中..."})]})]},e.id)})})})]})}):(0,o.jsx)("section",{className:"review-reminder-section",children:(0,o.jsx)("div",{className:"container",children:(0,o.jsxs)("div",{className:"auth-required-container",children:[(0,o.jsx)("div",{className:"auth-required-icon",children:"🔐"}),(0,o.jsx)("h2",{children:"请先登录"}),(0,o.jsx)("p",{children:"登录后即可查看复习提醒"}),(0,o.jsx)("div",{className:"auth-required-actions",children:(0,o.jsx)("button",{onClick:()=>window.dispatchEvent(new CustomEvent("showAuthModal")),className:"login-btn",children:"立即登录"})})]})})})};var te=t(7286),ae=t(2181);const ne=a.memo(({question:e,index:s})=>{return(0,o.jsx)("div",{className:"question-item",children:(0,o.jsxs)("div",{className:"question-main",children:[(0,o.jsx)("div",{className:"question-header",children:(0,o.jsxs)("div",{className:"question-meta",children:[(0,o.jsxs)("span",{className:"question-index",children:["#",s+1]}),(0,o.jsx)("span",{className:"difficulty-badge",style:{backgroundColor:(e=>{switch(e){case"easy":return"#10b981";case"medium":return"#f59e0b";case"hard":return"#ef4444";default:return"#6b7280"}})(e.difficulty),color:"white"},children:(e=>{switch(e){case"easy":return"简单";case"medium":return"中等";case"hard":return"困难";default:return"未知"}})(e.difficulty)}),(0,o.jsx)("span",{className:"question-time",children:(t=e.createdAt,new Date(t).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}))})]})}),(0,o.jsx)("h4",{className:"question-title",children:e.title}),(0,o.jsx)("div",{className:"question-category",children:(0,o.jsx)("span",{className:"category-tag",children:e.category?.name||"未分类"})})]})});var t});ne.displayName="QuestionItem";const ce=({dayData:e,position:s,onClose:t,isVisible:n})=>{const c=(0,a.useRef)(null),i=(0,r.jE)(),[l,d]=(0,a.useState)([]),[h,g]=(0,a.useState)(new Map),{data:x,isLoading:j}=(0,te.I)({queryKey:["day-questions-batch",e?.date?.toISOString(),e?.questions?.map(e=>e.id).join(",")],queryFn:async()=>{if(!e?.questions?.length)return[];const s=[],t=[];if(e.questions.forEach(e=>{const a=i.getQueryData(["question",e.id]);a?s.push(a):t.push(e.id)}),t.length>0)try{const e=await(async e=>{if(!e||0===e.length)return[];if(m.shouldUseOfflineData())return console.log("📦 离线模式：从缓存批量获取题目"),(await S.getCachedQuestions()).questions.filter(s=>e.includes(s.id)||e.includes(s.objectId));const s=[];for(let t=0;t<e.length;t+=10)s.push(e.slice(t,t+10));const t=[];for(const e of s){await P(1e3);try{const s=I(),a=new(u().Query)("Question");a.containedIn("objectId",e),a.equalTo("createdBy",s),a.include("category");const n=await a.find();t.push(...n.map(e=>$(e)))}catch(e){console.error("批量获取题目失败:",e)}}return t})(t);return e.forEach(e=>{i.setQueryData(["question",e.id],e)}),[...s,...e]}catch(s){return console.warn("批量获取题目失败，使用基础数据:",s),e.questions.map(e=>i.getQueryData(["question",e.id])||e)}return s},enabled:n&&!!e?.questions?.length,staleTime:6e5,cacheTime:18e5,retry:1,retryDelay:1e3});(0,a.useEffect)(()=>{x&&x.length>0?d(x):e?.questions&&d(e.questions)},[x,e?.questions]);const p=(0,a.useRef)(null),v=(0,ae.Te)({count:l.length,getScrollElement:()=>p.current,estimateSize:()=>140,overscan:5}),N=(0,a.useCallback)(e=>{c.current&&!c.current.contains(e.target)&&t()},[t]);(0,a.useEffect)(()=>{if(n)return document.addEventListener("mousedown",N),()=>document.removeEventListener("mousedown",N)},[n,N]);const y=(0,a.useCallback)(e=>{"Escape"===e.key&&t()},[t]);if((0,a.useEffect)(()=>{if(n)return document.addEventListener("keydown",y),()=>document.removeEventListener("keydown",y)},[n,y]),!n||!e)return null;const f=v.getVirtualItems(),w=e.questions?.length||0;return(0,o.jsxs)("div",{ref:c,className:"calendar-tooltip",style:{left:`${Math.min(s.x,window.innerWidth-500)}px`,top:`${s.y}px`,transform:"translateX(-50%)"},children:[(0,o.jsxs)("div",{className:"tooltip-header",children:[(0,o.jsxs)("div",{className:"header-content",children:[(0,o.jsxs)("div",{className:"date-display",children:[(0,o.jsx)("span",{className:"date-day",children:e.date.getDate()}),(0,o.jsxs)("div",{className:"date-info",children:[(0,o.jsx)("span",{className:"date-weekday",children:e.date.toLocaleDateString("zh-CN",{weekday:"long"})}),(0,o.jsx)("span",{className:"date-full",children:e.date.toLocaleDateString("zh-CN",{year:"numeric",month:"long",day:"numeric"})})]})]}),(0,o.jsxs)("div",{className:"stats-badge",children:[(0,o.jsx)("span",{className:"stat-icon",children:"📚"}),(0,o.jsx)("span",{className:"stat-count",children:w}),(0,o.jsx)("span",{className:"stat-label",children:"道题目"})]})]}),(0,o.jsx)("button",{className:"tooltip-close-btn",onClick:t,"aria-label":"关闭",children:(0,o.jsx)("svg",{width:"20",height:"20",viewBox:"0 0 16 16",fill:"currentColor",children:(0,o.jsx)("path",{d:"M12.707 3.293a1 1 0 00-1.414 0L8 6.586 4.707 3.293a1 1 0 00-1.414 1.414L6.586 8l-3.293 3.293a1 1 0 101.414 1.414L8 9.414l3.293 3.293a1 1 0 001.414-1.414L9.414 8l3.293-3.293a1 1 0 000-1.414z"})})})]}),(0,o.jsx)("div",{className:"tooltip-content",children:j?(0,o.jsxs)("div",{className:"loading-state",children:[(0,o.jsx)("div",{className:"loading-spinner"}),(0,o.jsx)("span",{className:"loading-text",children:"加载题目中..."})]}):l.length>0?(0,o.jsx)("div",{ref:p,className:"questions-virtual-container",style:{height:"500px",overflow:"auto"},children:(0,o.jsx)("div",{style:{height:`${v.getTotalSize()}px`,width:"100%",position:"relative"},children:f.map(e=>{const s=l[e.index];return(0,o.jsx)("div",{className:"question-virtual-item",style:{position:"absolute",top:0,left:0,width:"100%",height:`${e.size}px`,transform:`translateY(${e.start}px)`},children:(0,o.jsx)(ne,{question:s,index:e.index})},s.id)})})}):(0,o.jsxs)("div",{className:"empty-state",children:[(0,o.jsx)("div",{className:"empty-icon",children:"📝"}),(0,o.jsx)("h4",{className:"empty-title",children:"这一天没有学习记录"}),(0,o.jsx)("p",{className:"empty-description",children:"开始记录你的学习进度吧"})]})}),l.length>0&&(0,o.jsx)("div",{className:"tooltip-footer",children:(0,o.jsxs)("div",{className:"footer-stats",children:[(0,o.jsxs)("span",{className:"virtual-info",children:["显示 ",f.length," / ",w," 道题目"]}),(0,o.jsx)("span",{className:"scroll-hint",children:"滚动查看更多"})]})}),(0,o.jsx)("div",{className:"tooltip-arrow"})]})},ie=()=>{const[e,s]=(0,a.useState)(null),[t,n]=(0,a.useState)(""),[c,i]=(0,a.useState)(0),r=[{text:"任何足够先进的技术都与魔法无异。",author:"亚瑟·C·克拉克",category:"科技哲学"},{text:"代码就像是幽默，当你需要解释它时，它就不再有趣了。",author:"Cory House",category:"编程"},{text:"首先，解决问题。然后，编写代码。",author:"John Johnson",category:"开发方法"},{text:"编程不是关于你知道什么，而是关于你能弄清楚什么。",author:"Chris Pine",category:"学习"},{text:"简单性是可靠性的先决条件。",author:"Edsger W. Dijkstra",category:"软件工程"},{text:"测试只能证明 bug 的存在，而不能证明它们的不存在。",author:"Edsger W. Dijkstra",category:"测试"},{text:"最好的错误信息是根本不需要错误信息。",author:"Jef Raskin",category:"用户体验"},{text:"过早优化是万恶之源。",author:"Donald Knuth",category:"性能优化"},{text:"代码的阅读次数远多于编写次数。",author:"Guido van Rossum",category:"代码质量"},{text:"完美不是在没有东西可加时达到的，而是在没有东西可拿走时达到的。",author:"Antoine de Saint-Exupéry",category:"设计"},{text:"计算机科学的核心是解决问题。",author:"Abelson and Sussman",category:"计算机科学"},{text:"未来已经到来，只是分布不均。",author:"William Gibson",category:"科技创新"},{text:"最危险的代码是你看不到问题的代码。",author:"Douglas Crockford",category:"代码安全"},{text:"编程是理解的艺术。",author:"Kristen Nygaard",category:"编程哲学"},{text:"技术应该改善生活，而不是支配生活。",author:"Tim Cook",category:"科技伦理"}];(0,a.useEffect)(()=>{const e=setInterval(()=>{i(e=>e===r.length-1?0:e+1)},5e3);return()=>clearInterval(e)},[r.length]);const l=[{id:1,title:"React 官方文档",description:"用于构建用户界面的 JavaScript 库",category:"前端框架",url:"https://react.dev",icon:"⚛️"},{id:2,title:"Vue.js 文档",description:"渐进式 JavaScript 框架",category:"前端框架",url:"https://vuejs.org",icon:"🟢"},{id:3,title:"Angular 文档",description:"Google 开发的前端框架",category:"前端框架",url:"https://angular.io",icon:"🅰️"},{id:4,title:"Svelte 文档",description:"编译时框架，无虚拟DOM",category:"前端框架",url:"https://svelte.dev",icon:"⚡"},{id:5,title:"SolidJS 文档",description:"用于构建用户界面的声明式 JavaScript 库",category:"前端框架",url:"https://solidjs.com",icon:"🔷"},{id:6,title:"Next.js 文档",description:"React 全栈框架",category:"前端框架",url:"https://nextjs.org",icon:"⏭️"},{id:7,title:"Nuxt.js 文档",description:"Vue.js 全栈框架",category:"前端框架",url:"https://nuxtjs.org",icon:"🔥"},{id:8,title:"Redux 文档",description:"JavaScript 应用状态容器",category:"前端状态管理",url:"https://redux.js.org",icon:"📦"},{id:9,title:"Zustand 文档",description:"小型、快速、可扩展的状态管理",category:"前端状态管理",url:"https://github.com/pmndrs/zustand",icon:"🐻"},{id:10,title:"MobX 文档",description:"简单、可扩展的状态管理",category:"前端状态管理",url:"https://mobx.js.org",icon:"🔄"},{id:11,title:"Vuex 文档",description:"Vue.js 的状态管理库",category:"前端状态管理",url:"https://vuex.vuejs.org",icon:"🏪"},{id:12,title:"Tailwind CSS 文档",description:"实用优先的 CSS 框架",category:"CSS 框架",url:"https://tailwindcss.com",icon:"🎨"},{id:13,title:"Bootstrap 文档",description:"最流行的前端框架",category:"CSS 框架",url:"https://getbootstrap.com",icon:"🎯"},{id:14,title:"Sass 文档",description:"专业级 CSS 扩展语言",category:"CSS 框架",url:"https://sass-lang.com",icon:"💎"},{id:15,title:"Less 文档",description:"CSS 预处理器",category:"CSS 框架",url:"http://lesscss.org",icon:"➖"},{id:16,title:"Styled Components",description:"CSS-in-JS 样式库",category:"CSS 框架",url:"https://styled-components.com",icon:"💅"},{id:17,title:"Webpack 文档",description:"模块打包工具",category:"前端构建工具",url:"https://webpack.js.org",icon:"📦"},{id:18,title:"Vite 文档",description:"下一代前端构建工具",category:"前端构建工具",url:"https://vitejs.dev",icon:"⚡"},{id:19,title:"Parcel 文档",description:"零配置构建工具",category:"前端构建工具",url:"https://parceljs.org",icon:"📮"},{id:20,title:"Rollup 文档",description:"JavaScript 模块打包器",category:"前端构建工具",url:"https://rollupjs.org",icon:"🔄"},{id:21,title:"Jest 文档",description:"JavaScript 测试框架",category:"前端测试",url:"https://jestjs.io",icon:"🎭"},{id:22,title:"Cypress 文档",description:"端到端测试框架",category:"前端测试",url:"https://docs.cypress.io",icon:"🎯"},{id:23,title:"Testing Library",description:"DOM 测试工具库",category:"前端测试",url:"https://testing-library.com",icon:"🧪"},{id:24,title:"Vitest 文档",description:"基于 Vite 的测试框架",category:"前端测试",url:"https://vitest.dev",icon:"⚡"},{id:25,title:"Express.js 文档",description:"Node.js Web 应用框架",category:"后端框架",url:"https://expressjs.com",icon:"🚂"},{id:26,title:"Koa 文档",description:"下一代 Node.js 框架",category:"后端框架",url:"https://koajs.com",icon:"🎋"},{id:27,title:"NestJS 文档",description:"用于构建高效、可扩展的服务器端应用",category:"后端框架",url:"https://nestjs.com",icon:"🪺"},{id:28,title:"Fastify 文档",description:"快速且低开销的 Web 框架",category:"后端框架",url:"https://fastify.io",icon:"🚀"},{id:29,title:"Hapi 文档",description:"丰富的框架用于构建应用和服务",category:"后端框架",url:"https://hapi.dev",icon:"🎯"},{id:30,title:"Django 文档",description:"Python Web 框架",category:"后端框架",url:"https://docs.djangoproject.com",icon:"🎸"},{id:31,title:"Flask 文档",description:"Python 微框架",category:"后端框架",url:"https://flask.palletsprojects.com",icon:"🍶"},{id:32,title:"FastAPI 文档",description:"现代、快速的 Python Web 框架",category:"后端框架",url:"https://fastapi.tiangolo.com",icon:"⚡"},{id:33,title:"Spring 文档",description:"Java 应用框架",category:"后端框架",url:"https://spring.io/docs",icon:"🌱"},{id:34,title:"Spring Boot 文档",description:"简化 Spring 应用开发",category:"后端框架",url:"https://spring.io/projects/spring-boot",icon:"👢"},{id:35,title:"Laravel 文档",description:"PHP Web 应用框架",category:"后端框架",url:"https://laravel.com/docs",icon:"🔨"},{id:36,title:"Ruby on Rails 文档",description:"Ruby Web 应用框架",category:"后端框架",url:"https://rubyonrails.org",icon:"💎"},{id:37,title:"ASP.NET Core 文档",description:".NET Web 框架",category:"后端框架",url:"https://docs.microsoft.com/aspnet/core",icon:"🌐"},{id:38,title:"Gin 文档",description:"Go 语言 Web 框架",category:"后端框架",url:"https://gin-gonic.com",icon:"🍸"},{id:39,title:"MySQL 文档",description:"MySQL 数据库官方文档",category:"数据库",url:"https://dev.mysql.com/doc",icon:"🐬"},{id:40,title:"PostgreSQL 文档",description:"PostgreSQL 数据库文档",category:"数据库",url:"https://www.postgresql.org/docs",icon:"🐘"},{id:41,title:"MongoDB 文档",description:"MongoDB NoSQL 数据库文档",category:"数据库",url:"https://docs.mongodb.com",icon:"🍃"},{id:42,title:"Redis 文档",description:"Redis 内存数据结构存储",category:"数据库",url:"https://redis.io/documentation",icon:"🔴"},{id:43,title:"Prisma 文档",description:"下一代 Node.js TypeScript ORM",category:"数据库",url:"https://www.prisma.io",icon:"🛡️"},{id:44,title:"Sequelize 文档",description:"Node.js 的 ORM",category:"数据库",url:"https://sequelize.org",icon:"🗄️"},{id:45,title:"Mongoose 文档",description:"MongoDB 对象建模工具",category:"数据库",url:"https://mongoosejs.com",icon:"🐍"},{id:46,title:"GraphQL 文档",description:"API 查询语言",category:"API 和微服务",url:"https://graphql.org",icon:"📈"},{id:47,title:"Apollo 文档",description:"GraphQL 平台",category:"API 和微服务",url:"https://www.apollographql.com",icon:"🚀"},{id:48,title:"Swagger 文档",description:"API 设计和文档工具",category:"API 和微服务",url:"https://swagger.io",icon:"📝"},{id:49,title:"gRPC 文档",description:"高性能 RPC 框架",category:"API 和微服务",url:"https://grpc.io",icon:"🔧"},{id:50,title:"RESTful API 指南",description:"REST API 最佳实践",category:"API 和微服务",url:"https://restfulapi.net",icon:"🌐"},{id:51,title:"JWT 文档",description:"JSON Web Tokens 官方文档",category:"认证和授权",url:"https://jwt.io",icon:"🔐"},{id:52,title:"OAuth 2.0 指南",description:"OAuth 2.0 授权框架",category:"认证和授权",url:"https://oauth.net/2",icon:"🔑"},{id:53,title:"Passport.js 文档",description:"Node.js 认证中间件",category:"认证和授权",url:"http://www.passportjs.org",icon:"🛂"},{id:54,title:"Auth0 文档",description:"身份验证和授权平台",category:"认证和授权",url:"https://auth0.com/docs",icon:"🔒"},{id:55,title:"Docker 文档",description:"容器化平台文档",category:"部署和 DevOps",url:"https://docs.docker.com",icon:"🐳"},{id:56,title:"Kubernetes 文档",description:"容器编排系统文档",category:"部署和 DevOps",url:"https://kubernetes.io/docs",icon:"⚓"},{id:57,title:"PM2 文档",description:"Node.js 进程管理器",category:"部署和 DevOps",url:"https://pm2.keymetrics.io",icon:"🔄"},{id:58,title:"Nginx 文档",description:"Web 服务器和反向代理",category:"部署和 DevOps",url:"https://nginx.org/en/docs",icon:"🔧"},{id:59,title:"TypeScript 文档",description:"TypeScript 语言文档",category:"编程语言",url:"https://www.typescriptlang.org",icon:"🔷"},{id:60,title:"JavaScript MDN",description:"JavaScript 语言参考文档",category:"编程语言",url:"https://developer.mozilla.org/javascript",icon:"📜"},{id:61,title:"Python 官方文档",description:"Python 编程语言官方文档",category:"编程语言",url:"https://docs.python.org",icon:"🐍"},{id:62,title:"Node.js 文档",description:"Node.js 运行时文档",category:"编程语言",url:"https://nodejs.org",icon:"📦"},{id:63,title:"Git 文档",description:"分布式版本控制系统",category:"开发工具",url:"https://git-scm.com/doc",icon:"📚"},{id:64,title:"NPM 文档",description:"Node 包管理器文档",category:"开发工具",url:"https://docs.npmjs.com",icon:"📦"},{id:65,title:"Yarn 文档",description:"快速、可靠、安全的依赖管理",category:"开发工具",url:"https://yarnpkg.com",icon:"🧶"},{id:66,title:"VS Code 文档",description:"Visual Studio Code 编辑器文档",category:"开发工具",url:"https://code.visualstudio.com/docs",icon:"💻"},{id:67,title:"Lighthouse 文档",description:"自动化网站质量评估工具",category:"性能和优化",url:"https://developers.google.com/web/tools/lighthouse",icon:"💡"},{id:68,title:"Web Vitals",description:"网站用户体验质量指标",category:"性能和优化",url:"https://web.dev/vitals",icon:"📊"},{id:69,title:"Bundlephobia",description:"检查 npm 包大小对性能的影响",category:"性能和优化",url:"https://bundlephobia.com",icon:"📦"}],d=[...new Set(l.map(e=>e.category))],h=l.filter(e=>e.title.toLowerCase().includes(t.toLowerCase())||e.description.toLowerCase().includes(t.toLowerCase())||e.category.toLowerCase().includes(t.toLowerCase())),u=()=>{s(null)};return(0,o.jsxs)("div",{className:"documents-container",children:[(0,o.jsxs)("div",{className:"quotes-carousel",children:[(0,o.jsxs)("div",{className:"carousel-container",children:[(0,o.jsx)("button",{className:"carousel-btn prev-btn",onClick:()=>{i(e=>0===e?r.length-1:e-1)},children:"‹"}),(0,o.jsx)("div",{className:"quote-slide",children:(0,o.jsxs)("div",{className:"quote-content",children:[(0,o.jsx)("div",{className:"quote-icon",children:"💭"}),(0,o.jsxs)("div",{className:"quote-text",children:[(0,o.jsxs)("p",{className:"quote-main",children:['"',r[c].text,'"']}),(0,o.jsxs)("div",{className:"quote-meta",children:[(0,o.jsxs)("span",{className:"quote-author",children:["— ",r[c].author]}),(0,o.jsx)("span",{className:"quote-category",children:r[c].category})]})]})]})}),(0,o.jsx)("button",{className:"carousel-btn next-btn",onClick:()=>{i(e=>e===r.length-1?0:e+1)},children:"›"})]}),(0,o.jsx)("div",{className:"carousel-indicators",children:r.map((e,s)=>(0,o.jsx)("button",{className:"indicator "+(s===c?"active":""),onClick:()=>i(s)},s))})]}),(0,o.jsxs)("div",{className:"documents-header",children:[(0,o.jsx)("h1",{children:"📚 开发文档库"}),(0,o.jsxs)("p",{children:["专注于前端和后端开发文档 - 共 ",l.length," 个资源"]}),(0,o.jsx)("div",{className:"search-section",children:(0,o.jsxs)("div",{className:"search-box",children:[(0,o.jsx)("span",{className:"search-icon",children:"🔍"}),(0,o.jsx)("input",{type:"text",placeholder:"搜索文档名称、描述或类别...",value:t,onChange:e=>n(e.target.value),className:"search-input"}),t&&(0,o.jsx)("button",{className:"clear-search",onClick:()=>n(""),children:"✕"})]})})]}),(0,o.jsxs)("div",{className:"documents-content",children:[d.map(e=>{const t=h.filter(s=>s.category===e);return 0===t.length?null:(0,o.jsxs)("div",{className:"category-section",children:[(0,o.jsxs)("h2",{className:"category-title",children:[e,(0,o.jsxs)("span",{className:"category-count",children:["(",t.length,")"]})]}),(0,o.jsx)("div",{className:"documents-grid",children:t.map(e=>(0,o.jsxs)("div",{className:"document-card",onClick:()=>(e=>{s(e)})(e),children:[(0,o.jsxs)("div",{className:"doc-header",children:[(0,o.jsx)("div",{className:"doc-icon",children:e.icon}),(0,o.jsxs)("div",{className:"doc-info",children:[(0,o.jsx)("h3",{className:"doc-title",children:e.title}),(0,o.jsx)("p",{className:"doc-description",children:e.description}),(0,o.jsx)("div",{className:"doc-category",children:e.category})]})]}),(0,o.jsx)("div",{className:"doc-footer",children:(0,o.jsx)("button",{className:"visit-button",children:"访问网站 →"})})]},e.id))})]},e)}),0===h.length&&(0,o.jsxs)("div",{className:"no-results",children:[(0,o.jsx)("div",{className:"no-results-icon",children:"🔍"}),(0,o.jsx)("h3",{children:"未找到匹配的文档"}),(0,o.jsx)("p",{children:"尝试调整搜索关键词"}),(0,o.jsx)("button",{className:"clear-search-btn",onClick:()=>n(""),children:"清除搜索"})]})]}),e&&(0,o.jsx)("div",{className:"modal-overlay",onClick:u,children:(0,o.jsxs)("div",{className:"modal-content doc-modal",onClick:e=>e.stopPropagation(),children:[(0,o.jsxs)("div",{className:"modal-header",children:[(0,o.jsxs)("div",{className:"modal-title-section",children:[(0,o.jsx)("span",{className:"doc-modal-icon",children:e.icon}),(0,o.jsxs)("div",{children:[(0,o.jsx)("h3",{children:e.title}),(0,o.jsx)("span",{className:"doc-category-badge",children:e.category})]})]}),(0,o.jsx)("button",{className:"close-btn",onClick:u,children:"×"})]}),(0,o.jsxs)("div",{className:"modal-body",children:[(0,o.jsx)("p",{className:"doc-modal-description",children:e.description}),(0,o.jsxs)("div",{className:"doc-url-section",children:[(0,o.jsx)("label",{children:"网站地址:"}),(0,o.jsx)("div",{className:"url-display",children:(0,o.jsx)("span",{className:"url-text",children:e.url})})]})]}),(0,o.jsxs)("div",{className:"modal-actions",children:[(0,o.jsx)("button",{className:"cancel-btn",onClick:u,children:"关闭"}),(0,o.jsx)("button",{className:"visit-site-btn",onClick:()=>{e&&window.open(e.url,"_blank")},children:"🌐 访问网站"})]})]})})]})};class re{static async getPosts(e={}){const{page:s=1,pageSize:t=20,sortBy:a="createdAt",sortOrder:n="desc",keyword:c="",tag:i="",authorId:r=""}=e,l=new(u().Query)("Post");if(l.equalTo("isPublic",!0),l.equalTo("status","published"),c){const e=new(u().Query)("Post");e.contains("title",c);const s=new(u().Query)("Post");s.contains("content",c),l=u().Query.or(e,s)}if(i&&l.equalTo("tags",i),r){const e=u().Object.createWithoutData("_User",r);l.equalTo("author",e)}return l.include("author"),l.limit(t),l.skip((s-1)*t),l.descending(a),l.find()}static async createPost(e){const s=u().User.current();if(!s)throw new Error("请先登录");const t=new(u().Object.extend("Post"));return t.set("title",e.title),t.set("content",e.content),t.set("author",s),t.set("tags",e.tags||[]),t.set("isPublic",!1!==e.isPublic),t.set("status","published"),t.set("likes",0),t.set("views",0),t.set("commentCount",0),t.save()}static async getPostById(e){const s=new(u().Query)("Post");s.include("author");const t=await s.get(e);return t.increment("views",1),await t.save(),t}static async getComments(e,s={}){const{page:t=1,pageSize:a=50}=s,n=new(u().Query)("Comment"),c=u().Object.createWithoutData("Post",e);return n.equalTo("post",c),n.include("author"),n.include("parent"),n.ascending("createdAt"),n.limit(a),n.skip((t-1)*a),n.find()}static async addComment(e,s,t=null){const a=u().User.current();if(!a)throw new Error("请先登录");const n=new(u().Object.extend("Comment")),c=u().Object.createWithoutData("Post",e);if(n.set("post",c),n.set("author",a),n.set("content",s),n.set("likes",0),t){const e=u().Object.createWithoutData("Comment",t);n.set("parent",e)}return c.increment("commentCount",1),c.set("lastCommentedAt",new Date),await c.save(),n.save()}static async toggleLike(e){const s=u().User.current();if(!s)throw new Error("请先登录");const t=u().Object.extend("Like"),a=new(u().Query)("Like"),n=u().Object.createWithoutData("Post",e);a.equalTo("user",s),a.equalTo("post",n);const c=await a.first();if(c){await c.destroy();const s=await new(u().Query)("Post").get(e);return s.increment("likes",-1),await s.save(),{liked:!1}}{const a=new t;a.set("user",s),a.set("post",n),await a.save();const c=await new(u().Query)("Post").get(e);return c.increment("likes",1),await c.save(),{liked:!0}}}static async getPopularTags(e=10){const s=new(u().Query)("Post");s.equalTo("isPublic",!0),s.equalTo("status","published");const t=await s.find(),a={};return t.forEach(e=>{(e.get("tags")||[]).forEach(e=>{a[e]=(a[e]||0)+1})}),Object.entries(a).sort(([,e],[,s])=>s-e).slice(0,e).map(([e,s])=>({tag:e,count:s}))}}const le=({onClose:e,onSuccess:s})=>{const[t,n]=(0,a.useState)({title:"",content:"",tags:"",isPublic:!0}),[c,i]=(0,a.useState)(!1),[r,l]=(0,a.useState)({}),[d,h]=(0,a.useState)({title:0,content:0}),[m,g]=(0,a.useState)([]),x=(0,a.useRef)(null),j=100,p=5e3,v=["JavaScript","React","算法","LeetCode","前端","面试","TypeScript","Vue","CSS","Node.js","数据库","计算机网络","操作系统","数据结构"];(0,a.useEffect)(()=>{x.current&&(x.current.style.height="auto",x.current.style.height=x.current.scrollHeight+"px")},[t.content]),(0,a.useEffect)(()=>{if(t.title.length>5){const e=v.filter(e=>t.title.toLowerCase().includes(e.toLowerCase()));g(e.slice(0,3))}else g([])},[t.title]);const N=(e,s)=>{n(t=>({...t,[e]:s})),h(t=>({...t,[e]:s.length})),r[e]&&l(s=>({...s,[e]:""}))};return(0,o.jsx)("div",{className:"modal-overlay",onClick:e,children:(0,o.jsxs)("div",{className:"create-post-modal",onClick:e=>e.stopPropagation(),children:[(0,o.jsxs)("div",{className:"modal-header",children:[(0,o.jsxs)("div",{className:"header-content",children:[(0,o.jsx)("h3",{children:"✏️ 发布新帖子"}),(0,o.jsx)("p",{children:"分享你的学习心得和经验"})]}),(0,o.jsx)("button",{className:"close-btn",onClick:e,children:"✕"})]}),(0,o.jsxs)("form",{onSubmit:async e=>{if(e.preventDefault(),(()=>{const e={};return t.title.trim()?t.title.length<5?e.title="标题至少需要5个字符":t.title.length>j&&(e.title="标题不能超过100个字符"):e.title="请输入帖子标题",t.content.trim()?t.content.length<10?e.content="内容至少需要10个字符":t.content.length>p&&(e.content="内容不能超过5000个字符"):e.content="请输入帖子内容",l(e),0===Object.keys(e).length})())if(u().User.current()){i(!0);try{const e=t.tags.split(",").map(e=>e.trim()).filter(e=>e).slice(0,5),a={title:t.title.trim(),content:t.content.trim(),tags:e,isPublic:t.isPublic},n=await re.createPost(a);i(!1),s(n)}catch(e){console.error("发布失败:",e),l({submit:e.message||"发布失败，请重试"}),i(!1)}}else alert("请先登录")},className:"post-form",children:[(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsxs)("label",{htmlFor:"post-title",children:["帖子标题 *",(0,o.jsxs)("span",{className:"char-count",style:{color:(()=>{const e=d.title/j;return e>.9?"#ff6b6b":e>.7?"#ffa726":"#4ecdc4"})()},children:[d.title,"/",j]})]}),(0,o.jsx)("input",{id:"post-title",type:"text",placeholder:"请输入有吸引力的标题...",value:t.title,onChange:e=>N("title",e.target.value),className:r.title?"error":"",maxLength:j}),r.title&&(0,o.jsx)("span",{className:"error-message",children:r.title})]}),(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsxs)("label",{htmlFor:"post-content",children:["帖子内容 *",(0,o.jsxs)("span",{className:"char-count",style:{color:(()=>{const e=d.content/p;return e>.9?"#ff6b6b":e>.7?"#ffa726":"#4ecdc4"})()},children:[d.content,"/",p]})]}),(0,o.jsx)("textarea",{ref:x,id:"post-content",placeholder:"详细描述你的问题或分享你的经验...（支持 Markdown 格式）",value:t.content,onChange:e=>N("content",e.target.value),className:r.content?"error":"",maxLength:p,rows:"6"}),r.content&&(0,o.jsx)("span",{className:"error-message",children:r.content}),(0,o.jsxs)("div",{className:"format-tips",children:[(0,o.jsx)("span",{className:"tip-title",children:"格式提示："}),(0,o.jsx)("span",{className:"tip-item",children:"**粗体**"}),(0,o.jsx)("span",{className:"tip-item",children:"*斜体*"}),(0,o.jsx)("span",{className:"tip-item",children:"`代码`"}),(0,o.jsx)("span",{className:"tip-item",children:"- 列表项"})]})]}),(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsxs)("label",{htmlFor:"post-tags",children:["标签",(0,o.jsx)("span",{className:"optional",children:"（可选）"})]}),(0,o.jsx)("input",{id:"post-tags",type:"text",placeholder:"输入标签，用逗号分隔（例如：JavaScript,算法,LeetCode）",value:t.tags,onChange:e=>N("tags",e.target.value)}),m.length>0&&(0,o.jsxs)("div",{className:"tag-suggestions",children:[(0,o.jsx)("span",{className:"suggestions-label",children:"推荐标签："}),m.map(e=>(0,o.jsx)("button",{type:"button",className:"tag-suggestion",onClick:()=>(e=>{const s=t.tags.split(",").map(e=>e.trim()).filter(e=>e);if(!s.includes(e)){const t=[...s,e].join(", ");N("tags",t)}})(e),children:e},e))]}),(0,o.jsx)("div",{className:"tags-hint",children:"最多5个标签，用逗号分隔。合适的标签有助于更多人看到你的帖子。"})]}),(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsxs)("label",{className:"checkbox-label",children:[(0,o.jsx)("input",{type:"checkbox",checked:t.isPublic,onChange:e=>N("isPublic",e.target.checked)}),(0,o.jsx)("span",{className:"checkmark"}),"公开帖子（所有人可见）"]}),(0,o.jsx)("div",{className:"privacy-hint",children:t.isPublic?"✅ 你的帖子将对所有用户可见":"🔒 只有你自己可以看到此帖子"})]}),r.submit&&(0,o.jsxs)("div",{className:"submit-error",children:[(0,o.jsx)("span",{className:"error-icon",children:"⚠️"}),r.submit]}),(0,o.jsxs)("div",{className:"form-actions",children:[(0,o.jsx)("button",{type:"button",onClick:e,className:"cancel-btn",disabled:c,children:"取消"}),(0,o.jsx)("button",{type:"submit",className:"submit-btn",disabled:c,children:c?(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("div",{className:"submit-spinner"}),"发布中..."]}):"🚀 发布帖子"})]})]})]})})},oe=({onSearch:e,placeholder:s="搜索帖子标题或内容..."})=>{const[t,n]=(0,a.useState)(""),[c,i]=(0,a.useState)(!1),[r,l]=(0,a.useState)(!1),d=(0,a.useRef)(null);(0,a.useEffect)(()=>{const s=setTimeout(()=>{e(t)},300);return()=>clearTimeout(s)},[t,e]);const h=s=>{n(s),l(!1),e(s)};return(0,o.jsxs)("div",{className:"search-bar",children:[(0,o.jsxs)("div",{className:"search-input-container "+(c?"focused":""),children:[(0,o.jsx)("div",{className:"search-icon",children:"🔍"}),(0,o.jsx)("input",{ref:d,type:"text",placeholder:s,value:t,onChange:e=>{return s=e.target.value,n(s),void l(s.length>0);var s},onFocus:()=>{i(!0),t.length>0&&l(!0)},onBlur:()=>{i(!1),setTimeout(()=>l(!1),200)},onKeyDown:s=>{"Escape"===s.key?(l(!1),d.current?.blur()):"Enter"===s.key&&(l(!1),e(t))},className:"search-input"}),t&&(0,o.jsx)("button",{className:"clear-search",onClick:()=>{n(""),l(!1),e(""),d.current?.focus()},type:"button",children:"✕"}),r&&(0,o.jsxs)("div",{className:"search-suggestions",children:[(0,o.jsxs)("div",{className:"suggestions-header",children:[(0,o.jsx)("span",{className:"suggestions-title",children:"搜索建议"}),(0,o.jsx)("button",{className:"close-suggestions",onClick:()=>l(!1),children:"✕"})]}),(0,o.jsxs)("div",{className:"suggestions-list",children:[t.length>0&&(0,o.jsxs)("div",{className:"suggestion-item exact-match",onClick:()=>h(t),children:[(0,o.jsx)("span",{className:"suggestion-icon",children:"🔍"}),(0,o.jsxs)("span",{className:"suggestion-text",children:['搜索: "',t,'"']})]}),(0,o.jsxs)("div",{className:"suggestions-section",children:[(0,o.jsx)("div",{className:"section-title",children:"热门搜索"}),["JavaScript","React","算法","LeetCode","前端","面试","TypeScript","Vue"].filter(e=>e.toLowerCase().includes(t.toLowerCase())).map((e,s)=>(0,o.jsxs)("div",{className:"suggestion-item",onClick:()=>h(e),children:[(0,o.jsx)("span",{className:"suggestion-icon",children:"🔥"}),(0,o.jsx)("span",{className:"suggestion-text",children:e})]},s))]}),(0,o.jsxs)("div",{className:"search-tips",children:[(0,o.jsx)("div",{className:"tips-title",children:"搜索提示"}),(0,o.jsxs)("div",{className:"tips-list",children:[(0,o.jsxs)("div",{className:"tip-item",children:[(0,o.jsx)("span",{className:"tip-icon",children:"💡"}),(0,o.jsx)("span",{children:"支持搜索帖子标题、内容和标签"})]}),(0,o.jsxs)("div",{className:"tip-item",children:[(0,o.jsx)("span",{className:"tip-icon",children:"⏎"}),(0,o.jsx)("span",{children:"按 Enter 键快速搜索"})]}),(0,o.jsxs)("div",{className:"tip-item",children:[(0,o.jsx)("span",{className:"tip-icon",children:"⎋"}),(0,o.jsx)("span",{children:"按 ESC 键清除搜索"})]})]})]})]})]})]}),t&&(0,o.jsxs)("div",{className:"search-stats",children:[(0,o.jsxs)("span",{className:"stats-text",children:["正在搜索: ",(0,o.jsxs)("strong",{children:['"',t,'"']})]}),(0,o.jsx)("button",{className:"advanced-search-btn",onClick:()=>l(!0),children:"高级搜索"})]})]})},de=({onTagClick:e,maxTags:s=20})=>{const[t,n]=(0,a.useState)([]),[c,i]=(0,a.useState)(!0),[r,l]=(0,a.useState)(""),d=[{tag:"JavaScript",count:25,color:"#f7df1e"},{tag:"React",count:18,color:"#61dafb"},{tag:"算法",count:22,color:"#4ecdc4"},{tag:"LeetCode",count:20,color:"#ff6b6b"},{tag:"前端",count:15,color:"#667eea"},{tag:"面试",count:12,color:"#f093fb"},{tag:"TypeScript",count:10,color:"#3178c6"},{tag:"Vue",count:8,color:"#41b883"},{tag:"CSS",count:6,color:"#264de4"},{tag:"Node.js",count:5,color:"#68a063"},{tag:"数据库",count:7,color:"#ffa726"},{tag:"计算机网络",count:4,color:"#26c6da"},{tag:"操作系统",count:3,color:"#ab47bc"},{tag:"数据结构",count:9,color:"#ec407a"},{tag:"Git",count:5,color:"#f4511e"}];(0,a.useEffect)(()=>{h()},[]);const h=async()=>{i(!0);try{const e=await re.getPopularTags(s);if(e&&e.length>0){const s=e.map((e,s)=>({...e,color:u(s)}));n(s)}else n(d.slice(0,s))}catch(e){console.error("加载热门标签失败:",e),n(d.slice(0,s))}finally{i(!1)}},u=e=>{const s=["#ff6b6b","#4ecdc4","#45b7d1","#96ceb4","#feca57","#ff9ff3","#54a0ff","#5f27cd","#00d2d3","#ff9f43","#f368e0","#ff9f43","#a55eea","#fd79a8","#e17055","#00b894","#00cec9","#0984e3","#6c5ce7","#b2bec3"];return s[e%s.length]},m=()=>{l(""),e("")};if(c)return(0,o.jsxs)("div",{className:"tag-cloud-loading",children:[(0,o.jsx)("div",{className:"loading-spinner"}),(0,o.jsx)("span",{children:"加载标签中..."})]});const g=Math.max(...t.map(e=>e.count)),x=t.reduce((e,s)=>e+s.count,0);return(0,o.jsxs)("div",{className:"tag-cloud-container",children:[(0,o.jsx)("div",{className:"tag-cloud-header",children:(0,o.jsxs)("div",{className:"tag-cloud-stats",children:[(0,o.jsxs)("span",{className:"stats-text",children:[t.length," 个标签 • ",x," 个帖子"]}),r&&(0,o.jsx)("button",{className:"clear-filter-btn",onClick:m,children:"清除筛选"})]})}),(0,o.jsx)("div",{className:"tag-cloud",children:t.map(({tag:s,count:t,color:a})=>{const n=((e,s)=>{const t=["xs","sm","md","lg","xl"],a=e/s;return a>.8?t[4]:a>.6?t[3]:a>.4?t[2]:a>.2?t[1]:t[0]})(t,g),c=s===r;return(0,o.jsxs)("span",{className:`tag ${n} ${c?"selected":""}`,style:{"--tag-color":a,"--tag-bg-color":c?a:`${a}20`,"--tag-border-color":c?a:`${a}40`},onClick:()=>(s=>{l(s===r?"":s),e(s===r?"":s)})(s),title:`${s} - ${t} 个帖子`,children:[(0,o.jsx)("span",{className:"tag-text",children:s}),(0,o.jsx)("span",{className:"tag-count",children:t})]},s)})}),r&&(0,o.jsx)("div",{className:"selected-tag-info",children:(0,o.jsxs)("span",{className:"selected-tag-badge",children:[(0,o.jsxs)("span",{className:"selected-tag-text",children:["已选择: ",r]}),(0,o.jsx)("button",{className:"remove-selection",onClick:m,children:"✕"})]})}),(0,o.jsx)("div",{className:"tag-cloud-footer",children:(0,o.jsxs)("div",{className:"tag-cloud-tips",children:[(0,o.jsx)("span",{className:"tip-icon",children:"💡"}),(0,o.jsx)("span",{className:"tip-text",children:"点击标签筛选相关帖子"})]})})]})},he=()=>{const[e,s]=(0,a.useState)({totalPosts:0,totalComments:0,totalLikes:0,activeUsers:0,todayPosts:0,trendingTags:[]}),[t,n]=(0,a.useState)(!0),[c,i]=(0,a.useState)(null);(0,a.useEffect)(()=>{r();const e=setInterval(r,3e5);return()=>clearInterval(e)},[]);const r=async()=>{n(!0);try{const e=await new(u().Query)("Post").equalTo("status","published").count().catch(()=>0),t=await new(u().Query)("Comment").count().catch(()=>0),a=await new(u().Query)("Like").count().catch(()=>0),n=new Date;n.setHours(0,0,0,0);const c=await new(u().Query)("Post").greaterThanOrEqualTo("createdAt",n).count().catch(()=>0),r=new Date;r.setDate(r.getDate()-7);const l=await new(u().Query)("Post").greaterThanOrEqualTo("createdAt",r).distinct("author").count().catch(()=>0),o=new(u().Query)("Post"),d=await o.equalTo("status","published").limit(1e3).find().catch(()=>[]),h={};d.forEach(e=>{(e.get("tags")||[]).forEach(e=>{h[e]=(h[e]||0)+1})});const m=Object.entries(h).sort(([,e],[,s])=>s-e).slice(0,5).map(([e,s])=>({tag:e,count:s}));s({totalPosts:e,totalComments:t,totalLikes:a,activeUsers:l,todayPosts:c,trendingTags:m}),i(new Date)}catch(e){console.error("加载统计信息失败:",e),s({totalPosts:0,totalComments:0,totalLikes:0,activeUsers:0,todayPosts:0,trendingTags:[]})}finally{n(!1)}},l=e=>e>=1e4?(e/1e4).toFixed(1)+"万":e>=1e3?(e/1e3).toFixed(1)+"千":e.toString();return t?(0,o.jsxs)("div",{className:"community-stats",children:[(0,o.jsxs)("div",{className:"stats-header",children:[(0,o.jsx)("h4",{children:"📊 社区统计"}),(0,o.jsx)("button",{className:"refresh-btn",onClick:r,children:"🔄"})]}),(0,o.jsxs)("div",{className:"stats-loading",children:[(0,o.jsx)("div",{className:"loading-spinner"}),(0,o.jsx)("span",{children:"加载统计中..."})]})]}):(0,o.jsxs)("div",{className:"community-stats",children:[(0,o.jsxs)("div",{className:"stats-header",children:[(0,o.jsx)("h4",{children:"📊 社区统计"}),(0,o.jsxs)("div",{className:"header-actions",children:[c&&(0,o.jsxs)("span",{className:"update-time",children:["更新于 ",c.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})]}),(0,o.jsx)("button",{className:"refresh-btn",onClick:r,title:"刷新数据",children:"🔄"})]})]}),(0,o.jsxs)("div",{className:"stats-grid",children:[(0,o.jsxs)("div",{className:"stat-card primary",children:[(0,o.jsx)("div",{className:"stat-icon",children:"📝"}),(0,o.jsxs)("div",{className:"stat-content",children:[(0,o.jsx)("div",{className:"stat-number",children:l(e.totalPosts)}),(0,o.jsx)("div",{className:"stat-label",children:"总帖子"}),(0,o.jsxs)("div",{className:"stat-subtext",children:["+",e.todayPosts," 今日"]})]})]}),(0,o.jsxs)("div",{className:"stat-card success",children:[(0,o.jsx)("div",{className:"stat-icon",children:"💬"}),(0,o.jsxs)("div",{className:"stat-content",children:[(0,o.jsx)("div",{className:"stat-number",children:l(e.totalComments)}),(0,o.jsx)("div",{className:"stat-label",children:"总评论"}),(0,o.jsx)("div",{className:"stat-subtext",children:"互动活跃"})]})]}),(0,o.jsxs)("div",{className:"stat-card warning",children:[(0,o.jsx)("div",{className:"stat-icon",children:"👍"}),(0,o.jsxs)("div",{className:"stat-content",children:[(0,o.jsx)("div",{className:"stat-number",children:l(e.totalLikes)}),(0,o.jsx)("div",{className:"stat-label",children:"总点赞"}),(0,o.jsx)("div",{className:"stat-subtext",children:"社区认可"})]})]}),(0,o.jsxs)("div",{className:"stat-card info",children:[(0,o.jsx)("div",{className:"stat-icon",children:"👥"}),(0,o.jsxs)("div",{className:"stat-content",children:[(0,o.jsx)("div",{className:"stat-number",children:l(e.activeUsers)}),(0,o.jsx)("div",{className:"stat-label",children:"活跃用户"}),(0,o.jsx)("div",{className:"stat-subtext",children:"最近7天"})]})]})]}),e.trendingTags.length>0&&(0,o.jsxs)("div",{className:"trending-tags",children:[(0,o.jsx)("h5",{children:"🔥 热门标签"}),(0,o.jsx)("div",{className:"tags-list",children:e.trendingTags.map(({tag:e,count:s},t)=>(0,o.jsxs)("div",{className:"trending-tag",children:[(0,o.jsxs)("span",{className:"tag-rank",children:["#",t+1]}),(0,o.jsx)("span",{className:"tag-name",children:e}),(0,o.jsx)("span",{className:"tag-count",children:s})]},e))})]}),(0,o.jsx)("div",{className:"community-health",children:(0,o.jsxs)("div",{className:"health-indicator",children:[(0,o.jsx)("div",{className:"health-label",children:"社区活跃度"}),(0,o.jsx)("div",{className:"health-bar",children:(0,o.jsx)("div",{className:"health-fill",style:{width:`${Math.min(e.todayPosts/10*100,100)}%`,backgroundColor:e.todayPosts>=5?"#4ecdc4":e.todayPosts>=2?"#ffa726":"#ff6b6b"}})}),(0,o.jsx)("div",{className:"health-status",children:e.todayPosts>=5?"🔥 非常活跃":e.todayPosts>=2?"💪 活跃":"😴 安静"})]})})]})},ue=e=>{if(!e)return"刚刚";const s=new Date-new Date(e),t=Math.floor(s/6e4),a=Math.floor(s/36e5),n=Math.floor(s/864e5);return t<1?"刚刚":t<60?`${t}分钟前`:a<24?`${a}小时前`:n<7?`${n}天前`:new Date(e).toLocaleDateString("zh-CN",{year:"numeric",month:"short",day:"numeric"})},me=({comment:e,onReply:s,onUpdate:t})=>{const[n,c]=(0,a.useState)(e.get("likes")||0),[i,r]=(0,a.useState)(!1),[l,d]=(0,a.useState)(!1),[h,m]=(0,a.useState)(!1),[g,x]=(0,a.useState)(e.get("content")||""),[j,p]=(0,a.useState)(!1),v=()=>{const s=u().User.current();return s&&e.get("author")?.id===s.id},N=()=>{s(e)};return(0,o.jsxs)("div",{className:"comment-item",onMouseEnter:()=>d(!0),onMouseLeave:()=>d(!1),children:[(0,o.jsxs)("div",{className:"comment-header",children:[(0,o.jsxs)("div",{className:"comment-author",children:[(0,o.jsx)("img",{src:e.get("author")?.get("avatar")||"/default-avatar.png",alt:"用户头像",className:"comment-avatar"}),(0,o.jsxs)("div",{className:"author-info",children:[(0,o.jsx)("span",{className:"author-name",children:e.get("author")?.get("username")||"匿名用户"}),v()&&(0,o.jsx)("span",{className:"author-badge",children:"作者"}),(0,o.jsx)("span",{className:"comment-time",children:ue(e.get("createdAt"))})]})]}),l&&(0,o.jsxs)("div",{className:"comment-actions",children:[(0,o.jsx)("button",{className:"action-btn reply-btn",onClick:N,title:"回复",children:"↩️"}),v()&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("button",{className:"action-btn edit-btn",onClick:()=>{m(!0),x(e.get("content")||"")},title:"编辑",children:"✏️"}),(0,o.jsx)("button",{className:"action-btn delete-btn",onClick:async()=>{if(window.confirm("确定要删除这条评论吗？此操作不可撤销。"))try{t()}catch(e){console.error("删除评论失败:",e),alert("删除评论失败: "+e.message)}},title:"删除",children:"🗑️"})]})]})]}),(0,o.jsx)("div",{className:"comment-content",children:h?(0,o.jsxs)("div",{className:"edit-comment",children:[(0,o.jsx)("textarea",{value:g,onChange:e=>x(e.target.value),rows:"3",className:"edit-textarea",maxLength:"1000"}),(0,o.jsxs)("div",{className:"edit-actions",children:[(0,o.jsx)("button",{onClick:()=>{m(!1),x(e.get("content")||"")},className:"cancel-edit-btn",disabled:j,children:"取消"}),(0,o.jsx)("button",{onClick:async()=>{if(g.trim()){p(!0);try{m(!1),t()}catch(e){console.error("更新评论失败:",e),alert("更新评论失败: "+e.message)}finally{p(!1)}}},className:"save-edit-btn",disabled:!g.trim()||j,children:j?"保存中...":"保存"})]})]}):(0,o.jsx)("div",{className:"comment-text",dangerouslySetInnerHTML:{__html:(e.get("content")||"").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`(.*?)`/g,"<code>$1</code>").replace(/\n/g,"<br>")}})}),(0,o.jsxs)("div",{className:"comment-footer",children:[(0,o.jsxs)("button",{className:"like-btn "+(i?"liked":""),onClick:async()=>{try{const s=await re.toggleLike(e.id,"comment");c(s.liked?n+1:Math.max(0,n-1)),r(s.liked)}catch(e){console.error("点赞评论失败:",e)}},children:[(0,o.jsx)("span",{className:"like-icon",children:"👍"}),(0,o.jsx)("span",{className:"like-count",children:n})]}),(0,o.jsx)("button",{className:"reply-footer-btn",onClick:N,children:"回复"})]}),e.get("parent")&&(0,o.jsxs)("div",{className:"reply-indicator",children:["回复 ",(0,o.jsxs)("span",{className:"reply-to",children:["@",e.get("parent")?.get("author")?.get("username")||"用户"]})]})]})},ge=({postId:e})=>{const[s,t]=(0,a.useState)([]),[n,c]=(0,a.useState)(""),[i,r]=(0,a.useState)(!1),[l,d]=(0,a.useState)(!1),[h,m]=(0,a.useState)("newest"),[g,x]=(0,a.useState)(null),j=(0,a.useRef)(null);(0,a.useEffect)(()=>{p()},[e,h]);const p=async()=>{r(!0);try{const s=[...await re.getComments(e)].sort((e,s)=>{switch(h){case"oldest":return new Date(e.get("createdAt"))-new Date(s.get("createdAt"));case"popular":return(s.get("likes")||0)-(e.get("likes")||0);default:return new Date(s.get("createdAt"))-new Date(e.get("createdAt"))}});t(s)}catch(e){console.error("加载评论失败:",e)}finally{r(!1)}},v=async()=>{if(n.trim())if(u().User.current()){d(!0);try{let s=null;g&&(s=g.id),await re.addComment(e,n,s),c(""),x(null),await p(),y("评论发布成功！")}catch(e){console.error("发布评论失败:",e),alert("发布评论失败: "+e.message)}finally{d(!1)}}else alert("请先登录后再评论")},N=e=>{x(e),c(`@${e.get("author")?.get("username")||"用户"} `),j.current?.focus()},y=e=>{console.log(e)};return(0,o.jsxs)("div",{className:"comment-section",children:[(0,o.jsxs)("div",{className:"comment-header",children:[(0,o.jsxs)("h4",{className:"comment-title",children:["💬 ",(()=>{const e=s.length;return 0===e?"暂无评论":1===e?"1 条评论":`${e} 条评论`})()]}),(0,o.jsxs)("div",{className:"comment-controls",children:[(0,o.jsxs)("select",{value:h,onChange:e=>m(e.target.value),className:"sort-select",children:[(0,o.jsx)("option",{value:"newest",children:"最新"}),(0,o.jsx)("option",{value:"oldest",children:"最早"}),(0,o.jsx)("option",{value:"popular",children:"最热"})]}),(0,o.jsx)("button",{className:"refresh-comments",onClick:p,disabled:i,children:"🔄"})]})]}),(0,o.jsxs)("div",{className:"comment-input-section",children:[g&&(0,o.jsxs)("div",{className:"reply-indicator",children:[(0,o.jsxs)("span",{children:["回复 @",g.get("author")?.get("username")||"用户"]}),(0,o.jsx)("button",{onClick:()=>{x(null),c("")},children:"取消"})]}),(0,o.jsxs)("div",{className:"comment-input-wrapper",children:[(0,o.jsx)("textarea",{ref:j,value:n,onChange:e=>c(e.target.value),onKeyDown:e=>{"Enter"===e.key&&(e.ctrlKey||e.metaKey)&&v()},placeholder:g?"写下你的回复...":"写下你的评论...",rows:"3",className:"comment-textarea",maxLength:"1000"}),(0,o.jsxs)("div",{className:"comment-input-footer",children:[(0,o.jsxs)("div",{className:"char-count",children:[n.length,"/1000"]}),(0,o.jsx)("button",{onClick:v,disabled:!n.trim()||l,className:"submit-comment-btn",children:l?(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("div",{className:"submit-spinner"}),"发布中..."]}):"发布评论"})]})]}),(0,o.jsxs)("div",{className:"comment-tips",children:[(0,o.jsx)("span",{className:"tip",children:"💡 支持 Markdown 语法"}),(0,o.jsx)("span",{className:"tip",children:"⏎ + Ctrl 快速发布"})]})]}),(0,o.jsx)("div",{className:"comments-list",children:i?(0,o.jsxs)("div",{className:"comments-loading",children:[(0,o.jsx)("div",{className:"loading-spinner"}),(0,o.jsx)("span",{children:"加载评论中..."})]}):0===s.length?(0,o.jsxs)("div",{className:"no-comments",children:[(0,o.jsx)("div",{className:"no-comments-icon",children:"💬"}),(0,o.jsx)("h5",{children:"还没有评论"}),(0,o.jsx)("p",{children:"成为第一个评论的人吧！"})]}):s.map(e=>(0,o.jsx)(me,{comment:e,onReply:N,onUpdate:p},e.id))})]})},xe=e=>{if(!e)return"刚刚";const s=new Date-new Date(e),t=Math.floor(s/6e4),a=Math.floor(s/36e5),n=Math.floor(s/864e5);return t<1?"刚刚":t<60?`${t}分钟前`:a<24?`${a}小时前`:n<7?`${n}天前`:new Date(e).toLocaleDateString("zh-CN",{month:"short",day:"numeric"})},je=({post:e})=>{const[s,t]=(0,a.useState)(!1),[n,c]=(0,a.useState)(e.get("likes")||0),[i,r]=(0,a.useState)(!1),[l,d]=(0,a.useState)(e.get("views")||0),h=e=>{const s=["#ff6b6b","#4ecdc4","#45b7d1","#96ceb4","#feca57","#ff9ff3","#54a0ff","#5f27cd","#00d2d3","#ff9f43"];return s[e%s.length]};return(0,o.jsxs)("div",{className:"post-card",children:[(0,o.jsxs)("div",{className:"post-header",children:[(0,o.jsxs)("div",{className:"author-section",children:[(0,o.jsx)("img",{src:e.get("author")?.get("avatar")||"/default-avatar.png",alt:"用户头像",className:"author-avatar",style:{width:"40px",height:"40px"}}),(0,o.jsxs)("div",{className:"author-info",children:[(0,o.jsx)("div",{className:"author-name",children:e.get("author")?.get("username")||"匿名用户"}),(0,o.jsxs)("div",{className:"post-meta",children:[(0,o.jsx)("span",{className:"post-time",children:xe(e.get("createdAt"))}),e.get("isPinned")&&(0,o.jsx)("span",{className:"pinned-badge",children:"📌 置顶"})]})]})]}),(0,o.jsx)("div",{className:"post-status",children:e.get("difficulty")&&(0,o.jsx)("span",{className:"difficulty-badge",style:{backgroundColor:(()=>{switch(e.get("difficulty")||"medium"){case"easy":return"#52c41a";case"medium":return"#faad14";case"hard":return"#f5222d";default:return"#666"}})()},children:"easy"===e.get("difficulty")?"简单":"medium"===e.get("difficulty")?"中等":"困难"})})]}),(0,o.jsxs)("div",{className:"post-content",children:[(0,o.jsx)("h3",{className:"post-title",children:e.get("title")}),(0,o.jsx)("div",{className:"post-body",dangerouslySetInnerHTML:{__html:(e.get("content")||"").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`(.*?)`/g,"<code>$1</code>").replace(/\n/g,"<br>")}}),(e.get("content")||"").length>150&&!s&&(0,o.jsx)("button",{className:"read-more-btn",onClick:()=>t(!0),children:"阅读全文"})]}),e.get("tags")&&e.get("tags").length>0&&(0,o.jsx)("div",{className:"post-tags",children:e.get("tags").map((e,s)=>(0,o.jsxs)("span",{className:"post-tag",style:{backgroundColor:h(s)+"20",color:h(s),borderColor:h(s)+"40"},children:["#",e]},e))}),(0,o.jsxs)("div",{className:"post-footer",children:[(0,o.jsxs)("div",{className:"post-stats",children:[(0,o.jsxs)("button",{className:"stat-btn like-btn "+(i?"liked":""),onClick:async()=>{try{const s=await re.toggleLike(e.id);c(s.liked?n+1:Math.max(0,n-1)),r(s.liked)}catch(e){console.error("点赞失败:",e)}},children:[(0,o.jsx)("span",{className:"stat-icon",children:"👍"}),(0,o.jsx)("span",{className:"stat-count",children:n})]}),(0,o.jsxs)("button",{className:"stat-btn comment-btn "+(s?"active":""),onClick:()=>{t(!s),s||d(e=>e+1)},children:[(0,o.jsx)("span",{className:"stat-icon",children:"💬"}),(0,o.jsx)("span",{className:"stat-count",children:e.get("commentCount")||0})]}),(0,o.jsxs)("div",{className:"stat-btn view-btn",children:[(0,o.jsx)("span",{className:"stat-icon",children:"👁️"}),(0,o.jsx)("span",{className:"stat-count",children:l})]})]}),(0,o.jsxs)("div",{className:"post-actions",children:[(0,o.jsx)("button",{className:"action-btn share-btn",children:"🔗 分享"}),(0,o.jsx)("button",{className:"action-btn bookmark-btn",children:"📌 收藏"})]})]}),s&&(0,o.jsx)(ge,{postId:e.id})]})},pe=()=>{const[e,s]=(0,a.useState)("latest"),[t,n]=(0,a.useState)([]),[c,i]=(0,a.useState)([]),[r,l]=(0,a.useState)(!1),[d,h]=(0,a.useState)(!1),[u,m]=(0,a.useState)(""),[g,x]=(0,a.useState)({page:1,pageSize:20,hasMore:!0});(0,a.useEffect)(()=>{j(!0)},[e]),(0,a.useEffect)(()=>{if(""===u.trim())n(c);else{const e=c.filter(e=>e.get("title")?.toLowerCase().includes(u.toLowerCase()));n(e)}},[u,c]);const j=async(s=!1)=>{if(!r){l(!0);try{const t=s?1:g.page,a={page:t,pageSize:g.pageSize,sortBy:"latest"===e?"createdAt":"likes",sortOrder:"desc"},r=await re.getPosts(a);if(s)i(r),n(r);else{const e=[...c,...r];if(i(e),""===u.trim())n(e);else{const s=e.filter(e=>e.get("title")?.toLowerCase().includes(u.toLowerCase()));n(s)}}x(e=>({...e,page:t,hasMore:r.length===g.pageSize}))}catch(e){console.error("加载帖子失败:",e)}finally{l(!1)}}},p=e=>{m(e)};return(0,o.jsx)("section",{className:"community-section",children:(0,o.jsxs)("div",{className:"container",children:[(0,o.jsx)("div",{className:"community-header",children:(0,o.jsxs)("div",{className:"header-content",children:[(0,o.jsxs)("div",{className:"header-text",children:[(0,o.jsx)("h2",{children:"学习社区"}),(0,o.jsx)("p",{children:"与大家一起交流学习心得，分享刷题经验"})]}),(0,o.jsxs)("button",{className:"create-post-btn modern-btn primary",onClick:()=>h(!0),children:[(0,o.jsx)("span",{className:"btn-icon",children:"✏️"}),"发布帖子"]})]})}),(0,o.jsxs)("div",{className:"community-toolbar",children:[(0,o.jsx)("div",{className:"toolbar-left",children:(0,o.jsx)(oe,{onSearch:p,placeholder:"搜索帖子标题..."})}),(0,o.jsx)("div",{className:"toolbar-right",children:(0,o.jsx)(he,{})})]}),u&&(0,o.jsx)("div",{className:"search-results-info",children:(0,o.jsxs)("div",{className:"results-stats",children:[(()=>{if(""===u.trim())return`共 ${c.length} 个帖子`;{const e=c.filter(e=>e.get("title")?.toLowerCase().includes(u.toLowerCase())).length;return`找到 ${t.length} 个匹配标题的帖子（共 ${e} 个）`}})(),u&&(0,o.jsxs)("span",{className:"search-keyword",children:["搜索关键词: ",(0,o.jsxs)("strong",{children:['"',u,'"']})]})]})}),(0,o.jsxs)("div",{className:"community-layout",children:[(0,o.jsxs)("aside",{className:"community-sidebar",children:[(0,o.jsxs)("div",{className:"sidebar-section",children:[(0,o.jsx)("h3",{children:"热门标签"}),(0,o.jsx)(de,{onTagClick:e=>p(e)})]}),(0,o.jsxs)("div",{className:"sidebar-section",children:[(0,o.jsx)("h3",{children:"社区指南"}),(0,o.jsxs)("div",{className:"community-guidelines",children:[(0,o.jsx)("p",{children:"💡 分享学习心得"}),(0,o.jsx)("p",{children:"🤝 互相帮助解答"}),(0,o.jsx)("p",{children:"🎯 保持内容相关"}),(0,o.jsx)("p",{children:"👍 尊重他人观点"})]})]})]}),(0,o.jsxs)("main",{className:"community-main",children:[(0,o.jsxs)("div",{className:"community-tabs",children:[(0,o.jsxs)("button",{className:"modern-tab "+("latest"===e?"active":""),onClick:()=>s("latest"),children:[(0,o.jsx)("span",{className:"tab-icon",children:"🆕"}),(0,o.jsx)("span",{className:"tab-text",children:"最新帖子"})]}),(0,o.jsxs)("button",{className:"modern-tab "+("popular"===e?"active":""),onClick:()=>s("popular"),children:[(0,o.jsx)("span",{className:"tab-icon",children:"🔥"}),(0,o.jsx)("span",{className:"tab-text",children:"热门内容"})]})]}),(0,o.jsxs)("div",{className:"post-list",children:[r&&(0,o.jsxs)("div",{className:"loading",children:[(0,o.jsx)("div",{className:"spinner"}),(0,o.jsx)("span",{children:"加载中..."})]}),t.map(e=>(0,o.jsx)(je,{post:e},e.id)),!r&&0===t.length&&(0,o.jsxs)("div",{className:"empty-state",children:[(0,o.jsx)("div",{className:"empty-icon",children:u?"🔍":"💬"}),(0,o.jsx)("h3",{children:u?"没有找到匹配的帖子":"暂无帖子"}),(0,o.jsx)("p",{children:u?`没有标题包含 "${u}" 的帖子，尝试调整搜索关键词`:"成为第一个分享学习心得的人吧！"}),u&&(0,o.jsx)("button",{onClick:()=>p(""),className:"clear-search-btn",children:"显示所有帖子"})]})]}),g.hasMore&&t.length>0&&""===u&&(0,o.jsx)("div",{className:"load-more-section",children:(0,o.jsx)("button",{onClick:()=>{!r&&g.hasMore&&j(!1)},disabled:r,className:"load-more-btn",children:r?"加载中...":"加载更多"})})]})]}),d&&(0,o.jsx)(le,{onClose:()=>h(!1),onSuccess:e=>{i(s=>[e,...s]),(""===u.trim()||e.get("title")?.toLowerCase().includes(u.toLowerCase()))&&n(s=>[e,...s]),h(!1)}})]})})},ve=new i.E({defaultOptions:{queries:{staleTime:3e5,cacheTime:6e5,retry:1}}}),Ne=()=>{const e=(0,c.Zp)(),[s,t]=(0,a.useState)(""),[n,i]=(0,a.useState)([]),[l,h]=(0,a.useState)([]),[p,v]=(0,a.useState)(!0),[N,y]=(0,a.useState)(null),[f,w]=(0,a.useState)(!1),[k,A]=(0,a.useState)(""),[E,q]=(0,a.useState)("categories"),[L,D]=(0,a.useState)(new Date),[T,$]=(0,a.useState)(!1),[P,I]=(0,a.useState)(""),[Q,O]=(0,a.useState)(""),[U,_]=(0,a.useState)(!1),[te,ae]=(0,a.useState)(!1),[ne,re]=(0,a.useState)(null),[le,oe]=(0,a.useState)(!1),[de,he]=(0,a.useState)(7),[ue,me]=(0,a.useState)([]),[ge,xe]=(0,a.useState)(!1),[je,Ne]=(0,a.useState)(null),[ye,fe]=(0,a.useState)(null),[we,be]=(0,a.useState)({x:0,y:0}),[Ce,Se]=(0,a.useState)(!1),ke=(0,a.useRef)(null),[Ae,Ee]=(0,a.useState)(!0),[qe,Le]=(0,a.useState)({}),[De,Te]=(0,a.useState)([]),[$e,Pe]=(0,a.useState)(!1),[Ie,Qe]=(0,a.useState)({supported:!1,activated:!1,error:null}),[Oe,Ue]=(0,a.useState)({cacheLimit:S.getCacheLimit(),autoCache:!0}),Re=(0,a.useCallback)(async()=>{if(je)try{if(console.log("🔄 通过 Service Worker 缓存题目..."),w(!0),S.setCacheLimit(Oe.cacheLimit),await S.cacheQuestions(l)){const e=await S.getCacheStatus();Le(e),setTimeout(()=>A(""),3e3)}}catch(e){console.error("预缓存失败:",e),A("缓存失败: "+e.message)}finally{w(!1)}},[je,l,Oe.cacheLimit]),[Me,_e]=(0,a.useState)(!1),Fe=()=>(0,o.jsx)("div",{className:"modal-overlay",children:(0,o.jsxs)("div",{className:"modal-content",children:[(0,o.jsxs)("div",{className:"modal-header",children:[(0,o.jsx)("h3",{children:"📦 离线缓存设置"}),(0,o.jsx)("button",{className:"close-btn",onClick:()=>_e(!1),children:"×"})]}),(0,o.jsxs)("div",{className:"cache-settings-form",children:[(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsxs)("label",{htmlFor:"cacheLimit",children:["缓存题目数量: ",Oe.cacheLimit," 题"]}),(0,o.jsx)("input",{id:"cacheLimit",type:"range",min:"10",max:"100",step:"10",value:Oe.cacheLimit,onChange:e=>Ue(s=>({...s,cacheLimit:parseInt(e.target.value)})),className:"cache-limit-slider"}),(0,o.jsxs)("div",{className:"range-labels",children:[(0,o.jsx)("span",{children:"10题"}),(0,o.jsx)("span",{children:"100题"})]}),(0,o.jsxs)("div",{className:"cache-hint",children:["当前配置: 最多缓存 ",Oe.cacheLimit," 道题目供离线使用"]})]}),(0,o.jsxs)("div",{className:"form-actions",children:[(0,o.jsx)("button",{type:"button",className:"cancel-btn",onClick:()=>_e(!1),children:"取消"}),(0,o.jsx)("button",{type:"button",className:"submit-btn",onClick:()=>{S.setCacheLimit(Oe.cacheLimit),_e(!1),setTimeout(()=>A(""),3e3)},children:"保存设置"})]})]})]})}),We=(0,a.useCallback)(async()=>{try{const e=await S.getCachedQuestions();Te(e.questions),Pe(!0),console.log("📦 加载离线数据:",e.questions.length)}catch(e){console.error("加载离线数据失败:",e)}},[]),Be=(0,a.useCallback)(async()=>{w(!0),A("正在缓存题目数据...");try{await Re(),Le(S.getCacheStatus())}catch(e){A("缓存失败: "+e.message)}finally{w(!1)}},[Re]);(0,a.useEffect)(()=>{const e=()=>{Ee(!0),Pe(!1)},s=()=>{Ee(!1),S.getCacheStatus().hasCache&&We()};return m.addEventListener("online",e),m.addEventListener("offline",s),Ee(m.isOnlineMode()),Le(S.getCacheStatus()),()=>{m.removeEventListener("online",e),m.removeEventListener("offline",s)}},[We]),(0,a.useEffect)(()=>{const e=u().User.current();Ne(e),e?m.shouldUseOfflineData()?(console.log("🚀 启动离线模式"),Pe(!0),We(),v(!1)):Ye():v(!1)},[]),(0,a.useEffect)(()=>{if(!S.isSupported)return;const e=e=>{const{count:s,timestamp:t}=e.detail;A(""),Le(e=>({...e,hasCache:!0,count:s}))},s=e=>{Qe(s=>({...s,activated:!0,version:e.detail.version})),console.log("🚀 Service Worker 已激活:",e.detail.version)};return S.addEventListener("cacheUpdated",e),S.addEventListener("swActivated",s),Qe(e=>({...e,supported:S.isSupported})),()=>{S.removeEventListener("cacheUpdated",e),S.removeEventListener("swActivated",s)}},[]),(0,a.useEffect)(()=>{if(je&&l.length>0){const e=setTimeout(()=>{Re()},3e3);return()=>clearTimeout(e)}},[je,l,Re]);const ze=(0,a.useCallback)(async()=>{console.log("🔄 手动刷新数据..."),A("刷新数据中...");try{console.log("清理所有缓存"),console.log("清理分类缓存"),await Ye(),A("数据刷新成功！"),setTimeout(()=>A(""),3e3)}catch(e){console.error("刷新数据失败:",e),A("刷新失败: "+e.message),setTimeout(()=>A(""),5e3)}},[]);(0,a.useEffect)(()=>{const e=()=>{console.log("📝 检测到题目创建，自动刷新数据..."),setTimeout(()=>{ze()},1e3)};return window.addEventListener("questionCreated",e),()=>{window.removeEventListener("questionCreated",e)}},[ze]),(0,a.useEffect)(()=>{const e=u().User.current();Ne(e),e?Ye():v(!1)},[]);const Je=async e=>{if(e.preventDefault(),je)if(P.trim()){_(!0);try{const e=await C({name:P.trim(),description:Q.trim()||void 0});i(s=>[e,...s]),I(""),O(""),$(!1),A(`分类 "${e.name}" 创建成功！`),setTimeout(()=>A(""),3e3)}catch(e){console.error("创建分类失败:",e),A("创建分类失败: "+(e.message||"请检查网络连接"))}finally{_(!1)}}else alert("请输入分类名称");else alert("请先登录")},Ve=(0,a.useCallback)((e,s)=>{s.stopPropagation(),re(e),ae(!0)},[]),He=async()=>{if(ne){oe(!0);try{await(async e=>{if(m.shouldUseOfflineData())throw new Error("离线模式下无法删除分类");try{const s=u().Object.createWithoutData("Category",e),t=new(u().Query)("Question");t.equalTo("category",s);const a=await t.find();let n=0;return a.length>0&&(await u().Object.destroyAll(a),n=a.length),await s.destroy(),(e=>{e&&(j.categoryDetails.delete(e),j.questionCounts.delete(e)),j.categories.data=null,j.categories.timestamp=0})(e),{success:!0,message:`类别及关联的 ${n} 个题目已删除`,deletedQuestions:n}}catch(e){throw console.error("删除类别失败:",e),new Error(`删除失败: ${e.message}`)}})(ne.id),i(e=>e.filter(e=>e.id!==ne.id)),ae(!1),re(null),A(`分类 "${ne.name}" 删除成功！`),setTimeout(()=>A(""),3e3)}catch(e){console.error("删除分类失败:",e),A("删除分类失败: "+(e.message||"请检查网络连接"))}finally{oe(!1)}}},Ke=(0,a.useCallback)(()=>{ae(!1),re(null)},[]),Ge=async e=>{try{if(console.log("更新题目复习时间:",e),!l.find(s=>s.id===e))throw new Error("未找到对应的题目");const s=new Date;return await M(e,{lastReviewedAt:s}),console.log("LeanCloud 更新成功，开始更新本地状态"),h(t=>t.map(t=>t.id===e?{...t,lastReviewedAt:s.toISOString()}:t)),console.log(`题目 ${e} 复习时间已更新`),!0}catch(s){throw console.error("更新题目时间失败:",s),console.error("错误详情:",{questionId:e,errorMessage:s.message,errorStack:s.stack}),s}};(0,a.useEffect)(()=>{const e=e=>{e.error&&(e.error.message.includes("network")||e.error.message.includes("offline")||e.error.message.includes("CORS")||e.error.message.includes("LeanCloud"))&&(console.log("🌐 捕获到网络错误，切换到离线模式"),Pe(!0),e.preventDefault())};return window.addEventListener("error",e),()=>{window.removeEventListener("error",e)}},[]),(0,a.useEffect)(()=>{l.length>0&&(()=>{const e=new Date,s=24*de*60*60*1e3,t=l.filter(t=>{const a=new Date(t.lastReviewedAt||t.createdAt);return e-a>=s}).sort((e,s)=>new Date(e.lastReviewedAt||e.createdAt)-new Date(s.lastReviewedAt||s.createdAt));me(t)})()},[l,de]);const Ye=async()=>{try{m.shouldUseOfflineData()||g(),console.log("🔄 开始加载数据...");const[e,s]=await Promise.all([b({page:1,pageSize:50,sortBy:x.SORT_BY_UPDATED_AT,sortOrder:"desc"}),R()]);console.log("✅ 数据加载完成:",{分类数据:e.data.length,题目数据:s.length,模式:m.shouldUseOfflineData()?"离线":"在线"}),i(e.data),h(s),v(!1)}catch(e){if(console.error("❌ 初始化数据失败:",e),e.message.includes("offline")||e.message.includes("network")){console.log("🌐 网络错误，切换到完全离线模式"),Pe(!0);try{const e=await S.getCachedQuestions();return Te(e.questions),i([]),h([]),void v(!1)}catch(e){console.error("加载离线数据也失败:",e)}}y(e.message),v(!1)}},Ze=(0,a.useMemo)(()=>n.filter(e=>e.name.toLowerCase().includes(s.toLowerCase())),[n,s]),Xe=(0,a.useMemo)(()=>{if(!n.length)return{totalCategories:0,totalQuestions:0,categoriesWithQuestions:0};const e=n.reduce((e,s)=>e+(s.questionCount||0),0),s=n.filter(e=>(e.questionCount||0)>0).length;return console.log("🔍 详细统计信息:",{分类总数:n.length,基于分类的题目总数:e,基于所有题目的题目总数:l.length,差异:Math.abs(e-l.length),有题目的分类数:s,对象:l,各分类详情:n.map(e=>({分类名称:e.name,服务层题目数:e.questionCount,前端计算题目数:l.filter(s=>s.category?.id===e.id).length,是否匹配:e.questionCount===l.filter(s=>s.category?.id===e.id).length}))}),{totalCategories:n.length,totalQuestions:e,categoriesWithQuestions:s}},[n,l]),es=(0,a.useCallback)(e=>{const s=e.toISOString().split("T")[0];return l.filter(e=>new Date(e.createdAt).toISOString().split("T")[0]===s).sort((e,s)=>new Date(s.createdAt)-new Date(e.createdAt))},[l]),ss=(0,a.useCallback)(e=>0===e?"#f8f9fa":e<=1?"#4CAF50":e<=3?"#8BC34A":e<=5?"#FFC107":e<=8?"#FF9800":"#F44336",[]),ts=(0,a.useCallback)(()=>{const e=new Date(L.getFullYear(),L.getMonth(),1),s=new Date(L.getFullYear(),L.getMonth()+1,0),t={};l.forEach(a=>{const n=new Date(a.createdAt);if(n>=e&&n<=s){const e=n.toISOString().split("T")[0];t[e]=(t[e]||0)+1}});const a=[],n=new Date(e);for(;n<=s;){const e=n.toISOString().split("T")[0],s=es(n),t=s.length;a.push({date:new Date(n),count:t,day:n.getDate(),isToday:e===(new Date).toISOString().split("T")[0],questions:s,color:ss(t)}),n.setDate(n.getDate()+1)}return a},[L,l,es,ss]),as=(0,a.useCallback)((e,s)=>{if(fe(e),Se(!0),ke.current){const e=ke.current.getBoundingClientRect(),t=s.currentTarget.getBoundingClientRect();be({x:t.left+t.width/2-e.left,y:t.top-e.top-10})}Se(!0)},[]),ns=(0,a.useCallback)(()=>{setTimeout(()=>{document.querySelector(".calendar-tooltip:hover")||Se(!1)},100)},[]),cs=(0,a.useCallback)(()=>{Se(!1),fe(null)},[]),is=(0,a.useCallback)(e=>{const s=new Date(L);"prev"===e?s.setMonth(s.getMonth()-1):s.setMonth(s.getMonth()+1),D(s)},[L]),rs=(0,a.useCallback)(()=>{const e=ts();return{daysWithQuestions:e.filter(e=>e.count>0).length,totalQuestions:e.reduce((e,s)=>e+s.count,0),maxDaily:Math.max(...e.map(e=>e.count))}},[ts]),ls=(0,a.useCallback)(()=>{const e={};return l.forEach(s=>{const t=s.category?.name||"未分类";e[t]=(e[t]||0)+1}),Object.entries(e).map(([e,s])=>({name:e.length>8?e.substring(0,8)+"...":e,fullName:e,value:s,percentage:(s/l.length*100).toFixed(1)})).sort((e,s)=>s.value-e.value)},[l]),os=(0,a.useCallback)(()=>{const e={};return l.forEach(s=>{const t=s.difficulty||"unknown";e[t]=(e[t]||0)+1}),Object.entries(e).map(([e,s])=>({name:hs(e),value:s,color:ds(e)}))},[l]),ds=(0,a.useCallback)(e=>{switch(e){case"easy":return"#52c41a";case"medium":return"#faad14";case"hard":return"#f5222d";default:return"#666"}},[]),hs=(0,a.useCallback)(e=>{switch(e){case"easy":return"简单";case"medium":return"中等";case"hard":return"困难";default:return"未知"}},[]),us=(0,a.useCallback)(()=>new Set(l.map(e=>new Date(e.createdAt).toDateString())).size,[l]),ms=(0,a.useCallback)(s=>{m.shouldUseOfflineData()?alert("离线模式下无法查看分类详情，请连接网络后重试"):e(`/category/${s}`)},[e]),gs=(0,a.useCallback)(s=>{const t=l.find(e=>e.id===s);t&&t.category&&e(`/category/${t.category.id}`)},[l,e]),xs=(0,a.useCallback)(e=>{alert(`离线模式：查看 ${e.name} 分类的 ${e.questions.length} 道题目\n\n请连接网络后查看完整功能`)},[]),js=(0,a.useCallback)(e=>{if(!e)return"暂无";const s=new Date-new Date(e),t=Math.floor(s/6e4),a=Math.floor(s/36e5),n=Math.floor(s/864e5);return t<60?`${t}分钟前`:a<24?`${a}小时前`:n<30?`${n}天前`:new Date(e).toLocaleDateString()},[]),ps=(0,a.useCallback)(e=>{if(!n.length)return 0;const s=Math.max(...n.map(e=>e.questionCount||0));return s>0?e/s*100:0},[n]),vs=["#ff6b6b","#4ecdc4","#45b7d1","#96ceb4","#feca57","#ff9ff3","#54a0ff","#5f27cd","#00d2d3","#ff9f43"],Ns=(0,a.useMemo)(()=>ls(),[ls]),ys=(0,a.useMemo)(()=>os(),[os]),fs=(0,a.useMemo)(()=>ts(),[ts]),ws=(0,a.useMemo)(()=>us(),[us]),bs=(0,a.useMemo)(()=>rs(),[rs]),Cs=(0,a.useMemo)(()=>L.toLocaleDateString("zh-CN",{year:"numeric",month:"long"}),[L]),Ss=(0,a.useCallback)(()=>{const s={};De.forEach(e=>{const t=e.category?.name||"未分类";s[t]||(s[t]={name:t,questions:[],questionCount:0,id:`offline-${t}`}),s[t].questions.push(e),s[t].questionCount++});const t=Object.values(s);return(0,o.jsx)("section",{className:"categories-section",children:(0,o.jsxs)("div",{className:"container",children:[(0,o.jsxs)("div",{className:"offline-header",children:[(0,o.jsx)("h3",{style:{color:"#666666"},children:"📦 离线模式"}),(0,o.jsx)("p",{style:{color:"#666666"},children:"当前处于离线状态，显示缓存的题目数据"}),(0,o.jsxs)("div",{className:"cache-stats",style:{color:"#666666"},children:["已缓存 ",De.length," 道题目，",t.length," 个分类"]}),(0,o.jsxs)("div",{className:"offline-global-actions",children:[(0,o.jsxs)("button",{onClick:()=>e("/offline/questions"),className:"view-all-offline-btn",style:{color:"#333333"},children:["📚 查看所有离线题目 (",De.length,")"]}),(0,o.jsx)("button",{onClick:()=>window.location.reload(),className:"refresh-network-btn",style:{color:"#333333"},children:"🔄 检查网络连接"})]}),(0,o.jsx)("div",{className:"cache-progress-fill",style:{width:De.length/S.getCacheLimit()*100+"%"}})]}),(0,o.jsx)("div",{className:"categories-grid",children:t.map((e,s)=>{const t=vs[s%vs.length];return(0,o.jsxs)("div",{className:"category-card offline-card",onClick:()=>xs(e),style:{"--accent-color":t},children:[(0,o.jsxs)("div",{className:"card-header",children:[(0,o.jsx)("div",{className:"category-icon",style:{backgroundColor:t},children:e.name.charAt(0)}),(0,o.jsxs)("div",{className:"category-info",children:[(0,o.jsx)("h3",{className:"category-name",children:e.name}),(0,o.jsxs)("span",{className:"question-count",children:[e.questionCount,"题"]})]}),(0,o.jsx)("div",{className:"offline-badge",children:"离线"})]}),(0,o.jsxs)("div",{className:"card-footer",children:[(0,o.jsx)("div",{className:"progress-info",children:(0,o.jsx)("div",{className:"progress-stats",children:(0,o.jsx)("span",{children:"离线缓存数据"})})}),(0,o.jsx)("button",{className:"explore-btn",children:"查看题目 →"})]})]},e.id)})})]})})},[De,xs,e]);return je?p?(0,o.jsx)("div",{className:"homepage",children:(0,o.jsxs)("div",{className:"loading-container",children:[(0,o.jsx)("div",{className:"modern-spinner"}),(0,o.jsx)("p",{children:"加载知识库中..."})]})}):N?(0,o.jsx)("div",{className:"homepage",children:(0,o.jsxs)("div",{className:"error-container",children:[(0,o.jsx)("h2",{children:"加载失败"}),(0,o.jsx)("p",{children:N}),(0,o.jsx)("button",{onClick:()=>window.location.reload(),className:"retry-btn",children:"重试"})]})}):(0,o.jsx)(r.Ht,{client:ve,children:(0,o.jsxs)("div",{className:"homepage",children:[(0,o.jsx)(F,{}),(0,o.jsx)("header",{className:"hero-section",children:(0,o.jsxs)("div",{className:"hero-content",children:[(0,o.jsxs)("div",{className:"user-welcome",children:[(0,o.jsx)("h1",{className:"hero-title",children:"我的知识题库"}),(0,o.jsxs)("p",{className:"hero-subtitle",children:["欢迎回来, ",je.getUsername(),"！",!Ae&&(0,o.jsx)("span",{className:"offline-status",children:" • 离线模式"})]}),(0,o.jsx)("div",{className:"cache-actions"})]}),(0,o.jsxs)("div",{className:"header-actions",children:[(0,o.jsx)("div",{className:"search-container"}),Me&&(0,o.jsx)(Fe,{})]})]})}),(0,o.jsx)("section",{className:"modern-tabs-section",children:(0,o.jsx)("div",{className:"container",children:(0,o.jsxs)("div",{className:"modern-tabs",children:[(0,o.jsxs)("button",{className:"modern-tab "+("categories"===E?"active":""),onClick:()=>q("categories"),children:[(0,o.jsx)("span",{className:"tab-icon",children:"📚"}),(0,o.jsx)("span",{className:"tab-text",children:"分类浏览"}),"categories"===E&&(0,o.jsx)("div",{className:"tab-indicator"})]}),(0,o.jsxs)("button",{className:"modern-tab "+("review"===E?"active":""),onClick:()=>q("review"),children:[(0,o.jsx)("span",{className:"tab-icon",children:"🔄"}),(0,o.jsxs)("span",{className:"tab-text",children:["复习提醒",ue.length>0&&(0,o.jsx)("span",{className:"tab-badge",children:ue.length})]}),"review"===E&&(0,o.jsx)("div",{className:"tab-indicator"})]}),(0,o.jsxs)("button",{className:"modern-tab "+("stats"===E?"active":""),onClick:()=>q("stats"),children:[(0,o.jsx)("span",{className:"tab-icon",children:"📊"}),(0,o.jsx)("span",{className:"tab-text",children:"数据统计"}),"stats"===E&&(0,o.jsx)("div",{className:"tab-indicator"})]}),(0,o.jsxs)("button",{className:"modern-tab "+("calendar"===E?"active":""),onClick:()=>q("calendar"),children:[(0,o.jsx)("span",{className:"tab-icon",children:"🗓️"}),(0,o.jsx)("span",{className:"tab-text",children:"学习日历"}),"calendar"===E&&(0,o.jsx)("div",{className:"tab-indicator"})]}),(0,o.jsxs)("button",{className:"modern-tab "+("documents"===E?"active":""),onClick:()=>q("documents"),children:[(0,o.jsx)("span",{className:"tab-icon",children:"📖"}),(0,o.jsx)("span",{className:"tab-text",children:"开发文档"}),"documents"===E&&(0,o.jsx)("div",{className:"tab-indicator"})]}),(0,o.jsxs)("button",{className:"modern-tab "+("community"===E?"active":""),onClick:()=>q("community"),children:[(0,o.jsx)("span",{className:"tab-icon",children:"👥"}),(0,o.jsx)("span",{className:"tab-text",children:"学习社区"}),"community"===E&&(0,o.jsx)("div",{className:"tab-indicator"})]}),(0,o.jsxs)("button",{className:"modern-tab "+("cache"===E?"active":""),onClick:()=>q("cache"),children:[(0,o.jsx)("span",{className:"tab-icon",children:"💾"}),(0,o.jsxs)("span",{className:"tab-text",children:["缓存管理",qe.hasCache&&(0,o.jsx)("span",{className:"tab-badge",children:qe.count})]}),"cache"===E&&(0,o.jsx)("div",{className:"tab-indicator"})]})]})})}),k&&(0,o.jsx)("div",{className:"sync-message",children:k}),(()=>{if($e)return Ss();switch(E){case"categories":default:return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("section",{className:"filters-section",children:(0,o.jsx)("div",{className:"container",children:(0,o.jsxs)("div",{className:"filters",children:[(0,o.jsxs)("div",{className:"stats",children:["找到 ",Ze.length," 个类别",n.length>0&&` • 总计 ${l.length} 道题目`]}),(0,o.jsxs)("button",{className:"add-category-btn",onClick:()=>$(!0),children:[(0,o.jsx)("span",{className:"btn-icon",children:"+"}),"新建分类"]})]})})}),T&&(0,o.jsx)("div",{className:"modal-overlay",children:(0,o.jsxs)("div",{className:"modal-content",children:[(0,o.jsxs)("div",{className:"modal-header",children:[(0,o.jsx)("h3",{children:"创建新分类"}),(0,o.jsx)("button",{className:"close-btn",onClick:()=>$(!1),children:"×"})]}),(0,o.jsxs)("form",{onSubmit:Je,className:"category-form",children:[(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsx)("label",{htmlFor:"categoryName",children:"分类名称 *"}),(0,o.jsx)("input",{id:"categoryName",type:"text",value:P,onChange:e=>I(e.target.value),placeholder:"请输入分类名称",maxLength:50,autoFocus:!0,style:{color:"black"}})]}),(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsx)("label",{htmlFor:"categoryDescription",children:"分类描述"}),(0,o.jsx)("textarea",{id:"categoryDescription",value:Q,onChange:e=>O(e.target.value),placeholder:"请输入分类描述（可选）",rows:"3",maxLength:200,style:{color:"black"}})]}),(0,o.jsxs)("div",{className:"form-actions",children:[(0,o.jsx)("button",{type:"button",className:"cancel-btn",onClick:()=>$(!1),children:"取消"}),(0,o.jsx)("button",{type:"submit",className:"submit-btn",disabled:U||!P.trim(),children:U?"创建中...":"创建分类"})]})]})]})}),te&&ne&&(0,o.jsx)("div",{className:"modal-overlay",children:(0,o.jsxs)("div",{className:"modal-content delete-confirm-modal",children:[(0,o.jsxs)("div",{className:"modal-header",children:[(0,o.jsx)("h3",{children:"确认删除"}),(0,o.jsx)("button",{className:"close-btn",onClick:Ke,children:"×"})]}),(0,o.jsxs)("div",{className:"delete-content",children:[(0,o.jsx)("div",{className:"delete-icon",children:"🗑️"}),(0,o.jsxs)("div",{className:"delete-message",children:[(0,o.jsxs)("p",{children:["确定要删除分类 ",(0,o.jsxs)("strong",{children:['"',ne.name,'"']})," 吗？"]}),ne.questionCount>0&&(0,o.jsxs)("p",{className:"warning-text",children:["⚠️ 此分类包含 ",ne.questionCount," ","道题目，删除后这些题目将变为未分类状态！"]}),(0,o.jsx)("p",{className:"delete-hint",children:"此操作不可撤销，请谨慎操作。"})]}),(0,o.jsxs)("div",{className:"delete-actions",children:[(0,o.jsx)("button",{className:"cancel-delete-btn",onClick:Ke,disabled:le,children:"取消"}),(0,o.jsx)("button",{className:"confirm-delete-btn",onClick:He,disabled:le,children:le?"删除中...":"确认删除"})]})]})]})}),(0,o.jsx)("section",{className:"categories-section",children:(0,o.jsx)("div",{className:"container",children:0===Ze.length?(0,o.jsxs)("div",{className:"empty-state",children:[(0,o.jsx)("div",{className:"empty-icon",children:"📚"}),(0,o.jsx)("h3",{children:"暂无类别数据"}),(0,o.jsx)("p",{children:"没有找到匹配的类别，尝试调整搜索条件或创建新分类"}),(0,o.jsx)("button",{className:"create-first-category-btn",onClick:()=>$(!0),children:"+ 创建第一个分类"})]}):(0,o.jsx)("div",{className:"categories-grid",children:Ze.map((e,s)=>{const t=vs[s%vs.length],a=l.filter(s=>s.category?.id===e.id).length,n=a>0?a:e.questionCount||0;return(0,o.jsxs)("div",{className:"category-card",onClick:()=>ms(e.id),style:{"--accent-color":t},children:[(0,o.jsxs)("div",{className:"card-header",children:[(0,o.jsx)("div",{className:"category-icon",style:{backgroundColor:t},children:e.name.charAt(0)}),(0,o.jsxs)("div",{className:"category-info",children:[(0,o.jsx)("h3",{className:"category-name",children:e.name}),e.description&&(0,o.jsx)("p",{className:"category-description",children:e.description}),(0,o.jsxs)("span",{className:"question-count",children:[n,"题"]})]}),(0,o.jsx)("button",{className:"delete-category-btn",onClick:s=>Ve(e,s),title:"删除分类",children:"×"})]}),(0,o.jsxs)("div",{className:"card-footer",children:[(0,o.jsxs)("div",{className:"progress-info",children:[(0,o.jsx)("div",{className:"progress-stats",children:(0,o.jsxs)("span",{children:["最近更新: ",js(e.updatedAt)]})}),(0,o.jsx)("div",{className:"progress-bar",children:(0,o.jsx)("div",{className:"progress-fill",style:{width:`${ps(e.questionCount)}%`,backgroundColor:t}})})]}),(0,o.jsx)("button",{className:"explore-btn",children:"查看题目 →"})]})]},e.id)})})})})]});case"review":return(0,o.jsx)(se,{reviewQuestions:ue,setReviewQuestions:me,reviewThreshold:de,setReviewThreshold:he,showReviewSettings:ge,setShowReviewSettings:xe,onQuestionClick:gs,onUpdateQuestionTime:Ge,questions:l});case"stats":return(0,o.jsx)("section",{className:"stats-section",children:(0,o.jsxs)("div",{className:"container",children:[(0,o.jsxs)("div",{className:"stats-overview",children:[(0,o.jsxs)("div",{className:"modern-stat-card primary",children:[(0,o.jsx)("div",{className:"stat-icon",children:"📚"}),(0,o.jsxs)("div",{className:"stat-content",children:[(0,o.jsx)("div",{className:"stat-number",children:Xe.totalCategories}),(0,o.jsx)("div",{className:"stat-label",children:"总分类数"})]})]}),(0,o.jsxs)("div",{className:"modern-stat-card success",children:[(0,o.jsx)("div",{className:"stat-icon",children:"❓"}),(0,o.jsxs)("div",{className:"stat-content",children:[(0,o.jsx)("div",{className:"stat-number",children:l.length}),(0,o.jsx)("div",{className:"stat-label",children:"总题目数"})]})]}),(0,o.jsxs)("div",{className:"modern-stat-card warning",children:[(0,o.jsx)("div",{className:"stat-icon",children:"📅"}),(0,o.jsxs)("div",{className:"stat-content",children:[(0,o.jsx)("div",{className:"stat-number",children:ws}),(0,o.jsx)("div",{className:"stat-label",children:"活跃天数"})]})]}),(0,o.jsxs)("div",{className:"modern-stat-card info",children:[(0,o.jsx)("div",{className:"stat-icon",children:"⚡"}),(0,o.jsxs)("div",{className:"stat-content",children:[(0,o.jsx)("div",{className:"stat-number",children:Xe.totalQuestions>0?(Xe.totalQuestions/ws).toFixed(1):0}),(0,o.jsx)("div",{className:"stat-label",children:"日均题目"})]})]})]}),(0,o.jsxs)("div",{className:"charts-grid",children:[(0,o.jsxs)("div",{className:"modern-chart-card",children:[(0,o.jsxs)("div",{className:"chart-header",children:[(0,o.jsx)("h3",{children:"📊 分类题目分布"}),(0,o.jsx)("span",{className:"chart-subtitle",children:"各分类题目数量占比"})]}),(0,o.jsx)("div",{className:"chart-container",children:(0,o.jsx)(B.u,{width:"100%",height:300,children:(0,o.jsxs)(z.r,{children:[(0,o.jsx)(J.F,{data:Ns,cx:"50%",cy:"50%",labelLine:!1,label:({name:e,percentage:s})=>`${e} ${s}%`,outerRadius:100,fill:"#8884d8",dataKey:"value",children:Ns.map((e,s)=>(0,o.jsx)(V.f,{fill:vs[s%vs.length]},`cell-${s}`))}),(0,o.jsx)(H.m,{formatter:(e,s)=>[`${e} 题`,s]}),(0,o.jsx)(K.s,{})]})})})]}),(0,o.jsxs)("div",{className:"modern-chart-card",children:[(0,o.jsxs)("div",{className:"chart-header",children:[(0,o.jsx)("h3",{children:"🎯 难度分布"}),(0,o.jsx)("span",{className:"chart-subtitle",children:"题目难度等级统计"})]}),(0,o.jsx)("div",{className:"chart-container",children:(0,o.jsx)(B.u,{width:"100%",height:300,children:(0,o.jsxs)(G.E,{data:ys,children:[(0,o.jsx)(Y.d,{strokeDasharray:"3 3"}),(0,o.jsx)(Z.W,{dataKey:"name"}),(0,o.jsx)(X.h,{}),(0,o.jsx)(H.m,{formatter:e=>[`${e} 题`,"数量"]}),(0,o.jsx)(ee.y,{dataKey:"value",name:"题目数量",children:ys.map((e,s)=>(0,o.jsx)(V.f,{fill:e.color},`cell-${s}`))})]})})})]})]})]})});case"calendar":return(0,o.jsx)("section",{className:"modern-calendar-section",children:(0,o.jsxs)("div",{className:"container",children:[(0,o.jsxs)("div",{className:"calendar-header",children:[(0,o.jsx)("h3",{children:"🗓️ 学习日历"}),(0,o.jsx)("p",{children:"查看每月的学习活动分布"})]}),(0,o.jsxs)("div",{className:"modern-calendar-card",ref:ke,children:[(0,o.jsxs)("div",{className:"calendar-controls",children:[(0,o.jsx)("button",{onClick:()=>is("prev"),className:"month-nav-btn",children:"← 上个月"}),(0,o.jsx)("h4",{className:"current-month",children:Cs}),(0,o.jsx)("button",{onClick:()=>is("next"),className:"month-nav-btn",children:"下个月 →"})]}),(0,o.jsxs)("div",{className:"monthly-calendar",children:[(0,o.jsx)("div",{className:"calendar-weekdays",children:["日","一","二","三","四","五","六"].map(e=>(0,o.jsx)("div",{className:"weekday",children:e},e))}),(0,o.jsx)("div",{className:"calendar-days",children:fs.map((e,s)=>(0,o.jsxs)("div",{className:`calendar-day ${e.count>0?"has-questions":""} ${e.isToday?"today":""}`,style:{backgroundColor:e.color},onMouseEnter:s=>as(e,s),onMouseLeave:ns,"data-count":e.count,children:[(0,o.jsx)("span",{className:"day-number",children:e.day}),e.count>0&&(0,o.jsx)("div",{className:"question-count-badge",children:e.count})]},s))}),(0,o.jsx)(ce,{dayData:ye,position:we,isVisible:Ce,onClose:cs})]}),(0,o.jsxs)("div",{className:"calendar-stats",children:[(0,o.jsxs)("div",{className:"calendar-stat",children:[(0,o.jsx)("span",{className:"stat-value",children:bs.totalQuestions}),(0,o.jsx)("span",{className:"stat-label",children:"本月题目"})]}),(0,o.jsxs)("div",{className:"calendar-stat",children:[(0,o.jsx)("span",{className:"stat-value",children:bs.daysWithQuestions}),(0,o.jsx)("span",{className:"stat-label",children:"学习天数"})]}),(0,o.jsxs)("div",{className:"calendar-stat",children:[(0,o.jsx)("span",{className:"stat-value",children:bs.maxDaily}),(0,o.jsx)("span",{className:"stat-label",children:"单日最高"})]})]}),(0,o.jsxs)("div",{className:"calendar-legend",children:[(0,o.jsxs)("div",{className:"legend-item",children:[(0,o.jsx)("div",{className:"legend-color",style:{backgroundColor:"#f8f9fa"}}),(0,o.jsx)("span",{children:"无题目"})]}),(0,o.jsxs)("div",{className:"legend-item",children:[(0,o.jsx)("div",{className:"legend-color",style:{backgroundColor:"#4CAF50"}}),(0,o.jsx)("span",{children:"1题"})]}),(0,o.jsxs)("div",{className:"legend-item",children:[(0,o.jsx)("div",{className:"legend-color",style:{backgroundColor:"#8BC34A"}}),(0,o.jsx)("span",{children:"2-3题"})]}),(0,o.jsxs)("div",{className:"legend-item",children:[(0,o.jsx)("div",{className:"legend-color",style:{backgroundColor:"#FFC107"}}),(0,o.jsx)("span",{children:"4-5题"})]}),(0,o.jsxs)("div",{className:"legend-item",children:[(0,o.jsx)("div",{className:"legend-color",style:{backgroundColor:"#FF9800"}}),(0,o.jsx)("span",{children:"6-8题"})]}),(0,o.jsxs)("div",{className:"legend-item",children:[(0,o.jsx)("div",{className:"legend-color",style:{backgroundColor:"#F44336"}}),(0,o.jsx)("span",{children:"9题以上"})]})]})]})]})});case"documents":return(0,o.jsx)("section",{className:"documents-tab-section",children:(0,o.jsx)("div",{className:"container",children:(0,o.jsx)(ie,{})})});case"community":return(0,o.jsx)(pe,{});case"cache":return(0,o.jsx)(W,{questions:l,onCacheUpdate:Le,currentUser:je})}})(),(0,o.jsx)("footer",{className:"footer-section",children:(0,o.jsx)("div",{className:"container",children:(0,o.jsxs)("div",{className:"footer-stats",children:[(0,o.jsxs)("div",{className:"stat-item",children:[(0,o.jsx)("div",{className:"stat-number",children:Xe.totalCategories}),(0,o.jsx)("div",{className:"stat-label",children:"总类别数"})]}),(0,o.jsxs)("div",{className:"stat-item",children:[(0,o.jsx)("div",{className:"stat-number",children:l.length}),(0,o.jsx)("div",{className:"stat-label",children:"总题目数"})]}),(0,o.jsxs)("div",{className:"stat-item",children:[(0,o.jsx)("div",{className:"stat-number",children:qe.count||0}),(0,o.jsx)("div",{className:"stat-label",children:"缓存题目"})]})]})})}),(0,o.jsx)(d,{onNavigate:s=>{switch(console.log("导航到:",s),s){case"categories":default:q("categories");break;case"review":q("review");break;case"stats":q("stats");break;case"calendar":q("calendar");break;case"community":q("community");break;case"documents":q("documents");break;case"createCategory":$(!0);break;case"cacheQuestions":Be();break;case"offlineMode":e("/offline/questions")}window.scrollTo({top:0,behavior:"smooth"})},categories:n,questions:l,currentUser:je,cacheStatus:qe,isOnline:Ae})]})}):(0,o.jsx)("div",{className:"homepage",children:(0,o.jsxs)("div",{className:"auth-required-container",children:[(0,o.jsx)("div",{className:"auth-required-icon",children:"🔐"}),(0,o.jsx)("h2",{children:"请先登录"}),(0,o.jsx)("p",{children:"登录后即可查看和管理您的刷题数据"}),(0,o.jsxs)("div",{className:"auth-required-actions",children:[(0,o.jsx)("button",{onClick:()=>{window.dispatchEvent(new CustomEvent("showAuthModal",{detail:{tab:"login"}}))},className:"login-btn primary",children:"🚀 立即登录"}),(0,o.jsx)("button",{onClick:()=>{window.dispatchEvent(new CustomEvent("showAuthModal",{detail:{tab:"register"}}))},className:"login-btn secondary",children:"📝 注册账号"})]}),(0,o.jsx)("div",{className:"auth-features",children:(0,o.jsxs)("div",{className:"feature-list",children:[(0,o.jsxs)("div",{className:"feature-item",children:[(0,o.jsx)("span",{className:"feature-icon",children:"📚"}),(0,o.jsx)("span",{children:"管理您的刷题分类"})]}),(0,o.jsxs)("div",{className:"feature-item",children:[(0,o.jsx)("span",{className:"feature-icon",children:"📊"}),(0,o.jsx)("span",{children:"查看学习统计"})]}),(0,o.jsxs)("div",{className:"feature-item",children:[(0,o.jsx)("span",{className:"feature-icon",children:"🔄"}),(0,o.jsx)("span",{children:"使用复习提醒功能"})]}),(0,o.jsxs)("div",{className:"feature-item",children:[(0,o.jsx)("span",{className:"feature-icon",children:"🗓️"}),(0,o.jsx)("span",{children:"记录学习日历"})]}),(0,o.jsxs)("div",{className:"feature-item",children:[(0,o.jsx)("span",{className:"feature-icon",children:"📦"}),(0,o.jsx)("span",{children:"离线缓存题目"})]})]})})]})})};u().init({appId:"JjTQ2R5rn16RRhUdrcjUSBxW-gzGzoHsz",appKey:"UkvR0e4OPaeW5rYMQwNTvD7Z",serverURL:"https://jjtq2r5r.lc-cn-n1-shared.com"});const ye="Post",fe="Comment",we="Like",be="Follow",Ce="published",Se=["Title","题目","Name","名称"],ke=["Difficulty","难度"],Ae=["Category","类别","分类"],Ee=["Tags","标签"],qe=["Content","内容","Answer","答案"],Le=["CompletionTime","完成时间","时间"],De=async()=>{try{return{Post:await Te(),Comment:await $e(),Like:await Pe(),Follow:await Ie()}}catch(e){throw new Error(`创建社区数据表失败: ${e.message}`)}},Te=async()=>{try{const e=new(u().Query)(ye);if(await e.first().catch(()=>null))return{exists:!0,message:"Post class already exists"};const s=new(u().Object.extend(ye));s.set("title","测试帖子标题"),s.set("content","这是一个测试帖子的内容，用于验证 Post 类的创建。"),s.set("author",u().User.current()),s.set("tags",["测试","示例"]),s.set("likes",0),s.set("views",0),s.set("commentCount",0),s.set("isPublic",!0),s.set("isPinned",!1),s.set("status",Ce);const t=new(u().ACL);return t.setPublicReadAccess(!0),t.setPublicWriteAccess(!1),u().User.current()&&t.setWriteAccess(u().User.current(),!0),s.setACL(t),await s.save(),console.log("✅ Post 类创建成功并添加测试数据"),await s.destroy(),console.log("🧹 已清理测试数据"),{success:!0,message:"Post class created successfully"}}catch(e){return console.error("创建 Post 类失败:",e),{success:!1,error:e.message}}},$e=async()=>{try{const e=new(u().Query)(fe);if(await e.first().catch(()=>null))return console.log("📝 Comment 类已存在，跳过创建"),{exists:!0,message:"Comment class already exists"};const s=new(u().Object.extend(fe));s.set("content","这是一个测试评论内容。"),s.set("author",u().User.current()),s.set("likes",0);const t=new(u().ACL);return t.setPublicReadAccess(!0),t.setPublicWriteAccess(!1),u().User.current()&&t.setWriteAccess(u().User.current(),!0),s.setACL(t),await s.save(),console.log("✅ Comment 类创建成功并添加测试数据"),await s.destroy(),console.log("🧹 已清理测试数据"),{success:!0,message:"Comment class created successfully"}}catch(e){return console.error("创建 Comment 类失败:",e),{success:!1,error:e.message}}},Pe=async()=>{try{const e=new(u().Query)(we);if(await e.first().catch(()=>null))return console.log("📝 Like 类已存在，跳过创建"),{exists:!0,message:"Like class already exists"};const s=new(u().Object.extend(we));s.set("user",u().User.current());const t=new(u().ACL);return t.setPublicReadAccess(!0),t.setPublicWriteAccess(!1),u().User.current()&&t.setWriteAccess(u().User.current(),!0),s.setACL(t),await s.save(),console.log("✅ Like 类创建成功并添加测试数据"),await s.destroy(),console.log("🧹 已清理测试数据"),{success:!0,message:"Like class created successfully"}}catch(e){return console.error("创建 Like 类失败:",e),{success:!1,error:e.message}}},Ie=async()=>{try{const e=new(u().Query)(be);if(await e.first().catch(()=>null))return console.log("📝 Follow 类已存在，跳过创建"),{exists:!0,message:"Follow class already exists"};const s=new(u().Object.extend(be));s.set("follower",u().User.current());const t=new(u().ACL);return t.setPublicReadAccess(!0),t.setPublicWriteAccess(!1),u().User.current()&&t.setWriteAccess(u().User.current(),!0),s.setACL(t),await s.save(),console.log("✅ Follow 类创建成功并添加测试数据"),await s.destroy(),console.log("🧹 已清理测试数据"),{success:!0,message:"Follow class created successfully"}}catch(e){return console.error("创建 Follow 类失败:",e),{success:!1,error:e.message}}},Qe=async()=>{try{console.log("🚀 开始生成社区示例数据..."),await De();const e={posts:await Oe(),comments:await Ue(),likes:await Re()};return console.log("✅ 社区示例数据生成完成:",e),{success:!0,...e,message:`成功生成 ${e.posts.length} 个帖子, ${e.comments.length} 条评论, ${e.likes.length} 个点赞`}}catch(e){throw console.error("❌ 生成社区示例数据失败:",e),new Error(`生成社区示例数据失败: ${e.message}`)}},Oe=async()=>{const e=u().User.current();if(!e)return console.log("⚠️ 用户未登录，跳过创建示例帖子"),[];const s=u().Object.extend(ye),t=[{title:"欢迎来到学习社区！",content:"大家好！欢迎来到我们的学习社区。这里是一个分享编程学习心得、交流刷题经验的地方。\n\n## 社区规则：\n1. 友善交流，互相帮助\n2. 分享有价值的内容\n3. 尊重他人观点\n4. 保持内容相关性\n\n希望大家都能在这里有所收获！🎉",tags:["欢迎","公告","社区"],isPublic:!0,isPinned:!0},{title:"JavaScript 闭包的理解与实践",content:"今天来分享一下我对 JavaScript 闭包的理解...\n\n## 什么是闭包？\n闭包是指那些能够访问自由变量的函数。\n\n## 实际应用场景：\n1. 模块化开发\n2. 私有变量\n3. 函数柯里化\n\n大家有什么补充的吗？",tags:["JavaScript","闭包","前端"],isPublic:!0,isPinned:!1},{title:"React Hooks 使用心得",content:"使用 React Hooks 有一段时间了，分享一些实践经验：\n\n- useState: 状态管理\n- useEffect: 副作用处理\n- useContext: 上下文传递\n- useMemo: 性能优化\n\n你们觉得哪个 Hook 最实用？",tags:["React","Hooks","前端"],isPublic:!0,isPinned:!1}],a=[];for(const n of t){const t=new s;t.set("title",n.title),t.set("content",n.content),t.set("author",e),t.set("tags",n.tags),t.set("likes",Math.floor(10*Math.random())),t.set("views",Math.floor(50*Math.random())),t.set("commentCount",Math.floor(5*Math.random())),t.set("isPublic",n.isPublic),t.set("isPinned",n.isPinned),t.set("status",Ce);const c=new(u().ACL);c.setPublicReadAccess(!0),c.setPublicWriteAccess(!1),c.setWriteAccess(e,!0),t.setACL(c);const i=await t.save();a.push(i),console.log(`✅ 创建帖子: "${n.title}"`)}return a},Ue=async()=>{const e=u().User.current();if(!e)return console.log("⚠️ 用户未登录，跳过创建示例评论"),[];const s=new(u().Query)(ye),t=await s.find();if(0===t.length)return console.log("⚠️ 没有找到帖子，跳过创建评论"),[];const a=u().Object.extend(fe),n=[{content:"欢迎欢迎！期待更多精彩内容！🎊"},{content:"闭包的讲解很清晰，感谢分享！"},{content:"我觉得 useEffect 最实用，能处理各种副作用。"},{content:"新人报道，请多指教！"},{content:"Hooks 确实让 React 开发更简洁了。"}],c=[];for(let s=0;s<n.length;s++){const i=new a;i.set("content",n[s].content),i.set("author",e),i.set("post",t[s%t.length]),i.set("likes",Math.floor(5*Math.random()));const r=new(u().ACL);r.setPublicReadAccess(!0),r.setPublicWriteAccess(!1),r.setWriteAccess(e,!0),i.setACL(r);const l=await i.save();c.push(l),console.log(`✅ 创建评论: "${n[s].content.substring(0,20)}..."`)}return c},Re=async()=>{const e=u().User.current();if(!e)return console.log("⚠️ 用户未登录，跳过创建示例点赞"),[];const s=new(u().Query)(ye),t=await s.find(),a=new(u().Query)(fe),n=await a.find(),c=u().Object.extend(we),i=[];if(t.length>0){const s=new c;s.set("user",e),s.set("post",t[0]);const a=new(u().ACL);a.setPublicReadAccess(!0),a.setWriteAccess(e,!0),s.setACL(a);const n=await s.save();i.push(n),console.log("✅ 创建帖子点赞")}if(n.length>0){const s=new c;s.set("user",e),s.set("comment",n[0]);const t=new(u().ACL);t.setPublicReadAccess(!0),t.setWriteAccess(e,!0),s.setACL(t);const a=await s.save();i.push(a),console.log("✅ 创建评论点赞")}return i},Me=async()=>{try{let e={posts:0,comments:0,likes:0,follows:0};try{const s=new(u().Query)(we),t=await s.find();t.length>0&&(await u().Object.destroyAll(t),e.likes=t.length)}catch(e){}try{const s=new(u().Query)(fe),t=await s.find();t.length>0&&(await u().Object.destroyAll(t),e.comments=t.length)}catch(e){}try{const s=new(u().Query)(ye),t=await s.find();t.length>0&&(await u().Object.destroyAll(t),e.posts=t.length)}catch(e){}try{const s=new(u().Query)(be),t=await s.find();t.length>0&&(await u().Object.destroyAll(t),e.follows=t.length)}catch(e){}const s=`社区数据清除完成: ${e.posts} 帖子, ${e.comments} 评论, ${e.likes} 点赞, ${e.follows} 关注`;return{success:!0,...e,message:s}}catch(e){throw console.error("❌ 清除社区数据失败:",e),new Error(`清除社区数据失败: ${e.message}`)}},_e=async()=>{try{if(!"MISSING_ENV_VAR".REACT_APP_NOTION_TOKEN||!"MISSING_ENV_VAR".REACT_APP_NOTION_DATABASE_ID)throw new Error("Notion 环境变量未配置，请检查 REACT_APP_NOTION_TOKEN 和 REACT_APP_NOTION_DATABASE_ID");try{return await u().Cloud.run("syncProblemsFromNotion")}catch(e){return await Fe()}}catch(e){throw console.error("❌ Notion 同步失败:",e),new Error(`同步失败: ${e.message}`)}},Fe=async()=>{try{return console.log("📝 使用客户端同步模式（需要配置云函数）"),await new Promise(e=>setTimeout(e,2e3)),{success:!0,message:"同步功能需要部署云函数。请参考以下步骤：\n1. 在 LeanCloud 云引擎部署 syncProblemsFromNotion 云函数\n2. 配置 NOTION_INTEGRATION_TOKEN 和 NOTION_DATABASE_ID 环境变量",data:{synced:0,mode:"client_fallback"}}}catch(e){throw new Error(`客户端同步失败: ${e.message}`)}},We=e=>{try{const s=e.properties,t=Be(s,Se,"title");if(!t)return console.warn("跳过无标题的记录:",e.id),null;const a=Be(s,ke,"select"),n=Be(s,Ae,"select"),c=Be(s,Ee,"multi_select")||[],i=Be(s,qe,"rich_text"),r=Be(s,Le,"number");return{title:t,difficulty:a||"medium",category:n||"未分类",tags:Array.isArray(c)?c:[c],content:i||"",completionTime:r||15,notionPageId:e.id,notionUrl:e.url,lastEditedTime:new Date(e.last_edited_time),isActive:!0}}catch(e){return console.error("解析 Notion 页面失败:",e),null}},Be=(e,s,t)=>{for(const a of s){const s=e[a];if(s&&s.type===t)switch(t){case"title":return s.title[0]?.text?.content;case"rich_text":return s.rich_text[0]?.text?.content;case"select":return s.select?.name;case"multi_select":return s.multi_select?.map(e=>e.name);case"number":return s.number;default:return null}}return null},ze=async e=>{const s=u().Object.extend("Question");let t=0;for(const a of e)try{const e=await Je(a.category),n=new(u().Query)("Question");n.equalTo("notionPageId",a.notionPageId);const c=await n.first()||new s;c.set("title",a.title),c.set("content",a.content),c.set("difficulty",a.difficulty),c.set("tags",a.tags),c.set("completionTime",a.completionTime),c.set("category",e),c.set("notionPageId",a.notionPageId),c.set("notionUrl",a.notionUrl),c.set("isActive",!0);const i=new(u().ACL);i.setPublicReadAccess(!0),i.setPublicWriteAccess(!0),c.setACL(i),await c.save(),t++,console.log(`✅ 保存题目: "${a.title}" → 分类 "${a.category}"`)}catch(e){console.error(`保存题目失败: ${a.title}`,e)}return await Ze(),t},Je=async e=>{const s=u().Object.extend("Category"),t=new(u().Query)("Category");t.equalTo("name",e);let a=await t.first();if(!a){a=new s,a.set("name",e),a.set("questionCount",0);const t=new(u().ACL);t.setPublicReadAccess(!0),t.setPublicWriteAccess(!0),a.setACL(t),await a.save()}return a},Ve=async()=>{try{return await u().Cloud.run("checkNotionConnection")}catch(e){return{success:!1,connected:!1,error:e.message,message:"请确保已部署云函数并配置环境变量"}}},He=async()=>{try{console.log("开始生成示例数据..."),await Xe();const e=await Ke(),s=await Ge(e);return await Ye(e),console.log("🎉 示例数据生成完成！"),{success:!0,categoriesCount:e.length,questionsCount:s.length,message:`成功生成 ${e.length} 个分类和 ${s.length} 个题目`}}catch(e){throw console.error("❌ 生成示例数据失败:",e),new Error(`生成失败: ${e.message}`)}},Ke=async()=>{const e=u().Object.extend("Category"),s=[{name:"JavaScript 核心概念"},{name:"React 框架原理"},{name:"算法与数据结构"},{name:"计算机网络"},{name:"数据库系统"},{name:"操作系统"},{name:"前端工程化"},{name:"TypeScript 进阶"}],t=[];for(const a of s){const s=new e;s.set("name",a.name),s.set("questionCount",0);const n=new(u().ACL);n.setPublicReadAccess(!0),n.setPublicWriteAccess(!0),s.setACL(n);const c=await s.save();t.push(c),console.log(`✅ 创建分类: ${a.name}`)}return t},Ge=async e=>{const s=u().Object.extend("Question"),t=[],a=[];for(const n of t){const t=new s;t.set("title",n.title),t.set("answer",n.answer),t.set("tags",n.tags),t.set("difficulty",n.difficulty),t.set("completionTime",n.completionTime),t.set("proficiency",n.proficiency),t.set("category",e[n.categoryIndex]),t.set("isActive",!0);const c=new(u().ACL);c.setPublicReadAccess(!0),c.setPublicWriteAccess(!0),t.setACL(c);const i=await t.save();a.push(i),console.log(`✅ 创建题目: "${n.title}" → 属于 "${e[n.categoryIndex].get("name")}"`)}return a},Ye=async e=>{for(const s of e){const e=new(u().Query)("Question");e.equalTo("category",s);const t=await e.count();s.set("questionCount",t),await s.save(),console.log(`📊 分类 "${s.get("name")}" 有 ${t} 个题目`)}},Ze=async()=>{const e=new(u().Query)("Category"),s=await e.find();for(const e of s){const s=new(u().Query)("Question");s.equalTo("category",e);const t=await s.count();e.set("questionCount",t),await e.save()}console.log(`📊 更新了 ${s.length} 个分类的题目计数`)},Xe=async()=>{try{console.log("开始清除所有数据...");let e=0,s=0;try{const s=new(u().Query)("Question"),t=await s.find();t.length>0&&(await u().Object.destroyAll(t),e=t.length,console.log(`🗑️ 删除了 ${e} 个题目`))}catch(e){console.log("没有题目需要删除或删除失败:",e.message)}try{const e=new(u().Query)("Category"),t=await e.find();t.length>0&&(await u().Object.destroyAll(t),s=t.length,console.log(`🗑️ 删除了 ${s} 个分类`))}catch(e){console.log("没有分类需要删除或删除失败:",e.message)}const t=`清除完成: ${s} 个分类, ${e} 个题目`;return console.log("✅ "+t),{success:!0,deletedCategories:s,deletedQuestions:e,message:t}}catch(e){throw console.error("❌ 清除数据失败:",e),new Error(`清除失败: ${e.message}`)}},es=async()=>{try{let e=0,s=0;try{const s=new(u().Query)("Category");e=await s.count()}catch(s){e=0}try{const e=new(u().Query)("Question");s=await e.count()}catch(e){s=0}const t={categoryCount:e,questionCount:s,hasData:e>0||s>0};return console.log("📊 数据状态:",t),t}catch(e){throw console.error("检查数据状态失败:",e),e}};"undefined"!=typeof window&&(window.generateSampleData=He,window.clearAllData=Xe,window.checkDataStatus=es,window.syncProblemsFromNotion=_e,window.checkNotionConnection=Ve,window.defineNotionCloudFunctions=()=>{void 0!==u().Cloud&&(u().Cloud.define("syncProblemsFromNotion",async e=>{const{Client:s}=t(1007),a=new s({auth:"MISSING_ENV_VAR".NOTION_INTEGRATION_TOKEN});try{console.log("开始从 Notion 数据库同步数据...");const e=await a.databases.query({database_id:"MISSING_ENV_VAR".NOTION_DATABASE_ID,sorts:[{timestamp:"last_edited_time",direction:"descending"}]});console.log(`从 Notion 获取到 ${e.results.length} 条记录`);const s=[];let t=0;for(const t of e.results){const e=We(t);e&&s.push(e)}return t=await ze(s),{success:!0,message:`同步完成！处理 ${e.results.length} 条记录，成功保存 ${t} 道题目`,data:{fetched:e.results.length,saved:t,problems:s.slice(0,5)}}}catch(e){throw console.error("Notion 同步错误:",e),new(u().Cloud.Error)(`同步失败: ${e.message}`)}}),u().Cloud.define("checkNotionConnection",async e=>{const{Client:s}=t(1007);try{const e=new s({auth:"MISSING_ENV_VAR".NOTION_INTEGRATION_TOKEN}),t=await e.databases.retrieve({database_id:"MISSING_ENV_VAR".NOTION_DATABASE_ID});return{success:!0,connected:!0,database:{title:t.title[0]?.plain_text||"未命名",properties:Object.keys(t.properties),url:t.url}}}catch(e){return{success:!1,connected:!1,error:e.message}}}))},window.createCommunityClasses=De,window.generateCommunitySampleData=Qe,window.clearCommunityData=Me,console.log("\n🎯 数据库管理工具已加载！\n\n📚 数据管理:\n1. generateSampleData()          - 生成示例数据\n2. clearAllData()                - 清除所有数据\n3. checkDataStatus()             - 检查数据状态\n\n🔄 Notion 同步:\n4. syncProblemsFromNotion()      - 从 Notion 导入题目\n5. checkNotionConnection()       - 检查 Notion 连接状态\n6. defineNotionCloudFunctions()  - 定义云函数（用于云引擎）\n\n👥 社区功能:\n7. createCommunityClasses()      - 创建社区数据表\n8. generateCommunitySampleData() - 生成社区示例数据\n9. clearCommunityData()          - 清除社区数据\n\n💡 使用提示:\n- 首次使用请运行 generateSampleData() 创建示例数据\n- 使用社区功能前运行 createCommunityClasses() 创建数据表\n- 配置 Notion 环境变量后使用 syncProblemsFromNotion() 同步\n- 云函数需要在 LeanCloud 云引擎部署\n  "));const ss=()=>{const[e,s]=(0,a.useState)(!1),[t,n]=(0,a.useState)(""),[c,i]=(0,a.useState)(null),[r,l]=(0,a.useState)(null),[d,h]=(0,a.useState)(null),[u,m]=(0,a.useState)(null),[g,x]=(0,a.useState)("notion"),j=async()=>{s(!0);try{const e=await es();i(e),n(`📊 当前数据: ${e.categoryCount} 个分类, ${e.questionCount} 个题目`)}catch(e){n(`❌ 检查失败: ${e.message}`)}finally{s(!1)}},p=async()=>{s(!0);try{const e={postCount:0,commentCount:0,likeCount:0,followCount:0,hasData:!1};try{e.postCount=0,e.commentCount=0,e.likeCount=0,e.followCount=0,e.hasData=!1,n("📊 社区数据状态已检查，请先创建社区数据表")}catch(e){n('📊 社区数据表尚未创建，请先点击"创建社区数据表"')}m(e)}catch(e){n(`❌ 检查社区状态失败: ${e.message}`)}finally{s(!1)}};return(0,o.jsxs)("div",{className:"init-page",children:[(0,o.jsxs)("header",{className:"page-header",children:[(0,o.jsx)("h1",{children:"🎯 数据库管理工具"}),(0,o.jsx)("p",{children:"管理 Category、Question 和社区数据，支持 Notion 同步"})]}),(0,o.jsx)("section",{className:"tab-navigation",children:(0,o.jsxs)("div",{className:"tabs",children:[(0,o.jsx)("button",{className:"tab "+("notion"===g?"active":""),onClick:()=>x("notion"),children:"🔄 Notion 同步"}),(0,o.jsx)("button",{className:"tab "+("data"===g?"active":""),onClick:()=>x("data"),children:"📊 题目数据管理"}),(0,o.jsx)("button",{className:"tab "+("community"===g?"active":""),onClick:()=>x("community"),children:"👥 社区数据管理"})]})}),"notion"===g&&(0,o.jsxs)("section",{className:"notion-section",children:[(0,o.jsx)("h2",{children:"🔄 Notion 数据同步"}),(0,o.jsxs)("div",{className:"action-buttons",children:[(0,o.jsx)("button",{onClick:async()=>{s(!0),n(""),l(null);try{const e=await Ve();l(e),e.success&&e.connected?n(`✅ Notion 连接正常！数据库: ${e.database.title}`):n(`⚠️ Notion 连接异常: ${e.error||"请检查配置"}`)}catch(e){n(`❌ 检查 Notion 连接失败: ${e.message}`)}finally{s(!1)}},disabled:e,className:"btn btn-notion",children:"🔗 检查 Notion 连接"}),(0,o.jsx)("button",{onClick:async()=>{if(window.confirm("确定要从 Notion 导入数据吗？这会添加新题目到现有数据中。")){s(!0),n(""),h(null);try{const e=await _e();h(e),e.success?(n(`✅ ${e.message}`),await j()):n(`⚠️ ${e.message}`)}catch(e){n(`❌ 同步失败: ${e.message}`)}finally{s(!1)}}},disabled:e,className:"btn btn-sync",children:"📥 从 Notion 导入"})]}),r&&(0,o.jsxs)("div",{className:"notion-status",children:[(0,o.jsx)("h4",{children:"Notion 连接状态"}),(0,o.jsxs)("div",{className:"status-card "+(r.connected?"connected":"disconnected"),children:[(0,o.jsxs)("div",{className:"status-header",children:[(0,o.jsx)("span",{className:"status-indicator",children:r.connected?"🟢":"🔴"}),(0,o.jsx)("strong",{children:r.connected?"连接正常":"连接异常"})]}),r.connected&&r.database&&(0,o.jsxs)("div",{className:"database-info",children:[(0,o.jsxs)("p",{children:[(0,o.jsx)("strong",{children:"数据库:"})," ",r.database.title]}),(0,o.jsxs)("p",{children:[(0,o.jsx)("strong",{children:"属性字段:"})," ",r.database.properties.length," 个"]}),(0,o.jsxs)("p",{children:[(0,o.jsx)("strong",{children:"URL:"}),(0,o.jsx)("a",{href:r.database.url,target:"_blank",rel:"noopener noreferrer",children:"查看数据库"})]})]}),!r.connected&&(0,o.jsxs)("div",{className:"error-info",children:[(0,o.jsxs)("p",{children:[(0,o.jsx)("strong",{children:"错误信息:"})," ",r.error]}),(0,o.jsx)("p",{className:"help-text",children:"💡 请确保已部署云函数并配置环境变量"})]})]})]}),d&&(0,o.jsxs)("div",{className:"sync-result",children:[(0,o.jsx)("h4",{children:"同步结果"}),(0,o.jsxs)("div",{className:"result-card",children:[(0,o.jsxs)("div",{className:"result-stats",children:[(0,o.jsxs)("div",{className:"stat",children:[(0,o.jsx)("span",{className:"stat-label",children:"获取记录:"}),(0,o.jsx)("span",{className:"stat-value",children:d.data?.fetched||0})]}),(0,o.jsxs)("div",{className:"stat",children:[(0,o.jsx)("span",{className:"stat-label",children:"成功保存:"}),(0,o.jsx)("span",{className:"stat-value",children:d.data?.saved||0})]}),(0,o.jsxs)("div",{className:"stat",children:[(0,o.jsx)("span",{className:"stat-label",children:"同步模式:"}),(0,o.jsx)("span",{className:"stat-value",children:d.data?.mode||"cloud"})]})]}),d.data?.problems&&d.data.problems.length>0&&(0,o.jsxs)("div",{className:"synced-problems",children:[(0,o.jsx)("h5",{children:"最近同步的题目:"}),(0,o.jsx)("ul",{children:d.data.problems.slice(0,3).map((e,s)=>(0,o.jsxs)("li",{children:[(0,o.jsx)("span",{className:"problem-title",children:e.title}),(0,o.jsx)("span",{className:"problem-category",children:e.category})]},s))})]})]})]})]}),"data"===g&&(0,o.jsxs)("section",{className:"data-management-section",children:[(0,o.jsx)("h2",{children:"📊 题目数据管理"}),(0,o.jsxs)("div",{className:"action-buttons",children:[(0,o.jsx)("button",{onClick:j,disabled:e,className:"btn btn-info",children:"🔍 检查状态"}),(0,o.jsx)("button",{onClick:async()=>{s(!0),n("");try{const e=await He();n(`✅ ${e.message}`),await j()}catch(e){n(`❌ ${e.message}`)}finally{s(!1)}},disabled:e,className:"btn btn-success",children:"🚀 生成示例数据"}),(0,o.jsx)("button",{onClick:async()=>{if(window.confirm("确定要清除所有数据吗？此操作不可撤销！")){s(!0),n("");try{const e=await Xe();n(`✅ ${e.message}`),await j()}catch(e){n(`❌ ${e.message}`)}finally{s(!1)}}},disabled:e,className:"btn btn-danger",children:"🗑️ 清除所有数据"})]}),c&&(0,o.jsxs)("div",{className:"status-info",children:[(0,o.jsx)("h4",{children:"📈 数据状态"}),(0,o.jsxs)("div",{className:"status-grid",children:[(0,o.jsxs)("div",{className:"status-item",children:[(0,o.jsx)("span",{className:"label",children:"分类数量:"}),(0,o.jsx)("span",{className:"value",children:c.categoryCount})]}),(0,o.jsxs)("div",{className:"status-item",children:[(0,o.jsx)("span",{className:"label",children:"题目数量:"}),(0,o.jsx)("span",{className:"value",children:c.questionCount})]}),(0,o.jsxs)("div",{className:"status-item",children:[(0,o.jsx)("span",{className:"label",children:"数据状态:"}),(0,o.jsx)("span",{className:"value "+(c.hasData?"has-data":"no-data"),children:c.hasData?"有数据":"无数据"})]})]})]})]}),"community"===g&&(0,o.jsxs)("section",{className:"community-management-section",children:[(0,o.jsx)("h2",{children:"👥 社区数据管理"}),(0,o.jsx)("p",{className:"section-description",children:"管理学习社区的帖子、评论、点赞等社交功能数据"}),(0,o.jsxs)("div",{className:"action-buttons",children:[(0,o.jsx)("button",{onClick:p,disabled:e,className:"btn btn-info",children:"🔍 检查社区状态"}),(0,o.jsx)("button",{onClick:async()=>{s(!0),n("");try{const e=await De();if(e.Post.success&&e.Comment.success&&e.Like.success&&e.Follow.success)n("✅ 社区数据表创建成功！所有表都已就绪");else{const s=[];e.Post.success||s.push("Post"),e.Comment.success||s.push("Comment"),e.Like.success||s.push("Like"),e.Follow.success||s.push("Follow"),s.length>0?n(`⚠️ 部分表创建失败: ${s.join(", ")}。可能表已存在或权限不足`):n("✅ 社区数据表创建完成")}await p()}catch(e){n(`❌ 创建社区数据表失败: ${e.message}`)}finally{s(!1)}},disabled:e,className:"btn btn-primary",children:"🏗️ 创建社区数据表"}),(0,o.jsx)("button",{onClick:async()=>{s(!0),n("");try{const e=await Qe();n(`✅ ${e.message}`),await p()}catch(e){n(`❌ 生成社区示例数据失败: ${e.message}`)}finally{s(!1)}},disabled:e,className:"btn btn-success",children:"🚀 生成社区示例数据"}),(0,o.jsx)("button",{onClick:async()=>{if(window.confirm("确定要清除所有社区数据吗？此操作不可撤销！")){s(!0),n("");try{const e=await Me();n(`✅ ${e.message}`),await p()}catch(e){n(`❌ 清除社区数据失败: ${e.message}`)}finally{s(!1)}}},disabled:e,className:"btn btn-danger",children:"🗑️ 清除社区数据"})]}),u&&(0,o.jsxs)("div",{className:"status-info",children:[(0,o.jsx)("h4",{children:"📈 社区数据状态"}),(0,o.jsxs)("div",{className:"status-grid",children:[(0,o.jsxs)("div",{className:"status-item",children:[(0,o.jsx)("span",{className:"label",children:"帖子数量:"}),(0,o.jsx)("span",{className:"value",children:u.postCount})]}),(0,o.jsxs)("div",{className:"status-item",children:[(0,o.jsx)("span",{className:"label",children:"评论数量:"}),(0,o.jsx)("span",{className:"value",children:u.commentCount})]}),(0,o.jsxs)("div",{className:"status-item",children:[(0,o.jsx)("span",{className:"label",children:"点赞数量:"}),(0,o.jsx)("span",{className:"value",children:u.likeCount})]}),(0,o.jsxs)("div",{className:"status-item",children:[(0,o.jsx)("span",{className:"label",children:"关注数量:"}),(0,o.jsx)("span",{className:"value",children:u.followCount})]}),(0,o.jsxs)("div",{className:"status-item",children:[(0,o.jsx)("span",{className:"label",children:"数据状态:"}),(0,o.jsx)("span",{className:"value "+(u.hasData?"has-data":"no-data"),children:u.hasData?"有数据":"无数据"})]})]})]}),(0,o.jsxs)("div",{className:"community-classes-info",children:[(0,o.jsx)("h4",{children:"🏗️ 社区数据表结构"}),(0,o.jsxs)("div",{className:"classes-grid",children:[(0,o.jsxs)("div",{className:"class-card",children:[(0,o.jsx)("h5",{children:"📝 Post (帖子)"}),(0,o.jsxs)("ul",{children:[(0,o.jsx)("li",{children:"title - 帖子标题"}),(0,o.jsx)("li",{children:"content - 帖子内容"}),(0,o.jsx)("li",{children:"author - 作者"}),(0,o.jsx)("li",{children:"tags - 标签数组"}),(0,o.jsx)("li",{children:"likes - 点赞数"}),(0,o.jsx)("li",{children:"views - 浏览数"}),(0,o.jsx)("li",{children:"commentCount - 评论数"}),(0,o.jsx)("li",{children:"isPublic - 是否公开"}),(0,o.jsx)("li",{children:"status - 帖子状态"})]})]}),(0,o.jsxs)("div",{className:"class-card",children:[(0,o.jsx)("h5",{children:"💬 Comment (评论)"}),(0,o.jsxs)("ul",{children:[(0,o.jsx)("li",{children:"content - 评论内容"}),(0,o.jsx)("li",{children:"author - 评论作者"}),(0,o.jsx)("li",{children:"post - 所属帖子"}),(0,o.jsx)("li",{children:"parent - 父评论"}),(0,o.jsx)("li",{children:"likes - 点赞数"})]})]}),(0,o.jsxs)("div",{className:"class-card",children:[(0,o.jsx)("h5",{children:"👍 Like (点赞)"}),(0,o.jsxs)("ul",{children:[(0,o.jsx)("li",{children:"user - 点赞用户"}),(0,o.jsx)("li",{children:"post - 被点赞帖子"}),(0,o.jsx)("li",{children:"comment - 被点赞评论"})]})]}),(0,o.jsxs)("div",{className:"class-card",children:[(0,o.jsx)("h5",{children:"👥 Follow (关注)"}),(0,o.jsxs)("ul",{children:[(0,o.jsx)("li",{children:"follower - 关注者"}),(0,o.jsx)("li",{children:"following - 被关注者"})]})]})]})]})]}),e&&(0,o.jsxs)("div",{className:"loading-state",children:[(0,o.jsx)("div",{className:"spinner"}),(0,o.jsx)("span",{children:"执行中..."})]}),t&&(0,o.jsx)("div",{className:"message "+(t.includes("❌")?"error":t.includes("⚠️")?"warning":"success"),children:t}),(0,o.jsxs)("div",{className:"instructions",children:[(0,o.jsx)("h3",{children:"📖 使用说明"}),"notion"===g&&(0,o.jsxs)("div",{className:"instruction-item",children:[(0,o.jsx)("h4",{children:"🔄 Notion 同步"}),(0,o.jsxs)("ul",{children:[(0,o.jsxs)("li",{children:[(0,o.jsx)("strong",{children:"检查连接:"})," 验证 Notion API 连接状态"]}),(0,o.jsxs)("li",{children:[(0,o.jsx)("strong",{children:"从 Notion 导入:"})," 将 Notion 数据库中的题目同步到本地"]}),(0,o.jsxs)("li",{children:[(0,o.jsx)("strong",{children:"智能匹配:"})," 自动识别分类、难度、标签等字段"]}),(0,o.jsxs)("li",{children:[(0,o.jsx)("strong",{children:"去重机制:"})," 基于 Notion Page ID 避免重复导入"]})]})]}),"data"===g&&(0,o.jsxs)("div",{className:"instruction-item",children:[(0,o.jsx)("h4",{children:"📊 题目数据管理"}),(0,o.jsxs)("ul",{children:[(0,o.jsxs)("li",{children:[(0,o.jsx)("strong",{children:"生成示例数据:"})," 创建分类和题目示例数据"]}),(0,o.jsxs)("li",{children:[(0,o.jsx)("strong",{children:"检查状态:"})," 查看当前数据统计"]}),(0,o.jsxs)("li",{children:[(0,o.jsx)("strong",{children:"清除数据:"})," 删除所有题目和分类数据"]})]})]}),"community"===g&&(0,o.jsxs)("div",{className:"instruction-item",children:[(0,o.jsx)("h4",{children:"👥 社区数据管理"}),(0,o.jsxs)("ul",{children:[(0,o.jsxs)("li",{children:[(0,o.jsx)("strong",{children:"创建数据表:"})," 初始化社区功能所需的数据表（Post、Comment、Like、Follow）"]}),(0,o.jsxs)("li",{children:[(0,o.jsx)("strong",{children:"生成示例数据:"})," 创建示例帖子、评论和点赞数据"]}),(0,o.jsxs)("li",{children:[(0,o.jsx)("strong",{children:"检查状态:"})," 查看社区数据统计"]}),(0,o.jsxs)("li",{children:[(0,o.jsx)("strong",{children:"清除数据:"})," 删除所有社区相关数据"]})]}),(0,o.jsxs)("div",{className:"community-features",children:[(0,o.jsx)("h5",{children:"社区功能特性:"}),(0,o.jsxs)("ul",{children:[(0,o.jsx)("li",{children:"📝 发帖和内容管理"}),(0,o.jsx)("li",{children:"💬 评论和回复系统"}),(0,o.jsx)("li",{children:"👍 点赞互动功能"}),(0,o.jsx)("li",{children:"👥 用户关注系统"}),(0,o.jsx)("li",{children:"🔐 完善的权限控制"})]})]})]}),(0,o.jsxs)("div",{className:"instruction-item",children:[(0,o.jsx)("h4",{children:"🔧 环境配置要求"}),(0,o.jsxs)("div",{className:"config-requirements",children:[(0,o.jsxs)("div",{className:"config-item",children:[(0,o.jsx)("strong",{children:"Notion 集成:"}),(0,o.jsx)("span",{children:"需要配置 NOTION_INTEGRATION_TOKEN 和 NOTION_DATABASE_ID"})]}),(0,o.jsxs)("div",{className:"config-item",children:[(0,o.jsx)("strong",{children:"云函数部署:"}),(0,o.jsx)("span",{children:"需要在 LeanCloud 云引擎部署同步函数"})]}),(0,o.jsxs)("div",{className:"config-item",children:[(0,o.jsx)("strong",{children:"数据库权限:"}),(0,o.jsx)("span",{children:"Notion 数据库需要分享给集成"})]})]})]})]})]})};var ts=t(6475),as=t(7097);const ns=({question:e,onSave:s,onCancel:t,defaultCategoryId:n,onCategoryChange:c})=>{const[i,r]=(0,a.useState)({title:"",detailedAnswer:"",oralAnswer:"",code:"",url:"",tags:[],difficulty:k,proficiency:A,appearanceLevel:50,categoryId:"",images:[]}),[l,d]=(0,a.useState)([]),[h,m]=(0,a.useState)(""),[g,x]=(0,a.useState)(!1),[j,p]=(0,a.useState)(!1),[v,N]=(0,a.useState)({}),[y,f]=(0,a.useState)("detailed"),[b,C]=(0,a.useState)([]),S=u().User.current(),E=(0,a.useRef)(null),q=(0,a.useRef)(null),L=(0,a.useRef)(null),D=!!e;(0,a.useEffect)(()=>{u().User.current()&&(T(),e?r({title:e.title||"",detailedAnswer:e.detailedAnswer||"",oralAnswer:e.oralAnswer||"",code:e.code||"",url:e.url||"",tags:e.tags||[],difficulty:e.difficulty||k,proficiency:e.proficiency||A,appearanceLevel:e.appearanceLevel||50,categoryId:e.category?.id||"",images:e.images||[]}):n&&r(e=>({...e,categoryId:n})))},[e,n]);const T=async()=>{if(S){p(!0);try{const e=await w(),s=e.filter(e=>{const s=e.createdBy;return s&&s.id===S.id});d(s),console.log("加载到的分类:",{总数:e.length,用户分类:s.length,当前用户:S.id,分类详情:s.map(e=>({id:e.id,name:e.name,createdBy:e.createdBy?.id}))}),!D&&!n&&s.length>0&&!i.categoryId&&(r(e=>({...e,categoryId:s[0].id})),console.log("自动选择第一个分类:",s[0].id))}catch(e){console.error("加载类别失败:",e),N({categories:"加载类别失败: "+e.message})}finally{p(!1)}}},$=async(e,s)=>{const t=e.filter(e=>"image/jpeg"===e.type||"image/png"===e.type||"image/jpg"===e.type);if(0!==t.length)for(const e of t)await P(e,s);else alert("请选择 JPG 或 PNG 格式的图片文件")},P=async(e,s)=>{const t=Date.now().toString();try{C(e=>[...e,t]);const a=new(u().File)(e.name,e),n=await a.save(),c={id:t,objectId:n.id,url:n.url(),name:e.name,size:e.size,type:e.type,answerType:s};r(e=>({...e,images:[...e.images,c]})),I(c,s)}catch(e){console.error("图片上传失败:",e),alert(`图片上传失败: ${e.message}`)}finally{C(e=>e.filter(e=>e!==t))}},I=(e,s)=>{const t=`![${e.name}](${e.url})`,a="detailed"===s?"detailedAnswer":"oralAnswer";r(e=>{const s=e[a],n=s?`${s}\n${t}`:t;return{...e,[a]:n}})},Q=(e,s)=>{r(t=>({...t,[e]:s})),v[e]&&N(s=>({...s,[e]:""}))},U=()=>{const e=h.trim();if(e&&!i.tags.includes(e)){if(i.tags.length>=10)return void N({tags:"标签数量不能超过10个"});r(s=>({...s,tags:[...s.tags,e]})),m(""),v.tags&&N(e=>({...e,tags:""}))}},R=(e,s,t)=>{const a=(n=e,i.images.filter(e=>e.answerType===n));var n;const c=b.length>0,l="detailed"===e?"detailedAnswer":"oralAnswer",d="detailed"===e?q:L;return(0,o.jsxs)("div",{className:"tab-panel",children:[(0,o.jsxs)("div",{className:"answer-textarea-container",onDragOver:s=>((e,s)=>{e.preventDefault(),e.stopPropagation();const t="detailed"===s?q.current:L.current;t&&t.classList.add("drag-over")})(s,e),onDragLeave:s=>((e,s)=>{e.preventDefault(),e.stopPropagation();const t="detailed"===s?q.current:L.current;t&&t.classList.remove("drag-over")})(s,e),onDrop:s=>((e,s)=>{e.preventDefault(),e.stopPropagation();const t="detailed"===s?q.current:L.current;t&&t.classList.remove("drag-over");const a=Array.from(e.dataTransfer.files);$(a,s)})(s,e),children:[(0,o.jsx)("textarea",{ref:d,value:i[l],onChange:e=>Q(l,e.target.value),placeholder:s,rows:"detailed"===e?"6":"4",disabled:g,className:v.answer&&!i[l].trim()?"error":""}),(0,o.jsx)("div",{className:"upload-hint",children:(0,o.jsxs)("div",{className:"upload-hint-text",children:["💡 支持拖拽 JPG/PNG 图片到此区域，或",(0,o.jsx)("button",{type:"button",className:"upload-trigger-btn",onClick:()=>(e=>{E.current&&(E.current.setAttribute("data-answer-type",e),E.current.click())})(e),disabled:g||c,children:"点击上传"})]})})]}),a.length>0&&(0,o.jsxs)("div",{className:"uploaded-images",children:[(0,o.jsxs)("div",{className:"images-title",children:["已上传图片 (",a.length,"):"]}),(0,o.jsx)("div",{className:"images-grid",children:a.map(e=>(0,o.jsxs)("div",{className:"image-item",children:[(0,o.jsx)("img",{src:e.url,alt:e.name}),(0,o.jsxs)("div",{className:"image-info",children:[(0,o.jsx)("span",{className:"image-name",children:e.name}),(0,o.jsx)("button",{type:"button",className:"remove-image-btn",onClick:()=>{return s=e.id,void r(e=>({...e,images:e.images.filter(e=>e.id!==s)}));var s},disabled:g,children:"×"})]})]},e.id))})]}),(0,o.jsx)("div",{className:"tab-hint",children:t})]})};return S?(0,o.jsx)("div",{className:"question-form-overlay",children:(0,o.jsxs)("div",{className:"question-form-dialog",children:[(0,o.jsxs)("div",{className:"question-form-header",children:[(0,o.jsx)("h3",{children:D?"编辑题目":"添加新题目"}),(0,o.jsx)("div",{className:"user-info",children:(0,o.jsxs)("span",{className:"user-badge",children:["👤 ",S.getUsername()]})}),(0,o.jsx)("button",{type:"button",className:"close-button",onClick:t,disabled:g,children:"×"})]}),(0,o.jsxs)("form",{onSubmit:async t=>{if(t.preventDefault(),S){if((()=>{const e={};return i.title.trim()?i.title.trim().length<2&&(e.title="问题标题至少需要2个字符"):e.title="问题标题不能为空",i.detailedAnswer.trim()||i.oralAnswer.trim()||(e.answer="至少需要填写一个答案版本（详细版本或口述版本）"),i.categoryId||(e.categoryId="请选择类别"),i.tags.length>10&&(e.tags="标签数量不能超过10个"),i.url&&!(e=>{try{return new URL(e),!0}catch(e){return!1}})(i.url)&&(e.url="请输入有效的URL链接"),N(e),0===Object.keys(e).length})()){x(!0);try{if(D){const s=e.category,t=l.find(e=>e.id===i.categoryId),a=s?.id!==t?.id;await M(e.id,i),a&&c&&c({questionId:e.id,oldCategoryId:s?.id,newCategoryId:t?.id,question:{...e,...i,category:t}})}else await O(i);s(),window.dispatchEvent(new CustomEvent("questionCreated",{detail:{question:result}}))}catch(e){console.error("保存题目失败:",e),N({submit:e.message})}finally{x(!1)}}}else alert("请先登录")},className:"question-form",children:[(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsx)("label",{htmlFor:"title",children:"问题标题 *"}),(0,o.jsx)("input",{id:"title",type:"text",value:i.title,onChange:e=>Q("title",e.target.value),placeholder:"请输入问题标题",disabled:g,className:v.title?"error":""}),v.title&&(0,o.jsx)("span",{className:"error-message",children:v.title})]}),(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsx)("label",{children:"问题答案 *"}),(0,o.jsxs)("div",{className:"answer-tabs-container",children:[(0,o.jsxs)("div",{className:"answer-tab-buttons",children:[(0,o.jsx)("button",{type:"button",className:"answer-tab-button "+("detailed"===y?"active":""),onClick:()=>f("detailed"),children:"详细版本"}),(0,o.jsx)("button",{type:"button",className:"answer-tab-button "+("oral"===y?"active":""),onClick:()=>f("oral"),children:"口述版本"})]}),(0,o.jsxs)("div",{className:"answer-tab-content",children:["detailed"===y&&R("detailed","请输入详细的答案解释，包含技术细节、原理分析等","适合记录完整的技术解析和详细说明"),"oral"===y&&R("oral","请输入简洁的口述版本答案，适合面试场景表达","适合记录简洁的口头表达版本，便于面试时快速回忆")]})]}),v.answer&&(0,o.jsx)("span",{className:"error-message",children:v.answer})]}),(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsx)("label",{htmlFor:"code",children:"相关代码（可选）"}),(0,o.jsx)("textarea",{id:"code",value:i.code,onChange:e=>Q("code",e.target.value),placeholder:"请输入与该题目相关的代码片段，将保持原格式显示",rows:"8",disabled:g,className:"code-textarea"}),(0,o.jsx)("div",{className:"field-hint",children:"代码将保持原格式显示，适合展示算法实现、组件代码等"})]}),(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsx)("label",{htmlFor:"url",children:"相关链接（可选）"}),(0,o.jsx)("input",{id:"url",type:"url",value:i.url,onChange:e=>Q("url",e.target.value),placeholder:"https://example.com",disabled:g,className:v.url?"error":""}),v.url&&(0,o.jsx)("span",{className:"error-message",children:v.url}),(0,o.jsx)("div",{className:"field-hint",children:"可添加相关的文档、文章或参考链接"})]}),(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsx)("label",{htmlFor:"tags",children:"标签（可选）"}),(0,o.jsxs)("div",{className:"tags-input-container",children:[(0,o.jsx)("input",{id:"tags",type:"text",value:h,onChange:e=>m(e.target.value),onKeyPress:e=>{"Enter"===e.key&&(e.preventDefault(),U())},placeholder:"输入标签后按回车或点击添加",disabled:g,maxLength:20}),(0,o.jsx)("button",{type:"button",onClick:U,disabled:g||!h.trim(),className:"add-tag-button",children:"添加"})]}),v.tags&&(0,o.jsx)("span",{className:"error-message",children:v.tags}),i.tags.length>0&&(0,o.jsxs)("div",{className:"tags-list",children:[(0,o.jsx)("div",{className:"tags-header",children:(0,o.jsxs)("span",{children:["已添加标签 (",i.tags.length,"/10):"]})}),(0,o.jsx)("div",{className:"tags-container",children:i.tags.map((e,s)=>(0,o.jsxs)("span",{className:"tag",children:[e,(0,o.jsx)("button",{type:"button",onClick:()=>{return s=e,void r(e=>({...e,tags:e.tags.filter(e=>e!==s)}));var s},disabled:g,className:"remove-tag-button",children:"×"})]},s))})]})]}),(0,o.jsxs)("div",{className:"form-row",children:[(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsx)("label",{htmlFor:"difficulty",children:"难度"}),(0,o.jsxs)("select",{id:"difficulty",value:i.difficulty,onChange:e=>Q("difficulty",e.target.value),disabled:g,children:[(0,o.jsx)("option",{value:"easy",children:"简单"}),(0,o.jsx)("option",{value:k,children:"中等"}),(0,o.jsx)("option",{value:"hard",children:"困难"})]})]}),(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsx)("label",{htmlFor:"proficiency",children:"掌握程度"}),(0,o.jsxs)("select",{id:"proficiency",value:i.proficiency,onChange:e=>Q("proficiency",e.target.value),disabled:g,children:[(0,o.jsx)("option",{value:A,children:"初级"}),(0,o.jsx)("option",{value:"intermediate",children:"中级"}),(0,o.jsx)("option",{value:"advanced",children:"高级"}),(0,o.jsx)("option",{value:"master",children:"精通"})]})]})]}),(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsxs)("label",{htmlFor:"appearanceLevel",children:["出现频率: ",i.appearanceLevel,"%",(0,o.jsx)("span",{className:"field-hint",children:"（数值越高，在复习时出现的概率越大）"})]}),(0,o.jsx)("input",{id:"appearanceLevel",type:"range",min:"0",max:"100",value:i.appearanceLevel,onChange:e=>Q("appearanceLevel",parseInt(e.target.value)),disabled:g,className:"appearance-slider"}),(0,o.jsxs)("div",{className:"slider-labels",children:[(0,o.jsx)("span",{children:"低频"}),(0,o.jsx)("span",{children:"中频"}),(0,o.jsx)("span",{children:"高频"})]})]}),(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsx)("label",{htmlFor:"category",children:"类别 *"}),j?(0,o.jsx)("div",{className:"loading-categories",children:"加载类别中..."}):0===l.length?(0,o.jsxs)("div",{className:"no-categories",children:[(0,o.jsx)("div",{className:"no-categories-icon",children:"📁"}),(0,o.jsx)("p",{children:"暂无类别，请先创建类别"}),(0,o.jsx)("button",{type:"button",className:"create-category-btn",onClick:()=>{t(),window.dispatchEvent(new CustomEvent("showCategoryManagement"))},children:"🚀 去创建分类"})]}):(0,o.jsxs)("select",{id:"category",value:i.categoryId,onChange:e=>Q("categoryId",e.target.value),disabled:g,className:v.categoryId?"error":"",children:[(0,o.jsx)("option",{value:"",children:"请选择类别"}),l.map(e=>(0,o.jsxs)("option",{value:e.id,children:[e.name," (",e.questionCount||0,"题)"]},e.id))]}),v.categoryId&&(0,o.jsx)("span",{className:"error-message",children:v.categoryId})]}),v.submit&&(0,o.jsx)("div",{className:"submit-error",children:v.submit}),(0,o.jsxs)("div",{className:"form-actions",children:[(0,o.jsx)("button",{type:"button",onClick:t,disabled:g,className:"btn-secondary",children:"取消"}),(0,o.jsx)("button",{type:"submit",disabled:g,className:"btn-primary",children:g?(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("span",{className:"loading-spinner"}),D?"更新中...":"添加中..."]}):D?"更新题目":"添加题目"})]})]}),(0,o.jsx)("input",{type:"file",ref:E,style:{display:"none"},accept:".jpg,.jpeg,.png",multiple:!0,onChange:e=>{const s=e.target.getAttribute("data-answer-type");((e,s)=>{const t=Array.from(e.target.files);$(t,s),e.target.value=""})(e,s)}})]})}):(0,o.jsx)("div",{className:"question-form-overlay",children:(0,o.jsxs)("div",{className:"question-form-dialog",children:[(0,o.jsxs)("div",{className:"question-form-header",children:[(0,o.jsx)("h3",{children:"请先登录"}),(0,o.jsx)("button",{type:"button",className:"close-button",onClick:t,children:"×"})]}),(0,o.jsxs)("div",{className:"auth-required-container",children:[(0,o.jsx)("div",{className:"auth-required-icon",children:"🔐"}),(0,o.jsx)("p",{children:"登录后即可添加或编辑题目"}),(0,o.jsxs)("div",{className:"auth-required-actions",children:[(0,o.jsx)("button",{onClick:()=>window.dispatchEvent(new CustomEvent("showAuthModal")),className:"login-btn",children:"立即登录"}),(0,o.jsx)("button",{onClick:t,className:"btn-secondary",children:"取消"})]})]})]})})},cs=({question:e,onDelete:s,isExpandedView:t=!1,onUpdateField:n,onEdit:c,showQuestionForm:i,setShowQuestionForm:r,editingQuestion:l,setEditingQuestion:d})=>{const[h,m]=(0,a.useState)(!1),[g,x]=(0,a.useState)(t),[j,p]=(0,a.useState)(!1),[v,N]=(0,a.useState)(!1),[y,f]=(0,a.useState)("oral"),[w,b]=(0,a.useState)(e?.appearanceLevel||50),[C,S]=(0,a.useState)(!1),[k,A]=(0,a.useState)(!1),[E,q]=(0,a.useState)(7),[L,D]=(0,a.useState)(!1),[T,$]=(0,a.useState)(!1),[P,I]=(0,a.useState)(7),[Q,O]=(0,a.useState)(!1),[U,R]=(0,a.useState)(null);(0,a.useEffect)(()=>{const e=u().User.current();R(e)},[]),(0,a.useEffect)(()=>{console.log("question.appearanceLevel 变化:",e?.appearanceLevel),b(e?.appearanceLevel)},[e?.appearanceLevel]),(0,a.useEffect)(()=>{console.log("localAppearanceLevel 状态变化:",w)},[w]);const M=e=>e>=80?"#ff6b6b":e>=60?"#ffa726":e>=40?"#4ecdc4":"#95a5a6",_=e=>(e=>{if(!e||""===e.trim())return(0,o.jsx)("span",{className:"no-content",children:"暂无内容"});const s=e.split("\n"),t=[];let a=!1,n=[],c="";return s.forEach((e,s)=>{if(e.trim().startsWith("```"))return a?(a=!1,void t.push((0,o.jsx)("pre",{className:"code-block",children:(0,o.jsx)("code",{className:`language-${c}`,children:n.join("\n")})},`code-${s}`))):(a=!0,c=e.trim().substring(3).trim()||"text",void(n=[]));if(a)return void n.push(e);if(""===e.trim())return void t.push((0,o.jsx)("br",{},`br-${s}`));const i=e.match(/!\[(.*?)\]\((.*?)\)/);if(i){const e=i[1],a=i[2];return void t.push((0,o.jsxs)("div",{className:"markdown-image-container",children:[(0,o.jsx)("img",{src:a,alt:e,className:"markdown-image-preview",onClick:e=>{e.stopPropagation(),window.open(a,"_blank")}}),e&&""!==e&&(0,o.jsx)("div",{className:"image-alt-text",children:e})]},`img-${s}`))}let r=e;if(e.startsWith("### "))return void t.push((0,o.jsx)("h3",{className:"md-h3",children:e.substring(4)},`h3-${s}`));if(e.startsWith("## "))return void t.push((0,o.jsx)("h2",{className:"md-h2",children:e.substring(3)},`h2-${s}`));if(e.startsWith("# "))return void t.push((0,o.jsx)("h1",{className:"md-h1",children:e.substring(2)},`h1-${s}`));if(r=r.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),r=r.replace(/__(.*?)__/g,"<strong>$1</strong>"),r=r.replace(/\*(.*?)\*/g,"<em>$1</em>"),r=r.replace(/_(.*?)_/g,"<em>$1</em>"),r=r.replace(/`(.*?)`/g,'<code class="inline-code">$1</code>'),r=r.replace(/\[(.*?)\]\((.*?)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer" class="md-link">$1</a>'),e.trim().startsWith("- ")||e.trim().startsWith("* ")){const a=e.trim().substring(2);return void t.push((0,o.jsxs)("div",{className:"md-list-item",children:["• ",a]},`li-${s}`))}const l=e.trim().match(/^(\d+)\.\s+(.*)$/);l?t.push((0,o.jsxs)("div",{className:"md-list-item",children:[l[1],". ",l[2]]},`oli-${s}`)):e.trim().startsWith("> ")?t.push((0,o.jsx)("blockquote",{className:"md-blockquote",children:e.substring(2)},`blockquote-${s}`)):t.push((0,o.jsx)("div",{className:"md-paragraph",dangerouslySetInnerHTML:{__html:r}},`p-${s}`))}),a&&n.length>0&&t.push((0,o.jsx)("pre",{className:"code-block",children:(0,o.jsx)("code",{className:`language-${c}`,children:n.join("\n")})},"code-final")),(0,o.jsx)("div",{className:"markdown-content",children:t})})(e),F=()=>{U?c?c(e):m(!0):alert("请先登录")},W=async()=>{if(U){if(!j&&window.confirm(`确定要删除题目 "${e.title}" 吗？此操作不可撤销！`)){p(!0);try{await s(e.id)}catch(e){console.error("删除题目失败:",e)}finally{p(!1)}}}else alert("请先登录")};if(!U)return(0,o.jsx)("div",{className:"question-detail-card "+(t?"expanded-view":""),children:(0,o.jsxs)("div",{className:"auth-required-container",children:[(0,o.jsx)("div",{className:"auth-required-icon",children:"🔐"}),(0,o.jsx)("h3",{children:"请先登录"}),(0,o.jsx)("p",{children:"登录后即可查看题目详情"}),(0,o.jsx)("div",{className:"auth-required-actions",children:(0,o.jsx)("button",{onClick:()=>window.dispatchEvent(new CustomEvent("showAuthModal")),className:"login-btn",children:"立即登录"})})]})});if(h&&!c)return(0,o.jsx)("div",{className:"question-edit-container "+(t?"expanded-view":""),children:(0,o.jsx)(ns,{question:e,onSave:()=>{m(!1)},onCancel:()=>{m(!1)}})});const B=e?.detailedAnswer||"",z=e?.oralAnswer||"",J=e?.code||"",V=e?.url||"",H=w;return(0,o.jsxs)("div",{className:"question-detail-card "+(t?"expanded-view":""),children:[!t&&(0,o.jsxs)("div",{className:"question-header",children:[(0,o.jsxs)("div",{className:"question-title-section",children:[(0,o.jsx)("h3",{className:"question-title",children:e?.title||"无标题"}),(0,o.jsxs)("div",{className:"question-meta-badges",children:[(0,o.jsx)("span",{className:"difficulty-badge",style:{backgroundColor:(e=>{switch(e){case"easy":return"#52c41a";case"medium":return"#faad14";case"hard":return"#f5222d";default:return"#666"}})(e?.difficulty)},children:(e=>{switch(e){case"easy":return"简单";case"medium":return"中等";case"hard":return"困难";default:return e}})(e?.difficulty)}),(0,o.jsx)("span",{className:"proficiency-badge",children:(e=>{switch(e){case"beginner":return"初级";case"intermediate":return"中级";case"advanced":return"高级";case"master":return"精通";default:return e}})(e?.proficiency)})]})]}),(0,o.jsxs)("div",{className:"question-actions",children:[(0,o.jsx)("button",{onClick:F,className:"btn-edit",title:"编辑题目",disabled:j,children:v?"编辑中...":"✏️ 编辑"}),(0,o.jsx)("button",{onClick:()=>$(!0),className:"btn-remove-review",title:"暂时移除复习",children:"⏸️ 暂停复习"}),(0,o.jsx)("button",{onClick:W,className:"btn-delete",title:"删除题目",disabled:j,children:j?"删除中...":"🗑️ 删除"})]})]}),(0,o.jsxs)("div",{className:"appearance-level-display",children:[(0,o.jsxs)("div",{className:"appearance-header",children:[(0,o.jsx)("span",{className:"appearance-label",children:"出现频率"}),(0,o.jsx)("span",{className:"appearance-value "+(C?"updating":""),children:C?"保存中...":`${H}%`})]}),(0,o.jsx)("div",{className:"appearance-slider-container",children:(0,o.jsx)("input",{type:"range",min:"0",max:"100",value:H,onChange:s=>{(async s=>{if(U)if(console.log("开始更新出现频率:",{新值:s,当前prop值:e?.appearanceLevel,当前本地状态值:w}),b(s),n&&e?.id){S(!0);try{await n(e.id,"appearanceLevel",s),console.log("出现频率更新成功，等待父组件数据更新")}catch(s){console.error("更新出现频率失败:",s),b(e?.appearanceLevel||50)}finally{S(!1)}}else console.warn("缺少 onUpdateField 或 question.id");else alert("请先登录")})(parseInt(s.target.value))},className:"appearance-slider-editable",disabled:C,style:{background:`linear-gradient(90deg, \n                ${M(0)} 0%, \n                ${M(50)} 50%, \n                ${M(100)} 100%)`}})}),(0,o.jsxs)("div",{className:"appearance-labels",children:[(0,o.jsx)("span",{className:"appearance-label-low",children:"低频"}),(0,o.jsx)("span",{className:"appearance-label-high",children:"高频"})]}),(0,o.jsxs)("div",{className:"appearance-hint",children:["拖动滑块调整出现频率，数值越高在复习时出现的概率越大",C&&(0,o.jsx)("span",{className:"saving-indicator",children:" • 保存中..."})]})]}),(0,o.jsxs)("div",{className:"answer-section",children:[!t&&(0,o.jsxs)("div",{className:"answer-header",children:[(0,o.jsx)("h4",{children:"答案"}),(0,o.jsxs)("div",{className:"answer-controls",children:[(0,o.jsxs)("div",{className:"answer-tabs",children:[(0,o.jsx)("button",{className:"tab-button "+("detailed"===y?"active":""),onClick:()=>f("detailed"),children:"详细版本"}),(0,o.jsx)("button",{className:"tab-button "+("oral"===y?"active":""),onClick:()=>f("oral"),children:"口述版本"})]}),(0,o.jsx)("button",{onClick:()=>{x(!g)},className:"toggle-answer-btn",children:g?"收起":"展开"})]})]}),(0,o.jsx)("div",{className:"answer-content "+(g||t?"expanded":"collapsed"),children:t?(0,o.jsxs)("div",{className:"expanded-answer-tabs",children:[(0,o.jsxs)("div",{className:"expanded-tab-buttons",children:[(0,o.jsx)("button",{className:"expanded-tab-button "+("detailed"===y?"active":""),onClick:()=>f("detailed"),children:"详细版本"}),(0,o.jsx)("button",{className:"expanded-tab-button "+("oral"===y?"active":""),onClick:()=>f("oral"),children:"口述版本"})]}),(0,o.jsx)("div",{className:"expanded-tab-content",children:"detailed"===y?(0,o.jsxs)("div",{className:"detailed-answer",children:[(0,o.jsx)("h5",{children:"详细答案"}),(0,o.jsx)("div",{className:"answer-text markdown-enabled",children:_(B)})]}):(0,o.jsxs)("div",{className:"oral-answer",children:[(0,o.jsx)("h5",{children:"口述答案"}),(0,o.jsx)("div",{className:"answer-text markdown-enabled",children:_(z)})]})})]}):(0,o.jsx)("div",{className:"answer-text markdown-enabled",children:_("detailed"===y?B:z)})}),J&&J.trim()&&(0,o.jsxs)("div",{className:"code-section",children:[(0,o.jsx)("h5",{children:"相关代码"}),(e=>e&&""!==e.trim()?(0,o.jsx)("pre",{className:"code-block",children:(0,o.jsx)("code",{children:e})}):null)(J)]}),V&&V.trim()&&(0,o.jsxs)("div",{className:"url-section",children:[(0,o.jsx)("h5",{children:"相关链接"}),(0,o.jsxs)("a",{href:V,target:"_blank",rel:"noopener noreferrer",className:"question-link",children:["🔗 ",V]})]})]}),(0,o.jsxs)("div",{className:"review-confirm-section",children:[(0,o.jsx)("button",{className:"confirm-review-btn",onClick:()=>A(!0),children:"✅ 确认已复习"}),(0,o.jsx)("p",{className:"review-hint",children:"点击确认后，该题目将在一段时间内不会出现在复习列表中"})]}),k&&(0,o.jsx)("div",{className:"modal-overlay",children:(0,o.jsxs)("div",{className:"modal-content review-confirm-modal",children:[(0,o.jsxs)("div",{className:"modal-header",children:[(0,o.jsx)("h3",{children:"确认复习完成"}),(0,o.jsx)("button",{className:"close-btn",onClick:()=>A(!1),children:"×"})]}),(0,o.jsxs)("div",{className:"modal-body",children:[(0,o.jsx)("p",{children:"请选择在多少天内不再提醒复习这道题目："}),(0,o.jsxs)("div",{className:"review-days-selector",children:[(0,o.jsx)("div",{className:"days-presets",children:[1,3,7,14,30].map(e=>(0,o.jsxs)("button",{className:"days-preset-btn "+(E===e?"active":""),onClick:()=>q(e),children:[e,"天"]},e))}),(0,o.jsxs)("div",{className:"custom-days-input",children:[(0,o.jsx)("label",{htmlFor:"customDays",children:"自定义天数："}),(0,o.jsx)("input",{id:"customDays",type:"number",min:"1",max:"365",value:E,onChange:e=>q(parseInt(e.target.value)||1),className:"days-input"})]})]}),(0,o.jsxs)("div",{className:"review-info",children:[(0,o.jsxs)("p",{children:[(0,o.jsx)("strong",{children:"题目："}),e?.title]}),(0,o.jsxs)("p",{children:[(0,o.jsx)("strong",{children:"下次提醒时间："}),new Date(Date.now()+24*E*60*60*1e3).toLocaleDateString()]})]})]}),(0,o.jsxs)("div",{className:"modal-actions",children:[(0,o.jsx)("button",{className:"cancel-btn",onClick:()=>A(!1),disabled:L,children:"取消"}),(0,o.jsx)("button",{className:"confirm-btn",onClick:async()=>{if(U){if(!L){D(!0);try{const s=new Date;s.setDate(s.getDate()+E),n&&e?.id&&(await n(e.id,"nextReviewDate",s.toISOString()),console.log(`题目将在 ${E} 天后再次提醒复习`),alert(`已确认复习！该题目将在 ${E} 天后再次出现在复习列表中`),A(!1))}catch(e){console.error("确认复习失败:",e),alert("确认复习失败，请重试")}finally{D(!1)}}}else alert("请先登录")},disabled:L,children:L?"确认中...":"确认复习"})]})]})}),T&&(0,o.jsx)("div",{className:"modal-overlay",children:(0,o.jsxs)("div",{className:"modal-content remove-review-modal",children:[(0,o.jsxs)("div",{className:"modal-header",children:[(0,o.jsx)("h3",{children:"暂停复习提醒"}),(0,o.jsx)("button",{className:"close-btn",onClick:()=>$(!1),children:"×"})]}),(0,o.jsxs)("div",{className:"modal-body",children:[(0,o.jsx)("p",{children:"选择在多少天内不再提醒复习这道题目："}),(0,o.jsxs)("div",{className:"remove-days-selector",children:[(0,o.jsx)("div",{className:"days-presets",children:[1,3,7,14,30,90].map(e=>(0,o.jsxs)("button",{className:"days-preset-btn "+(P===e?"active":""),onClick:()=>I(e),children:[e,"天"]},e))}),(0,o.jsxs)("div",{className:"custom-days-input",children:[(0,o.jsx)("label",{htmlFor:"customRemoveDays",children:"自定义天数："}),(0,o.jsx)("input",{id:"customRemoveDays",type:"number",min:"1",max:"365",value:P,onChange:e=>I(parseInt(e.target.value)||1),className:"days-input"})]})]}),(0,o.jsxs)("div",{className:"remove-review-info",children:[(0,o.jsxs)("p",{children:[(0,o.jsx)("strong",{children:"题目："}),e?.title]}),(0,o.jsxs)("p",{children:[(0,o.jsx)("strong",{children:"下次提醒时间："}),new Date(Date.now()+24*P*60*60*1e3).toLocaleDateString()]}),(0,o.jsx)("p",{className:"info-text",children:"💡 在此期间，该题目不会出现在复习列表中"})]})]}),(0,o.jsxs)("div",{className:"modal-actions",children:[(0,o.jsx)("button",{className:"cancel-btn",onClick:()=>$(!1),disabled:Q,children:"取消"}),(0,o.jsx)("button",{className:"confirm-btn",onClick:async()=>{if(U){if(!Q){O(!0);try{const s=new Date;s.setDate(s.getDate()+P),n&&e?.id&&(await n(e.id,"nextReviewDate",s.toISOString()),console.log(`题目将在 ${P} 天后再次提醒复习`),alert(`已暂停复习！该题目将在 ${P} 天后再次出现在复习列表中`),$(!1))}catch(e){console.error("移除复习失败:",e),alert("操作失败，请重试")}finally{O(!1)}}}else alert("请先登录")},disabled:Q,children:Q?"处理中...":"确认暂停"})]})]})}),(0,o.jsxs)("div",{className:"card-details",children:[!t&&(0,o.jsxs)("div",{className:"category-info",children:[(0,o.jsx)("span",{className:"category-label",children:"所属分类:"}),(0,o.jsx)("span",{className:"category-name",children:e?.category?.name||"未分类"})]}),e?.tags&&e.tags.length>0&&(0,o.jsxs)("div",{className:"tags-section",children:[(0,o.jsx)("h4",{children:"标签"}),(0,o.jsx)("div",{className:"tags-container",children:e.tags.map((e,s)=>(0,o.jsxs)("span",{className:"tag",children:["#",e]},s))})]}),(0,o.jsxs)("div",{className:"time-info",children:[(0,o.jsxs)("span",{className:"create-time",children:["创建: ",e?.createdAt?new Date(e.createdAt).toLocaleDateString():"未知"]}),(0,o.jsxs)("span",{className:"update-time",children:["更新: ",e?.updatedAt?new Date(e.updatedAt).toLocaleDateString():"未知"]})]})]}),t&&(0,o.jsxs)("div",{className:"expanded-actions",children:[(0,o.jsx)("button",{onClick:F,className:"btn-edit primary",disabled:j,children:"✏️ 编辑题目"}),(0,o.jsx)("button",{onClick:()=>$(!0),className:"btn-remove-review secondary",children:"⏸️ 暂停复习"}),(0,o.jsx)("button",{onClick:W,className:"btn-delete secondary",disabled:j,children:"🗑️ 删除题目"})]}),i&&l&&l.id===e.id&&(0,o.jsx)("div",{className:"form-modal-overlay",style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.6)",display:"flex",justifyContent:"center",alignItems:"center",zIndex:9999,padding:"20px"},children:(0,o.jsx)(ns,{question:l,onSave:()=>{r(!1),d(null)},onCancel:()=>{r(!1),d(null)},defaultCategoryId:e?.category?.id})})]})},is=({question:e,index:s,isExpanded:t,onToggle:a,onDelete:n,onEdit:c,onUpdateField:i,viewMode:r,isDragging:l,isDragOver:d,onDragStart:h,onDragOver:u,onDragLeave:m,onDrop:g,onDragEnd:x,canDrag:j,showQuestionForm:p,setShowQuestionForm:v,editingQuestion:N,setEditingQuestion:y})=>{const f=e=>{switch(e){case"easy":return"#52c41a";case"medium":return"#faad14";case"hard":return"#f5222d";default:return"#666"}},w=e=>{switch(e){case"easy":return"#b7eb8f";case"medium":return"#ffe58f";case"hard":return"#ffa39e";default:return"#d9d9d9"}},b=e=>{switch(e){case"easy":return"#f6ffed";case"medium":return"#fffbe6";case"hard":return"#fff2f0";default:return"#fafafa"}},C=e=>{switch(e){case"easy":return"简单";case"medium":return"中等";case"hard":return"困难";default:return e}},S=e=>{switch(e){case"beginner":return"#ff6b6b";case"intermediate":return"#4ecdc4";case"advanced":return"#45b7d1";case"master":return"#96ceb4";default:return"#95a5a6"}},k=e=>{switch(e){case"beginner":return"🎀";case"intermediate":return"🎗️";case"advanced":return"🏅";case"master":return"👑";default:return"🎯"}},A=e=>{switch(e){case"beginner":return"初级";case"intermediate":return"中级";case"advanced":return"高级";case"master":return"精通";default:return e}},E=e=>new Date(e).toLocaleDateString("zh-CN",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),q=()=>{const s=e.oralAnswer||e.detailedAnswer;return s?s.substring(0,150)+(s.length>150?"...":""):"暂无答案内容"};return t?(0,o.jsxs)("div",{className:"expanded-question-view","data-question-id":e.id,children:[(0,o.jsxs)("div",{className:"expanded-header",children:[(0,o.jsxs)("button",{onClick:a,className:"back-to-list-btn",children:[(0,o.jsx)("span",{className:"back-icon",children:"←"}),"返回列表"]}),(0,o.jsxs)("div",{className:"expanded-title",children:[(0,o.jsxs)("span",{className:"question-index",children:["#",s+1]}),(0,o.jsx)("h3",{children:e.title})]}),(0,o.jsx)("div",{className:"expanded-actions",children:(0,o.jsx)("button",{onClick:()=>c(e),className:"btn-edit",children:"✏️ 编辑"})})]}),(0,o.jsx)("div",{className:"expanded-content",children:(0,o.jsx)(cs,{question:e,onDelete:n,onUpdateField:i,isExpandedView:!0,onEdit:c,showQuestionForm:p,setShowQuestionForm:v,editingQuestion:N,setEditingQuestion:y})})]}):"grid"===r?(0,o.jsxs)("div",{className:`question-grid-card ${l?"dragging":""} ${d?"drag-over":""}`,onClick:a,draggable:j,onDragStart:h,onDragOver:u,onDragLeave:m,onDrop:g,onDragEnd:x,"data-question-id":e.id,style:{borderLeft:`4px solid ${f(e.difficulty)}`,backgroundColor:b(e.difficulty),border:`1px solid ${w(e.difficulty)}`},children:[(0,o.jsxs)("div",{className:"proficiency-ribbon",style:{backgroundColor:S(e.proficiency)},children:[(0,o.jsx)("span",{className:"ribbon-icon",children:k(e.proficiency)}),(0,o.jsx)("span",{className:"ribbon-text",children:A(e.proficiency)})]}),(0,o.jsxs)("div",{className:"grid-header",children:[(0,o.jsxs)("span",{className:"question-index",children:["#",s+1]}),(0,o.jsx)("span",{className:"difficulty-tag",style:{backgroundColor:f(e.difficulty)},children:C(e.difficulty)})]}),(0,o.jsx)("h4",{className:"grid-title",children:e.title}),(0,o.jsxs)("div",{className:"appearance-level-indicator",children:[(0,o.jsx)("div",{className:"appearance-bar",style:{width:`${e.appearanceLevel||50}%`,backgroundColor:(L=e.appearanceLevel||50,L>=80?"#ff6b6b":L>=60?"#ffa726":L>=40?"#4ecdc4":"#95a5a6")}}),(0,o.jsxs)("span",{className:"appearance-text",children:[e.appearanceLevel||50,"%"]})]}),(0,o.jsx)("div",{className:"grid-meta",children:(0,o.jsxs)("span",{className:"update-time",children:["更新: ",E(e.updatedAt)]})}),(0,o.jsx)("div",{className:"grid-preview",children:(0,o.jsx)("div",{className:"preview-content",children:q()})}),j&&(0,o.jsx)("div",{className:"drag-handle",children:"⋮⋮"})]}):(0,o.jsxs)("div",{className:`modern-accordion ${t?"expanded":""} ${l?"dragging":""} ${d?"drag-over":""}`,draggable:j,onDragStart:h,onDragOver:u,onDragLeave:m,onDrop:g,onDragEnd:x,"data-question-id":e.id,style:{borderLeft:`4px solid ${f(e.difficulty)}`,backgroundColor:b(e.difficulty),border:`1px solid ${w(e.difficulty)}`},children:[(0,o.jsxs)("div",{className:"proficiency-ribbon",style:{backgroundColor:S(e.proficiency)},children:[(0,o.jsx)("span",{className:"ribbon-icon",children:k(e.proficiency)}),(0,o.jsx)("span",{className:"ribbon-text",children:A(e.proficiency)})]}),(0,o.jsxs)("div",{className:"accordion-header",onClick:a,children:[(0,o.jsxs)("div",{className:"header-main",children:[(0,o.jsxs)("div",{className:"question-meta",children:[(0,o.jsxs)("span",{className:"question-index",children:["#",s+1]}),(0,o.jsx)("span",{className:"difficulty-badge",style:{backgroundColor:f(e.difficulty)},children:C(e.difficulty)}),(0,o.jsxs)("span",{className:"appearance-badge",children:["📊 ",e.appearanceLevel||50,"%"]}),(0,o.jsxs)("span",{className:"time-badge",children:["⏱️ ",E(e.updatedAt)]})]}),(0,o.jsx)("h3",{className:"question-title",children:e.title}),(0,o.jsx)("div",{className:"question-preview",children:q()})]}),(0,o.jsxs)("div",{className:"header-actions",children:[j&&(0,o.jsx)("div",{className:"drag-handle",onClick:e=>e.stopPropagation(),children:"⋮⋮"}),(0,o.jsx)("span",{className:"accordion-icon",children:t?"▼":"►"})]})]})]});var L},rs=()=>{const{categoryId:e}=(0,c.g)(),s=(0,c.Zp)(),t=(0,r.jE)(),[n,i]=(0,a.useState)(null),[l,d]=(0,a.useState)([]),[h,x]=(0,a.useState)(!1),[p,v]=(0,a.useState)(null),[N,y]=(0,a.useState)(""),[f,b]=(0,a.useState)("createdAt"),[C,S]=(0,a.useState)(new Set),[k,A]=(0,a.useState)("accordion"),[E,q]=(0,a.useState)(null),[L,D]=(0,a.useState)(null),[T,$]=(0,a.useState)(""),[P,I]=(0,a.useState)(null),Q=(0,a.useRef)(null),O=(0,a.useRef)(null);(0,a.useEffect)(()=>{const e=u().User.current();I(e),e&&R()},[e]),(0,a.useEffect)(()=>{const e=e=>{const{questionId:s}=e.detail,t=document.querySelector(`[data-question-id="${s}"]`);t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),t.style.boxShadow="0 0 0 3px #667eea",setTimeout(()=>{t.style.boxShadow=""},2e3),C.has(s)||ne(s))};return window.addEventListener("scrollToQuestion",e),()=>{window.removeEventListener("scrollToQuestion",e)}},[C]);const R=async()=>{try{g(),await _(),await new Promise(e=>setTimeout(e,300)),await F()}catch(e){console.error("初始化失败:",e),(429===e.code||e.message.includes("Too many requests"))&&($("请求过于频繁，请稍后重试"),setTimeout(()=>$(""),5e3))}},_=async()=>{try{const s=await(async e=>{if(m.shouldUseOfflineData())throw console.log("📦 离线模式：无法获取分类题目列表"),new Error("离线模式下无法获取分类题目列表");try{const s=u().User.current();if(!s)throw new Error("用户未登录");const t=new(u().Query)("Category"),a=await t.get(e);if(a.get("createdBy").id!==s.id)throw new Error("无权访问此分类");const n=new(u().Query)("Question");n.equalTo("category",a),n.equalTo("createdBy",s),n.include("category"),n.descending("updatedAt");const c=await n.find(),i=c.map(e=>({id:e.id,title:e.get("title"),detailedAnswer:e.get("detailedAnswer"),oralAnswer:e.get("oralAnswer"),code:e.get("code"),difficulty:e.get("difficulty"),appearanceLevel:e.get("appearanceLevel"),proficiency:e.get("proficiency"),tags:e.get("tags")||[],category:{id:e.get("category").id,name:e.get("category").get("name")},createdAt:e.get("createdAt"),updatedAt:e.get("updatedAt")})),r={category:{id:a.id,name:a.get("name"),description:a.get("description"),questionCount:c.length,createdAt:a.get("createdAt"),updatedAt:a.get("updatedAt")},questions:i},l=Date.now();return j.questionCounts.set(e,{count:c.length,timestamp:l}),r}catch(e){throw console.error("获取分类详情失败:",e),e}})(e);i(s.category)}catch(e){console.error("加载分类信息失败:",e)}},F=async()=>{try{const e=(await w()).filter(e=>{const s=e.createdBy;return s&&s.id===P?.id});d(e)}catch(e){console.error("加载所有分类失败:",e),(429===e.code||e.message.includes("Too many requests"))&&($("服务器繁忙，请稍后重试"),setTimeout(()=>$(""),5e3))}},{data:W,fetchNextPage:B,hasNextPage:z,isFetchingNextPage:J,isLoading:V,error:H,refetch:K}=(0,ts.q)({queryKey:["questions",e,f],queryFn:async({pageParam:s=0})=>{console.log("正在获取第",s+1,"页数据");const t=await(async(e,s={})=>{if(m.shouldUseOfflineData())return console.log("📦 离线模式：无法获取分类题目"),{data:[]};try{const t=u().User.current();if(!t)throw new Error("用户未登录");const{page:a=1,pageSize:n=20,sortBy:c="updatedAt",sortOrder:i="desc"}=s,r=u().Object.createWithoutData("Category",e),l=new(u().Query)("Question");return l.equalTo("category",r),l.equalTo("createdBy",t),l.include("category"),"asc"===i?l.addAscending(c):l.addDescending(c),l.limit(n),l.skip((a-1)*n),{data:(await l.find()).map(e=>{const s=e.get("category");return{id:e.id,title:e.get("title"),detailedAnswer:e.get("detailedAnswer"),oralAnswer:e.get("oralAnswer"),code:e.get("code"),url:e.get("url"),tags:e.get("tags")||[],difficulty:e.get("difficulty"),proficiency:e.get("proficiency"),appearanceLevel:e.get("appearanceLevel")||50,category:s?{id:s.id,objectId:s.id,name:s.get("name"),description:s.get("description"),questionCount:s.get("questionCount")||0}:null,createdAt:e.get("createdAt"),updatedAt:e.get("updatedAt"),lastReviewedAt:e.get("lastReviewedAt")}})}}catch(e){throw console.error("获取分类题目失败:",e),new Error(`获取题目失败: ${e.message}`)}})(e,{page:s,pageSize:20,sortBy:f,sortOrder:"desc"});return console.log("第",s+1,"页返回数据:",{dataLength:t.data?.length,hasMore:20===t.data?.length,total:t.total}),{questions:t.data||[],total:t.total,nextPage:20===t.data?.length?s+1:void 0}},getNextPageParam:(e,s)=>e.nextPage,enabled:!!e&&!!P,staleTime:3e5,initialPageParam:0}),G=(0,a.useMemo)(()=>(W?.pages.flatMap(e=>e.questions)||[]).reduce((e,s)=>(e.find(e=>e.id===s.id)?console.warn("发现重复题目:",s.id,s.title):e.push(s),e),[]),[W]),Y=(0,a.useMemo)(()=>{if(!N)return G;const e=G.filter(e=>e.title.toLowerCase().includes(N.toLowerCase())||e.detailedAnswer&&e.detailedAnswer.toLowerCase().includes(N.toLowerCase())||e.oralAnswer&&e.oralAnswer.toLowerCase().includes(N.toLowerCase())||e.code&&e.code.toLowerCase().includes(N.toLowerCase())||e.tags&&e.tags.some(e=>e.toLowerCase().includes(N.toLowerCase())));return Array.from(new Map(e.map(e=>[e.id,e])).values())},[G,N]),Z=(0,a.useMemo)(()=>{const e=[...Y].sort((e,s)=>{switch(f){case"title":return e.title.localeCompare(s.title);case"difficulty":const t={easy:1,medium:2,hard:3};return t[e.difficulty]-t[s.difficulty];case"appearanceLevel":default:return(s.appearanceLevel||50)-(e.appearanceLevel||50);case"createdAt":return new Date(s.createdAt)-new Date(e.createdAt);case"updatedAt":return new Date(s.updatedAt)-new Date(e.createdAt)}});return Array.from(new Map(e.map(e=>[e.id,e])).values())},[Y,f]),X=(0,ae.Te)({count:Z.length,getScrollElement:()=>O.current,estimateSize:()=>"grid"===k?200:120,overscan:10}),ee=(0,a.useCallback)(()=>{const e=O.current;if(!e||!z||J)return;const{scrollTop:s,scrollHeight:t,clientHeight:a}=e,n=t-s-a;console.log("滚动检查:",{distanceFromBottom:n,shouldLoad:n<100,hasNextPage:z,isFetchingNextPage:J}),n<100&&(console.log("🎯 触发加载更多！当前页数:",W?.pages?.length||0),B())},[z,J,B,W]);(0,a.useEffect)(()=>{const e=O.current;if(!e)return void console.log("❌ 未找到滚动容器");console.log("✅ 绑定滚动监听器");const s=(e=>{let s;return function(...t){clearTimeout(s),s=setTimeout(()=>{clearTimeout(s),e(...t)},50)}})(ee);return e.addEventListener("scroll",s),()=>{e.removeEventListener("scroll",s)}},[ee]),(0,a.useEffect)(()=>{if(!Q.current||!z||J)return;console.log("🔍 设置 Intersection Observer");const e=new IntersectionObserver(e=>{e[0].isIntersecting&&(console.log("🎯 Intersection Observer 触发加载更多！"),B())},{threshold:.1,root:O.current,rootMargin:"100px"});return e.observe(Q.current),()=>{e.disconnect()}},[z,J,B,Z.length]);const se=(0,as.n)({mutationFn:U,onSuccess:()=>{t.invalidateQueries(["questions",e]),$("题目删除成功"),setTimeout(()=>$(""),3e3)},onError:e=>{console.error("删除题目失败:",e),alert("删除失败: "+e.message)}}),te=(0,as.n)({mutationFn:({questionId:e,data:s})=>M(e,s),onSuccess:()=>{t.invalidateQueries(["questions",e])},onError:e=>{throw console.error("更新题目失败:",e),new Error("更新失败: "+e.message)}}),ne=e=>{S(s=>{const t=new Set(s);return t.has(e)?t.delete(e):t.add(e),t})},ce=()=>{P?(v(null),x(!0)):alert("请先登录")},ie=e=>{P?(v(e),x(!0)):alert("请先登录")},re=async e=>{if(!P)return void alert("请先登录");const s=Z.find(s=>s.id===e);if(!s)throw new Error("未找到要删除的题目");const t=`确定要删除题目 "${s.title}" 吗？此操作不可撤销！`;window.confirm(t)&&(se.mutate(e),S(s=>{const t=new Set(s);return t.delete(e),t}))},le=async(e,s,t)=>{if(P)try{await te.mutateAsync({questionId:e,data:{[s]:t}})}catch(e){throw console.error("更新题目字段失败:",e),new Error("更新失败: "+e.message)}else alert("请先登录")},oe=()=>{s("/")},de=e=>{D(null)},he=e=>{q(null),D(null),e.currentTarget.style.opacity="1"};return(0,a.useEffect)(()=>{console.log("分页状态:",{hasNextPage:z,isFetchingNextPage:J,totalQuestions:G.length,pages:W?.pages?.length||0})},[z,J,G.length,W]),P?V&&!n?(0,o.jsx)("div",{className:"category-detail-page",children:(0,o.jsxs)("div",{className:"loading-container",children:[(0,o.jsx)("div",{className:"modern-spinner"}),(0,o.jsx)("p",{children:"加载题目中..."})]})}):H&&!n?(0,o.jsx)("div",{className:"category-detail-page",children:(0,o.jsxs)("div",{className:"error-container",children:[(0,o.jsx)("div",{className:"error-icon",children:"⚠️"}),(0,o.jsx)("h2",{children:"加载失败"}),(0,o.jsx)("p",{children:H.message}),(0,o.jsxs)("div",{className:"error-actions",children:[(0,o.jsx)("button",{onClick:()=>{K()},className:"btn-retry",children:"重新加载"}),(0,o.jsx)("button",{onClick:oe,className:"btn-back",children:"返回首页"})]})]})}):n?(0,o.jsxs)("div",{className:"category-detail-page",children:[(0,o.jsx)("header",{className:"modern-header",children:(0,o.jsx)("div",{className:"container",children:(0,o.jsxs)("div",{className:"header-content",children:[(0,o.jsxs)("button",{onClick:oe,className:"back-button",style:{display:"inline-flex",alignItems:"center",gap:"8px",padding:"10px 20px",backgroundColor:"transparent",color:"#667eea",border:"2px solid #667eea",borderRadius:"8px",fontSize:"16px",fontWeight:"500",cursor:"pointer",transition:"all 0.3s ease",textDecoration:"none",fontFamily:"inherit"},onMouseEnter:e=>{e.target.style.backgroundColor="#667eea",e.target.style.color="white",e.target.style.transform="translateY(-2px)",e.target.style.boxShadow="0 4px 12px rgba(102, 126, 234, 0.3)"},onMouseLeave:e=>{e.target.style.backgroundColor="transparent",e.target.style.color="#667eea",e.target.style.transform="translateY(0)",e.target.style.boxShadow="none"},children:[(0,o.jsx)("span",{className:"back-icon",style:{fontSize:"18px",fontWeight:"bold",transition:"transform 0.3s ease"},children:"←"}),"返回知识库"]}),(0,o.jsxs)("div",{className:"category-hero",children:[(0,o.jsxs)("div",{className:"category-badge",children:[(0,o.jsx)("span",{className:"category-emoji",children:"📚"}),(0,o.jsx)("span",{className:"category-name",children:n.name})]}),(0,o.jsx)("div",{className:"user-welcome",children:(0,o.jsxs)("span",{className:"welcome-text",children:["欢迎, ",P.getUsername(),"!"]})}),(0,o.jsxs)("div",{className:"hero-stats",children:[(0,o.jsxs)("div",{className:"stat-item",children:[(0,o.jsx)("span",{className:"stat-number",children:n.questionCount}),(0,o.jsx)("span",{className:"stat-label",children:"总题目"})]}),(0,o.jsxs)("div",{className:"stat-item",children:[(0,o.jsx)("span",{className:"stat-number",children:G.length}),(0,o.jsx)("span",{className:"stat-label",children:"已加载"})]}),(0,o.jsxs)("div",{className:"stat-item",children:[(0,o.jsx)("span",{className:"stat-number",children:C.size}),(0,o.jsx)("span",{className:"stat-label",children:"已展开"})]})]})]})]})})}),T&&(0,o.jsx)("div",{className:"sync-message",children:T}),(0,o.jsx)("section",{className:"control-panel",children:(0,o.jsxs)("div",{className:"container",children:[(0,o.jsxs)("div",{className:"panel-grid",children:[(0,o.jsx)("div",{className:"search-panel",children:(0,o.jsxs)("div",{className:"search-wrapper",children:[(0,o.jsx)("div",{className:"search-icon",children:"🔍"}),(0,o.jsx)("input",{type:"text",placeholder:"搜索题目、答案或标签...",value:N,onChange:e=>y(e.target.value),className:"modern-search",style:{color:"#333",backgroundColor:"#fff"}}),N&&(0,o.jsx)("button",{onClick:()=>y(""),className:"clear-search",children:"✕"})]})}),(0,o.jsxs)("div",{className:"controls-panel",children:[(0,o.jsxs)("div",{className:"controls-group",children:[(0,o.jsx)("label",{children:"排序方式"}),(0,o.jsxs)("select",{value:f,onChange:e=>b(e.target.value),className:"modern-select",style:{color:"#333",backgroundColor:"#fff"},children:[(0,o.jsx)("option",{value:"appearanceLevel",children:"出现频率"}),(0,o.jsx)("option",{value:"updatedAt",children:"最近更新"}),(0,o.jsx)("option",{value:"createdAt",children:"创建时间"}),(0,o.jsx)("option",{value:"title",children:"标题顺序"}),(0,o.jsx)("option",{value:"difficulty",children:"难度等级"})]})]}),(0,o.jsxs)("div",{className:"controls-group",children:[(0,o.jsx)("label",{children:"批量操作"}),(0,o.jsxs)("div",{className:"batch-actions",children:[(0,o.jsx)("button",{onClick:()=>{const e=new Set(Z.map(e=>e.id));S(e)},className:"action-btn expand-btn",disabled:0===Z.length,children:"📖 展开全部"}),(0,o.jsx)("button",{onClick:()=>{S(new Set)},className:"action-btn collapse-btn",disabled:0===C.size,children:"📕 折叠全部"})]})]}),(0,o.jsxs)("button",{className:"add-question-btn primary",onClick:ce,children:[(0,o.jsx)("span",{className:"btn-icon",children:"+"}),"添加题目"]})]})]}),(0,o.jsxs)("div",{className:"debug-controls",style:{marginTop:"10px",padding:"10px",background:"#f0f0f0",borderRadius:"4px"},children:[(0,o.jsx)("button",{onClick:()=>{console.log("🔄 手动触发加载更多"),B()},disabled:!z||J,style:{padding:"5px 10px",fontSize:"12px",background:z?"#1890ff":"#ccc",color:"white",border:"none",borderRadius:"3px"},children:J?"加载中...":z?"手动加载更多":"已无更多"}),(0,o.jsxs)("span",{style:{marginLeft:"10px",fontSize:"12px",color:"#666"},children:["状态: ",z?`有更多 (${G.length}/?)`:"已加载全部"]})]})]})}),(0,o.jsx)("section",{className:"content-section",children:(0,o.jsx)("div",{className:"container",children:0===Z.length?(0,o.jsxs)("div",{className:"modern-empty",children:[(0,o.jsx)("div",{className:"empty-illustration",children:N?"🔍":"📝"}),(0,o.jsx)("h3",{children:N?"没有找到匹配的题目":"此分类下暂无题目"}),(0,o.jsx)("p",{children:N?"尝试调整搜索条件或清除搜索框来查看所有题目":'点击"添加题目"按钮创建第一个题目，开始你的学习之旅'}),N?(0,o.jsx)("button",{onClick:()=>y(""),className:"clear-search-btn",children:"清除搜索条件"}):(0,o.jsx)("button",{onClick:ce,className:"add-first-btn",children:"🚀 创建第一个题目"})]}):(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{className:"results-stats",children:[(0,o.jsxs)("span",{className:"results-count",children:["找到 ",Z.length," 个题目",N&&(0,o.jsxs)("span",{children:['（搜索关键词: "',N,'"）']}),z&&(0,o.jsx)("span",{children:" - 滚动加载更多"})]}),(0,o.jsxs)("span",{className:"expand-count",children:[C.size," / ",Z.length," 已展开"]}),0===C.size&&(0,o.jsx)("span",{className:"drag-hint",children:"🎯 提示: 可以拖拽题目调整顺序"})]}),(0,o.jsxs)("div",{className:"debug-info",style:{fontSize:"12px",color:"#666",padding:"8px",background:"#f5f5f5",borderRadius:"4px",marginBottom:"10px"},children:["分页状态: 已加载 ",G.length," 题, 还有更多: ",z?"是":"否",", 正在加载: ",J?"是":"否"]}),(0,o.jsxs)("div",{ref:O,className:`questions-container ${k}`,style:{height:"calc(100vh - 400px)",overflow:"auto",position:"relative",border:"1px solid #e1e5e9",borderRadius:"8px"},children:[(0,o.jsx)("div",{style:{height:`${X.getTotalSize()}px`,width:"100%",position:"relative"},children:X.getVirtualItems().map(e=>{const s=Z[e.index];return(0,o.jsx)("div",{"data-index":e.index,ref:X.measureElement,style:{position:"absolute",top:0,left:0,width:"100%",transform:`translateY(${e.start}px)`},children:(0,o.jsx)(is,{question:s,index:e.index,isExpanded:C.has(s.id),onToggle:()=>ne(s.id),onDelete:re,onEdit:ie,onUpdateField:le,viewMode:k,isDragging:E===s.id,isDragOver:L===s.id,onDragStart:e=>((e,s)=>{C.size>0||(q(s),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",s),e.currentTarget.style.opacity="0.4")})(e,s.id),onDragOver:e=>((e,s)=>{C.size>0||!E||(e.preventDefault(),e.dataTransfer.dropEffect="move",D(s))})(e,s.id),onDragLeave:de,onDrop:e=>(async(e,s)=>{if(!(C.size>0)&&E){if(e.preventDefault(),E!==s){const e=Z.findIndex(e=>e.id===E),t=Z.findIndex(e=>e.id===s),a=[...Z],[n]=a.splice(e,1);a.splice(t,0,n);try{await te.mutateAsync({questionId:n.id,data:{appearanceLevel:n.appearanceLevel}}),console.log("排序保存成功")}catch(e){console.error("保存排序失败:",e),K()}}q(null),D(null)}})(e,s.id),onDragEnd:he,canDrag:0===C.size,showQuestionForm:h,setShowQuestionForm:x,editingQuestion:p,setEditingQuestion:v})},s.id)})}),z&&(0,o.jsx)("div",{ref:Q,style:{height:"60px",display:"flex",alignItems:"center",justifyContent:"center",position:"relative",background:"transparent"},children:J?(0,o.jsxs)("div",{className:"loading-more",children:[(0,o.jsx)("div",{className:"modern-spinner small"}),(0,o.jsx)("span",{children:"加载更多题目..."})]}):(0,o.jsx)("div",{className:"load-more-trigger",style:{padding:"10px",color:"#666"},children:(0,o.jsx)("span",{children:"↓ 继续滚动加载更多"})})}),!z&&G.length>0&&(0,o.jsxs)("div",{style:{textAlign:"center",padding:"20px",color:"#999",fontStyle:"italic"},children:["已加载全部 ",G.length," 个题目"]})]})]})})}),h&&(0,o.jsx)("div",{className:"form-modal-overlay",style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.6)",display:"flex",justifyContent:"center",alignItems:"center",zIndex:9999,padding:"20px"},children:(0,o.jsx)(ns,{question:p,onSave:()=>{x(!1),v(null),t.invalidateQueries(["questions",e])},onCancel:()=>{x(!1),v(null)},defaultCategoryId:e,onCategoryChange:({questionId:s,oldCategoryId:a,newCategoryId:c,question:i})=>{if(a===n.id){t.invalidateQueries(["questions",e]),S(e=>{const t=new Set(e);return t.delete(s),t});const a=l.find(e=>e.id===c);$(`题目已移动到分类: ${a?.name||"其他分类"}`),setTimeout(()=>$(""),3e3)}}})})]}):(0,o.jsx)("div",{className:"category-detail-page",children:(0,o.jsxs)("div",{className:"error-container",children:[(0,o.jsx)("div",{className:"error-icon",children:"📁"}),(0,o.jsx)("h2",{children:"分类不存在"}),(0,o.jsx)("p",{children:"未找到指定的分类，可能已被删除"}),(0,o.jsx)("button",{onClick:oe,className:"btn-back",children:"返回首页"})]})}):(0,o.jsx)("div",{className:"category-detail-page",children:(0,o.jsxs)("div",{className:"auth-required-container",children:[(0,o.jsx)("div",{className:"auth-required-icon",children:"🔐"}),(0,o.jsx)("h2",{children:"请先登录"}),(0,o.jsx)("p",{children:"登录后即可查看和管理题目"}),(0,o.jsxs)("div",{className:"auth-required-actions",children:[(0,o.jsx)("button",{onClick:()=>window.dispatchEvent(new CustomEvent("showAuthModal")),className:"login-btn",children:"立即登录"}),(0,o.jsx)("button",{onClick:oe,className:"btn-back",children:"返回首页"})]})]})})},ls=async(e,s,t)=>{try{const a=new(u().User);a.setUsername(e),a.setPassword(s),a.setEmail(t);const n=await a.signUp();return console.log("注册成功:",n),n}catch(e){throw console.error("注册失败:",e),e}},os=async(e,s)=>{try{const t=await u().User.logIn(e,s);return console.log("登录成功:",t),t}catch(e){throw console.error("登录失败:",e),e}},ds=()=>u().User.current(),hs=()=>{const[e,s]=(0,a.useState)(null),[t,n]=(0,a.useState)(!1),[c,i]=(0,a.useState)(""),[r,l]=(0,a.useState)({register:{username:"",password:"",email:"",nickname:""},login:{username:"",password:""},category:{name:"",description:""},question:{title:"",detailedAnswer:"",categoryId:""}});(0,a.useEffect)(()=>{d()},[]);const d=()=>{const e=ds();s(e),console.log("当前用户:",e)},h=(e,s,t)=>{l(a=>({...a,[e]:{...a[e],[s]:t}}))};return(0,o.jsxs)("div",{className:"user-test-panel",children:[(0,o.jsx)("h2",{children:"🧪 用户系统测试面板"}),(0,o.jsxs)("div",{className:"user-status",children:[(0,o.jsx)("h3",{children:"当前状态"}),e?(0,o.jsxs)("div",{className:"user-info",children:[(0,o.jsx)("p",{children:"✅ 已登录"}),(0,o.jsxs)("p",{children:["用户名: ",e.username]}),(0,o.jsxs)("p",{children:["邮箱: ",e.email]}),(0,o.jsxs)("p",{children:["用户ID: ",e.id]}),(0,o.jsx)("button",{onClick:async()=>{n(!0);try{await(async()=>{try{await u().User.logOut(),console.log("退出成功")}catch(e){throw console.error("退出失败:",e),e}})(),i("✅ 已退出登录"),s(null)}catch(e){i(`❌ 登出失败: ${e.message}`)}finally{n(!1)}},disabled:t,children:"退出登录"})]}):(0,o.jsx)("p",{children:"❌ 未登录"})]}),c&&(0,o.jsx)("div",{className:"test-message "+(c.includes("✅")?"success":"error"),children:c}),(0,o.jsxs)("div",{className:"test-sections",children:[(0,o.jsxs)("div",{className:"test-section",children:[(0,o.jsx)("h3",{children:"1. 用户注册测试"}),(0,o.jsxs)("form",{onSubmit:async e=>{e.preventDefault(),n(!0),i("");try{const e=await ls(r.register);i(`✅ 注册成功！用户ID: ${e.id}`),s(e),l(e=>({...e,register:{username:"",password:"",email:"",nickname:""}}))}catch(e){i(`❌ 注册失败: ${e.message}`)}finally{n(!1)}},children:[(0,o.jsx)("input",{type:"text",placeholder:"用户名",value:r.register.username,onChange:e=>h("register","username",e.target.value),required:!0}),(0,o.jsx)("input",{type:"password",placeholder:"密码",value:r.register.password,onChange:e=>h("register","password",e.target.value),required:!0}),(0,o.jsx)("input",{type:"email",placeholder:"邮箱",value:r.register.email,onChange:e=>h("register","email",e.target.value),required:!0}),(0,o.jsx)("input",{type:"text",placeholder:"昵称 (可选)",value:r.register.nickname,onChange:e=>h("register","nickname",e.target.value)}),(0,o.jsx)("button",{type:"submit",disabled:t,children:t?"注册中...":"注册"})]})]}),(0,o.jsxs)("div",{className:"test-section",children:[(0,o.jsx)("h3",{children:"2. 用户登录测试"}),(0,o.jsxs)("form",{onSubmit:async e=>{e.preventDefault(),n(!0),i("");try{const e=await os(r.login.username,r.login.password);i(`✅ 登录成功！欢迎 ${e.username}`),s(e),l(e=>({...e,login:{username:"",password:""}}))}catch(e){i(`❌ 登录失败: ${e.message}`)}finally{n(!1)}},children:[(0,o.jsx)("input",{type:"text",placeholder:"用户名",value:r.login.username,onChange:e=>h("login","username",e.target.value),required:!0}),(0,o.jsx)("input",{type:"password",placeholder:"密码",value:r.login.password,onChange:e=>h("login","password",e.target.value),required:!0}),(0,o.jsx)("button",{type:"submit",disabled:t,children:t?"登录中...":"登录"})]})]}),e&&(0,o.jsxs)("div",{className:"test-section",children:[(0,o.jsx)("h3",{children:"3. 创建测试分类"}),(0,o.jsxs)("form",{onSubmit:async s=>{if(s.preventDefault(),e){n(!0);try{const e=await C(r.category);i(`✅ 分类创建成功！ID: ${e.id}`),l(s=>({...s,question:{...s.question,categoryId:e.id},category:{name:"",description:""}}))}catch(e){i(`❌ 创建分类失败: ${e.message}`)}finally{n(!1)}}else i("❌ 请先登录")},children:[(0,o.jsx)("input",{type:"text",placeholder:"分类名称",value:r.category.name,onChange:e=>h("category","name",e.target.value),required:!0}),(0,o.jsx)("input",{type:"text",placeholder:"分类描述 (可选)",value:r.category.description,onChange:e=>h("category","description",e.target.value)}),(0,o.jsx)("button",{type:"submit",disabled:t,children:t?"创建中...":"创建分类"})]})]}),e&&r.question.categoryId&&(0,o.jsxs)("div",{className:"test-section",children:[(0,o.jsx)("h3",{children:"4. 创建测试题目"}),(0,o.jsxs)("p",{children:["分类ID: ",r.question.categoryId]}),(0,o.jsxs)("form",{onSubmit:async s=>{if(s.preventDefault(),e){n(!0);try{const e=await O({...r.question,categoryId:r.question.categoryId,oralAnswer:"这是口述版本的答案",tags:["测试","示例"],difficulty:"medium",proficiency:"intermediate"});i(`✅ 题目创建成功！ID: ${e.id}`),l(e=>({...e,question:{title:"",detailedAnswer:"",categoryId:e.question.categoryId}}))}catch(e){i(`❌ 创建题目失败: ${e.message}`)}finally{n(!1)}}else i("❌ 请先登录")},children:[(0,o.jsx)("input",{type:"text",placeholder:"题目标题",value:r.question.title,onChange:e=>h("question","title",e.target.value),required:!0}),(0,o.jsx)("textarea",{placeholder:"详细答案",value:r.question.detailedAnswer,onChange:e=>h("question","detailedAnswer",e.target.value),required:!0}),(0,o.jsx)("button",{type:"submit",disabled:t,children:t?"创建中...":"创建题目"})]})]})]}),(0,o.jsxs)("div",{className:"quick-test",children:[(0,o.jsx)("h3",{children:"🚀 快速测试"}),(0,o.jsx)("button",{onClick:()=>{l({register:{username:`testuser_${Date.now()}`,password:"123456",email:`test_${Date.now()}@example.com`,nickname:"测试用户"},login:{username:"",password:""},category:{name:"测试分类",description:"这是一个测试分类"},question:{title:"",detailedAnswer:"",categoryId:""}})},children:"填充测试数据"})]})]})},us={setupAdminUser:async()=>{try{console.log("设置当前用户为管理员...");const e=u().User.current();if(!e)throw new Error("请先登录一个账户作为管理员");return console.log("使用当前用户作为管理员:",e.id),{id:e.id,username:e.getUsername(),email:e.getEmail(),nickname:e.get("nickname")}}catch(e){throw console.error("设置管理员失败:",e),e}},migrateCategoriesToCurrentUser:async()=>{try{console.log("开始迁移分类数据...");const e=u().User.current();if(!e)throw new Error("用户未登录");const s=new(u().Query)("Category");s.doesNotExist("createdBy");const t=await s.find();console.log(`找到 ${t.length} 个需要迁移的分类`);let a=0;for(const s of t)try{s.set("createdBy",e);const t=new(u().ACL);t.setReadAccess(e,!0),t.setWriteAccess(e,!0),t.setPublicReadAccess(!0),s.setACL(t),await s.save(),a++,console.log(`✅ 迁移分类: ${s.get("name")}`)}catch(e){console.error(`迁移分类失败 ${s.id}:`,e)}return console.log(`分类迁移完成: ${a}/${t.length}`),{migrated:a,total:t.length}}catch(e){throw console.error("迁移分类数据失败:",e),e}},migrateQuestionsToCurrentUser:async()=>{try{console.log("开始迁移题目数据...");const e=u().User.current();if(!e)throw new Error("用户未登录");const s=new(u().Query)("Question");s.doesNotExist("createdBy");const t=await s.find();console.log(`找到 ${t.length} 个需要迁移的题目`);let a=0;for(const s of t)try{s.set("createdBy",e);const t=new(u().ACL);t.setReadAccess(e,!0),t.setWriteAccess(e,!0),t.setPublicReadAccess(!0),s.setACL(t),await s.save(),a++,console.log(`✅ 迁移题目: ${s.get("title")}`)}catch(e){console.error(`迁移题目失败 ${s.id}:`,e)}return console.log(`题目迁移完成: ${a}/${t.length}`),{migrated:a,total:t.length}}catch(e){throw console.error("迁移题目数据失败:",e),e}},performFullMigration:async()=>{try{console.log("🚀 开始完整数据迁移...");const e=await us.setupAdminUser(),s=await us.migrateCategoriesToCurrentUser(),t=await us.migrateQuestionsToCurrentUser();return console.log("🎉 数据迁移完成！"),{success:!0,adminUser:e,categories:s,questions:t,message:`迁移完成: ${s.migrated}个分类, ${t.migrated}个题目`}}catch(e){return console.error("数据迁移失败:",e),{success:!1,error:e.message}}},checkMigrationStatus:async()=>{try{const e=new(u().Query)("Category");e.doesNotExist("createdBy");const s=await e.count(),t=new(u().Query)("Question");t.doesNotExist("createdBy");const a=await t.count();return{orphanCategories:s,orphanQuestions:a,totalCategories:await new(u().Query)("Category").count(),totalQuestions:await new(u().Query)("Question").count(),migrationNeeded:s>0||a>0}}catch(e){throw console.error("检查迁移状态失败:",e),e}},migrateQuestionCreatedBy:async()=>{try{console.log("开始专门迁移 Question 的 createdBy 属性...");const e=u().User.current();if(!e)throw new Error("用户未登录");const s=new(u().Query)("Question");s.doesNotExist("createdBy");const t=await s.find();console.log(`找到 ${t.length} 个需要添加 createdBy 的题目`);let a=0;for(const s of t)try{s.set("createdBy",e);const t=new(u().ACL);t.setReadAccess(e,!0),t.setWriteAccess(e,!0),t.setPublicReadAccess(!1),s.setACL(t),await s.save(),a++,console.log(`✅ 为题目添加 createdBy: ${s.get("title")}`)}catch(e){console.error(`迁移题目失败 ${s.id}:`,e)}return console.log(`Question createdBy 迁移完成: ${a}/${t.length}`),{migrated:a,total:t.length}}catch(e){throw console.error("迁移 Question createdBy 失败:",e),e}},performQuestionMigrationOnly:async()=>{try{if(console.log("🚀 开始专门迁移 Question 数据..."),!u().User.current())throw new Error("请先登录");const e=await us.migrateQuestionCreatedBy();return console.log("🎉 Question 迁移完成！"),{success:!0,questions:e,message:`Question 迁移完成: ${e.migrated}个题目`}}catch(e){return console.error("Question 迁移失败:",e),{success:!1,error:e.message}}}},ms=()=>{const[e,s]=(0,a.useState)(!1),[t,n]=(0,a.useState)(null),[c,i]=(0,a.useState)(null),[r,l]=(0,a.useState)(null);(0,a.useEffect)(()=>{d(),h()},[]);const d=()=>{const e=ds();l(e)},h=async()=>{try{const e=await us.checkMigrationStatus();n(e)}catch(e){console.error("检查迁移状态失败:",e)}};return(0,o.jsxs)("div",{className:"data-migration-panel",children:[(0,o.jsx)("h2",{children:"🔄 数据迁移工具"}),(0,o.jsx)("p",{children:"将现有分类和题目数据关联到当前登录用户"}),(0,o.jsxs)("div",{className:"user-status-section",children:[(0,o.jsx)("h3",{children:"当前用户状态"}),r?(0,o.jsxs)("div",{className:"user-info",children:[(0,o.jsxs)("p",{children:["✅ 已登录: ",(0,o.jsx)("strong",{children:r.username})]}),(0,o.jsxs)("p",{children:["邮箱: ",r.email]}),(0,o.jsxs)("p",{children:["用户ID: ",r.id]}),(0,o.jsx)("p",{className:"admin-note",children:"此用户将被设置为所有现有数据的管理员"})]}):(0,o.jsxs)("div",{className:"user-info not-logged-in",children:[(0,o.jsx)("p",{children:"❌ 未登录"}),(0,o.jsx)("p",{className:"login-required",children:"请先登录一个账户作为管理员"})]})]}),t&&(0,o.jsxs)("div",{className:"migration-status",children:[(0,o.jsx)("h3",{children:"当前数据状态"}),(0,o.jsxs)("div",{className:"status-grid",children:[(0,o.jsxs)("div",{className:"status-item",children:[(0,o.jsx)("span",{className:"label",children:"总分类数:"}),(0,o.jsx)("span",{className:"value",children:t.totalCategories})]}),(0,o.jsxs)("div",{className:"status-item",children:[(0,o.jsx)("span",{className:"label",children:"总题目数:"}),(0,o.jsx)("span",{className:"value",children:t.totalQuestions})]}),(0,o.jsxs)("div",{className:"status-item warning",children:[(0,o.jsx)("span",{className:"label",children:"未关联分类:"}),(0,o.jsx)("span",{className:"value",children:t.orphanCategories})]}),(0,o.jsxs)("div",{className:"status-item warning",children:[(0,o.jsx)("span",{className:"label",children:"未关联题目:"}),(0,o.jsx)("span",{className:"value",children:t.orphanQuestions})]})]}),t.migrationNeeded?(0,o.jsx)("div",{className:"migration-needed",children:"⚠️ 检测到未关联的数据，需要执行迁移"}):(0,o.jsx)("div",{className:"migration-complete",children:"✅ 所有数据都已关联到用户"})]}),(0,o.jsxs)("div",{className:"migration-actions",children:[(0,o.jsx)("button",{onClick:async()=>{if(r){if(window.confirm(`确定要将所有现有数据关联到当前用户 "${r.username}" 吗？`)){s(!0),i(null);try{const e=await us.performFullMigration();i(e),await h()}catch(e){i({success:!1,error:e.message})}finally{s(!1)}}}else alert("请先登录一个账户作为管理员")},disabled:e||!r||!t?.migrationNeeded,className:"migrate-btn",children:e?"迁移中...":"执行数据迁移"}),(0,o.jsx)("button",{onClick:h,disabled:e,className:"refresh-btn",children:"刷新状态"})]}),c&&(0,o.jsxs)("div",{className:"migration-result "+(c.success?"success":"error"),children:[(0,o.jsx)("h4",{children:c.success?"✅ 迁移成功":"❌ 迁移失败"}),c.success?(0,o.jsxs)("div",{children:[(0,o.jsx)("p",{children:c.message}),c.adminUser&&(0,o.jsxs)("div",{className:"admin-info",children:[(0,o.jsxs)("p",{children:[(0,o.jsx)("strong",{children:"管理员账户:"})," ",c.adminUser.username]}),(0,o.jsxs)("p",{children:[(0,o.jsx)("strong",{children:"用户ID:"})," ",c.adminUser.id]})]})]}):(0,o.jsxs)("p",{children:["错误: ",c.error]})]}),(0,o.jsxs)("div",{className:"migration-instructions",children:[(0,o.jsx)("h3",{children:"📖 使用说明"}),(0,o.jsxs)("ol",{children:[(0,o.jsxs)("li",{children:[(0,o.jsx)("strong",{children:"首先登录一个账户"}),"（可以是新注册的或现有的）"]}),(0,o.jsx)("li",{children:"确认上方显示有未关联的数据"}),(0,o.jsx)("li",{children:'点击"执行数据迁移"按钮'}),(0,o.jsx)("li",{children:"迁移完成后，所有现有数据将关联到当前登录用户"}),(0,o.jsx)("li",{children:"之后可以使用此账户登录系统管理所有数据"})]}),(0,o.jsxs)("div",{className:"important-notes",children:[(0,o.jsx)("h4",{children:"⚠️ 重要提示"}),(0,o.jsxs)("ul",{children:[(0,o.jsx)("li",{children:"迁移过程不会删除或修改现有数据内容"}),(0,o.jsx)("li",{children:"只会添加 createdBy 字段和更新权限"}),(0,o.jsx)("li",{children:"迁移后，只有当前用户可以看到所有现有数据"}),(0,o.jsx)("li",{children:"新注册的用户只能看到自己创建的数据"}),(0,o.jsx)("li",{children:(0,o.jsx)("strong",{children:"建议使用一个专门的账户作为管理员"})})]})]})]})]})},gs=()=>(0,o.jsx)("div",{className:"test-page",children:(0,o.jsxs)("div",{className:"container",children:[(0,o.jsx)("h1",{children:"用户系统测试与数据迁移"}),(0,o.jsxs)("div",{className:"test-sections",children:[(0,o.jsxs)("section",{className:"test-section",children:[(0,o.jsx)("h2",{children:"🔄 数据迁移"}),(0,o.jsx)(ms,{})]}),(0,o.jsxs)("section",{className:"test-section",children:[(0,o.jsx)("h2",{children:"🧪 用户功能测试"}),(0,o.jsx)(hs,{})]})]})]})}),xs=({onShowAuthModal:e})=>{const[s,t]=(0,a.useState)(null),[n,i]=(0,a.useState)(!1),r=(0,a.useRef)(null);(0,a.useEffect)(()=>{const e=u().User.current();t(e)},[]),(0,a.useEffect)(()=>{const e=e=>{r.current&&!r.current.contains(e.target)&&i(!1)};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[]),(0,a.useEffect)(()=>{const e=async()=>{console.log("收到头像更新事件，重新加载用户数据");const e=u().User.current();if(e)try{const s=await e.fetch();t(s)}catch(e){console.error("重新加载用户数据失败:",e)}};return window.addEventListener("userAvatarUpdated",e),()=>{window.removeEventListener("userAvatarUpdated",e)}},[]);const l=()=>!!s&&"wu1149823510@outlook.com"===s.getEmail(),d=({user:e,size:s="normal"})=>{const t=e.get("avatar"),a=e.getUsername()?.charAt(0).toUpperCase(),n=(()=>{if(!t)return null;if("string"==typeof t){const e=(new Date).getTime();return`${t}?t=${e}`}return"function"==typeof t.get?t.get("url"):null})();return(0,o.jsx)("div",{className:"user-avatar "+("large"===s?"user-avatar-large":""),children:n?(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("img",{src:n,alt:"用户头像",onLoad:()=>console.log("✅ Navigation 头像加载成功"),onError:e=>{console.error("❌ Navigation 头像加载失败:",n),e.target.style.display="none";const s=e.target.nextSibling;s&&(s.style.display="flex")},style:{width:"100%",height:"100%",objectFit:"cover",objectPosition:"center"}}),(0,o.jsx)("div",{className:"avatar-fallback "+("large"===s?"avatar-fallback-large":""),style:{display:"none"},children:a})]}):(0,o.jsx)("div",{className:"avatar-fallback "+("large"===s?"avatar-fallback-large":""),children:a})})};return(0,o.jsx)("nav",{className:"modern-nav",children:(0,o.jsxs)("div",{className:"nav-container",children:[(0,o.jsxs)("div",{className:"nav-left",children:[(0,o.jsxs)(c.N_,{to:"/",className:"nav-brand",children:[(0,o.jsx)("span",{className:"brand-icon",children:"📚"}),(0,o.jsx)("span",{className:"brand-text",children:"知识题库"})]}),(0,o.jsxs)("div",{className:"nav-links",children:[(0,o.jsxs)(c.N_,{to:"/",className:"nav-link",children:[(0,o.jsx)("span",{className:"link-icon",children:"🏠"}),"首页"]}),s&&l()&&(0,o.jsxs)(c.N_,{to:"/init",className:"nav-link",children:[(0,o.jsx)("span",{className:"link-icon",children:"⚙️"}),"初始化数据库"]})]})]}),(0,o.jsx)("div",{className:"nav-right",children:s?(0,o.jsxs)("div",{className:"user-section",ref:r,children:[(0,o.jsxs)("button",{className:"user-menu-trigger",onClick:()=>{i(!n)},children:[(0,o.jsx)(d,{user:s}),(0,o.jsx)("span",{className:"user-name",children:s.getUsername()}),l()&&(0,o.jsx)("span",{className:"admin-badge",title:"管理员",children:"⚡"}),(0,o.jsx)("span",{className:"dropdown-arrow "+(n?"open":""),children:"▼"})]}),n&&(0,o.jsxs)("div",{className:"user-dropdown-menu",children:[(0,o.jsx)("div",{className:"dropdown-header",children:(0,o.jsxs)("div",{className:"user-info-card",children:[(0,o.jsx)(d,{user:s,size:"large"}),(0,o.jsxs)("div",{className:"user-details",children:[(0,o.jsxs)("div",{className:"user-display-name",children:[s.get("nickname")||s.getUsername(),l()&&(0,o.jsx)("span",{className:"admin-tag",children:"管理员"})]}),(0,o.jsx)("div",{className:"user-email",children:s.getEmail()||"未设置邮箱"})]})]})}),(0,o.jsx)("div",{className:"dropdown-divider"}),(0,o.jsxs)("div",{className:"dropdown-items",children:[(0,o.jsxs)("button",{className:"dropdown-item",onClick:()=>{i(!1),window.dispatchEvent(new CustomEvent("showUserSettings"))},children:[(0,o.jsx)("span",{className:"item-icon",children:"👤"}),(0,o.jsx)("span",{className:"item-text",children:"账户设置"})]}),(0,o.jsxs)("button",{className:"dropdown-item",onClick:()=>{i(!1),window.dispatchEvent(new CustomEvent("showUserSettings",{detail:{tab:"stats"}}))},children:[(0,o.jsx)("span",{className:"item-icon",children:"📊"}),(0,o.jsx)("span",{className:"item-text",children:"学习统计"})]}),(0,o.jsxs)("button",{className:"dropdown-item",onClick:()=>{i(!1),window.dispatchEvent(new CustomEvent("showUserSettings",{detail:{tab:"preferences"}}))},children:[(0,o.jsx)("span",{className:"item-icon",children:"🔔"}),(0,o.jsx)("span",{className:"item-text",children:"通知设置"})]})]}),l()&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("div",{className:"dropdown-divider"}),(0,o.jsxs)("div",{className:"dropdown-section",children:[(0,o.jsx)("div",{className:"section-label",children:"管理员功能"}),(0,o.jsxs)("div",{className:"dropdown-items",children:[(0,o.jsxs)(c.N_,{to:"/init",className:"dropdown-item",onClick:()=>i(!1),children:[(0,o.jsx)("span",{className:"item-icon",children:"⚙️"}),(0,o.jsx)("span",{className:"item-text",children:"初始化数据库"})]}),(0,o.jsxs)("button",{className:"dropdown-item",onClick:()=>{i(!1),console.log("管理员功能")},children:[(0,o.jsx)("span",{className:"item-icon",children:"🔧"}),(0,o.jsx)("span",{className:"item-text",children:"系统管理"})]})]})]})]}),(0,o.jsx)("div",{className:"dropdown-divider"}),(0,o.jsxs)("div",{className:"dropdown-items",children:[(0,o.jsxs)("button",{className:"dropdown-item",onClick:()=>{i(!1),window.open("/help","_blank")},children:[(0,o.jsx)("span",{className:"item-icon",children:"❓"}),(0,o.jsx)("span",{className:"item-text",children:"帮助文档"})]}),(0,o.jsxs)("button",{className:"dropdown-item",onClick:()=>{i(!1),window.open("mailto:support@example.com","_blank")},children:[(0,o.jsx)("span",{className:"item-icon",children:"💬"}),(0,o.jsx)("span",{className:"item-text",children:"意见反馈"})]})]}),(0,o.jsx)("div",{className:"dropdown-divider"}),(0,o.jsx)("div",{className:"dropdown-items",children:(0,o.jsxs)("button",{className:"dropdown-item logout-item",onClick:async()=>{try{await u().User.logOut(),t(null),i(!1),window.location.reload()}catch(e){console.error("退出失败:",e),alert("退出失败，请重试")}},children:[(0,o.jsx)("span",{className:"item-icon",children:"🚪"}),(0,o.jsx)("span",{className:"item-text",children:"退出登录"})]})})]})]}):(0,o.jsxs)("div",{className:"auth-buttons",children:[(0,o.jsx)("button",{className:"auth-btn login-btn",onClick:()=>e("login"),children:"登录"}),(0,o.jsx)("button",{className:"auth-btn login-btn",onClick:()=>e("register"),children:"注册"})]})})]})})},js=({isOpen:e,onClose:s,defaultTab:t="login",onAuthSuccess:n})=>{const[c,i]=(0,a.useState)(t),[r,l]=(0,a.useState)({loginUsername:"",loginPassword:"",registerUsername:"",registerEmail:"",registerPassword:"",registerConfirmPassword:""}),[d,h]=(0,a.useState)(!1);(0,a.useEffect)(()=>{e&&(i(t),l({loginUsername:"",loginPassword:"",registerUsername:"",registerEmail:"",registerPassword:"",registerConfirmPassword:""}))},[e,t]);const u=e=>{const{id:s,value:t}=e.target;l(e=>({...e,[s]:t}))};return e?(0,o.jsx)("div",{className:"auth-modal",onClick:s,children:(0,o.jsxs)("div",{className:"auth-content",onClick:e=>e.stopPropagation(),children:[(0,o.jsxs)("div",{className:"auth-header",children:[(0,o.jsx)("h3",{children:"login"===c?"用户登录":"用户注册"}),(0,o.jsx)("button",{className:"close-btn",onClick:s,children:"×"})]}),(0,o.jsxs)("div",{className:"auth-tabs",children:[(0,o.jsx)("button",{className:"auth-tab "+("login"===c?"active":""),onClick:()=>i("login"),children:"登录"}),(0,o.jsx)("button",{className:"auth-tab "+("register"===c?"active":""),onClick:()=>i("register"),children:"注册"})]}),(0,o.jsxs)("form",{className:"auth-form "+("login"===c?"active":""),onSubmit:async e=>{e.preventDefault();try{await os(r.loginUsername,r.loginPassword),n&&n(),s()}catch(e){alert(`登录失败: ${e.message}`)}},children:[(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsx)("label",{htmlFor:"loginUsername",children:"用户名"}),(0,o.jsx)("input",{type:"text",id:"loginUsername",value:r.loginUsername,onChange:u,required:!0})]}),(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsx)("label",{htmlFor:"loginPassword",children:"密码"}),(0,o.jsx)("input",{type:"password",id:"loginPassword",value:r.loginPassword,onChange:u,required:!0})]}),(0,o.jsx)("button",{type:"submit",className:"auth-btn primary",children:"登录"})]}),(0,o.jsxs)("form",{className:"auth-form "+("register"===c?"active":""),onSubmit:async e=>{if(e.preventDefault(),r.registerPassword===r.registerConfirmPassword)try{await ls(r.registerUsername,r.registerPassword,r.registerEmail),n&&n(),s()}catch(e){alert(`注册失败: ${e.message}`)}else alert("两次输入的密码不一致")},children:[(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsx)("label",{htmlFor:"registerUsername",children:"用户名"}),(0,o.jsx)("input",{type:"text",id:"registerUsername",value:r.registerUsername,onChange:u,required:!0})]}),(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsx)("label",{htmlFor:"registerEmail",children:"邮箱"}),(0,o.jsx)("input",{type:"email",id:"registerEmail",value:r.registerEmail,onChange:u,required:!0})]}),(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsx)("label",{htmlFor:"registerPassword",children:"密码"}),(0,o.jsx)("input",{type:"password",id:"registerPassword",value:r.registerPassword,onChange:u,required:!0})]}),(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsx)("label",{htmlFor:"registerConfirmPassword",children:"确认密码"}),(0,o.jsx)("input",{type:"password",id:"registerConfirmPassword",value:r.registerConfirmPassword,onChange:u,required:!0})]}),(0,o.jsx)("button",{type:"submit",className:"auth-btn secondary",children:"注册"})]})]})}):null},ps=({isOpen:e,onClose:s})=>{const[t,n]=(0,a.useState)(null),[c,i]=(0,a.useState)("profile"),[r,l]=(0,a.useState)(!1),[d,h]=(0,a.useState)(!1),[m,g]=(0,a.useState)({type:"",text:""}),[x,j]=(0,a.useState)(null),[p,v]=(0,a.useState)(""),[N,y]=(0,a.useState)({totalCategories:0,totalQuestions:0,reviewQuestions:0,todayReviewed:0}),[f,w]=(0,a.useState)({username:"",email:"",nickname:"",bio:""}),[b,C]=(0,a.useState)({currentPassword:"",newPassword:"",confirmPassword:""}),[S,k]=(0,a.useState)({theme:"light",language:"zh-CN",notifications:!0,emailUpdates:!1}),[A,E]=(0,a.useState)({emailVerified:!1});(0,a.useEffect)(()=>{if(e){const e=u().User.current();n(e),e&&(q(e),L(e))}},[e]);const q=async e=>{try{const s=await e.fetch();w({username:s.getUsername()||"",email:s.getEmail()||"",nickname:s.get("nickname")||"",bio:s.get("bio")||""}),k({theme:s.get("theme")||"light",language:s.get("language")||"zh-CN",notifications:!1!==s.get("notifications"),emailUpdates:s.get("emailUpdates")||!1}),E({emailVerified:s.get("emailVerified")||!1});const t=s.get("avatar");if(t&&"string"==typeof t){const e=(new Date).getTime();v(`${t}?t=${e}`)}else v("")}catch(e){console.error("加载用户数据失败:",e)}},L=async e=>{try{const s=new(u().Query)("Category");s.equalTo("createdBy",e);const t=await s.find(),a=new(u().Query)("Question");a.equalTo("createdBy",e);const n=await a.find(),c=new Date,i=1,r=n.filter(e=>{const s=new Date(e.get("lastReviewedAt")||e.get("createdAt"));return Math.floor((c-s)/864e5)>=i}),l=new Date;l.setHours(0,0,0,0);const o=n.filter(e=>new Date(e.get("lastReviewedAt"))>=l).length;y({totalCategories:t.length,totalQuestions:n.length,reviewQuestions:r.length,todayReviewed:o})}catch(e){console.error("加载学习统计失败:",e),y({totalCategories:0,totalQuestions:0,reviewQuestions:0,todayReviewed:0})}},D=(e,s,t=3e3)=>{g({type:e,text:s}),setTimeout(()=>g({type:"",text:""}),t)},T=(e,s,t)=>{switch(e){case"profile":w(e=>({...e,[s]:t}));break;case"password":C(e=>({...e,[s]:t}));break;case"preferences":k(e=>({...e,[s]:t}))}};return e?(0,o.jsx)("div",{className:"user-settings-overlay",children:(0,o.jsxs)("div",{className:"user-settings-modal",children:[(0,o.jsxs)("div",{className:"settings-header",children:[(0,o.jsxs)("div",{className:"header-content",children:[(0,o.jsx)("h2",{children:"账户设置"}),(0,o.jsx)("p",{children:"管理您的账户信息和偏好设置"})]}),(0,o.jsx)("button",{className:"close-button",onClick:s,disabled:d,children:"×"})]}),m.text&&(0,o.jsx)("div",{className:`message ${m.type}`,children:m.text}),(0,o.jsxs)("div",{className:"settings-content",children:[(0,o.jsxs)("div",{className:"settings-sidebar",children:[(0,o.jsxs)("button",{className:"sidebar-item "+("profile"===c?"active":""),onClick:()=>i("profile"),children:[(0,o.jsx)("span",{className:"item-icon",children:"👤"}),(0,o.jsx)("span",{className:"item-text",children:"个人信息"})]}),(0,o.jsxs)("button",{className:"sidebar-item "+("security"===c?"active":""),onClick:()=>i("security"),children:[(0,o.jsx)("span",{className:"item-icon",children:"🔒"}),(0,o.jsx)("span",{className:"item-text",children:"安全设置"})]}),(0,o.jsxs)("button",{className:"sidebar-item "+("preferences"===c?"active":""),onClick:()=>i("preferences"),children:[(0,o.jsx)("span",{className:"item-icon",children:"⚙️"}),(0,o.jsx)("span",{className:"item-text",children:"偏好设置"})]}),(0,o.jsxs)("button",{className:"sidebar-item "+("data"===c?"active":""),onClick:()=>i("data"),children:[(0,o.jsx)("span",{className:"item-icon",children:"📊"}),(0,o.jsx)("span",{className:"item-text",children:"学习统计"})]})]}),(0,o.jsxs)("div",{className:"settings-main",children:["profile"===c&&(0,o.jsxs)("div",{className:"tab-content",children:[(0,o.jsx)("h3",{children:"个人信息"}),(0,o.jsxs)("div",{className:"avatar-section",children:[(0,o.jsxs)("div",{className:"avatar-upload",children:[(0,o.jsx)("div",{className:"avatar-preview",children:p?(0,o.jsx)("img",{src:p,alt:"头像预览",style:{width:"100%",height:"100%",objectFit:"cover",objectPosition:"center"},onLoad:()=>console.log("✅ 头像预览加载成功"),onError:e=>{console.error("❌ 头像预览加载失败:",p),e.target.style.display="none"}}):(0,o.jsx)("div",{className:"avatar-placeholder",children:f.username?.charAt(0).toUpperCase()})}),(0,o.jsxs)("div",{className:"avatar-controls",children:[(0,o.jsx)("input",{type:"file",id:"avatar-upload",accept:"image/*",onChange:e=>{const s=e.target.files[0];if(!s)return;if(!s.type.startsWith("image/"))return void D("error","请选择图片文件（JPG、PNG、GIF）");if(s.size>2097152)return void D("error","图片大小不能超过 2MB");j(s);const t=new FileReader;t.onload=e=>{v(e.target.result)},t.readAsDataURL(s)},className:"avatar-input"}),(0,o.jsx)("label",{htmlFor:"avatar-upload",className:"avatar-upload-btn",children:"选择图片"}),x&&(0,o.jsx)("button",{className:"avatar-save-btn",onClick:async()=>{if(x&&t){h(!0);try{v("");const e=await new Promise((e,s)=>{const t=new FileReader;t.onload=s=>{const t=s.target.result.split(",")[1];e(t)},t.onerror=()=>s(new Error("文件读取失败")),t.readAsDataURL(x)}),s=await u().Cloud.run("updateUserAvatar",{fileData:e,fileName:x.name,mimeType:x.type});if(!s.success)throw new Error(s.message||"头像上传失败");{D("success","头像上传成功！");const e=(new Date).getTime(),t=`${s.avatarUrl}?t=${e}`;console.log("设置带时间戳的头像URL:",t),v(t),j(null),setTimeout(async()=>{try{const e=await u().User.current().fetch();n(e),console.log("用户数据已更新"),window.dispatchEvent(new CustomEvent("userAvatarUpdated"))}catch(e){console.error("获取更新后的用户数据失败:",e)}},1e3)}}catch(e){console.error("❌ 头像上传失败:",e),D("error",`上传失败: ${e.message}`)}finally{h(!1)}}else D("error","请先选择图片")},disabled:d,children:d?"上传中...":"保存头像"})]})]}),(0,o.jsx)("div",{className:"avatar-hint",children:"支持 JPG、PNG 格式，大小不超过 2MB"})]}),(0,o.jsxs)("form",{onSubmit:async e=>{if(e.preventDefault(),t){h(!0);try{console.log("开始更新个人信息...",{nickname:f.nickname,bio:f.bio});const e=await u().Cloud.run("updateUserProfile",{nickname:f.nickname,bio:f.bio});if(!e.success)throw new Error(e.message||"更新失败");D("success","个人信息更新成功！"),setTimeout(async()=>{try{const e=await u().User.current().fetch();n(e),console.log("用户数据已更新")}catch(e){console.error("获取更新后的用户数据失败:",e)}},500)}catch(e){console.error("更新个人信息失败:",e);let s="更新失败，请重试";s=401===e.code?"请先登录":e.message.includes("network")?"网络连接失败，请检查网络":`更新失败: ${e.message}`,D("error",s)}finally{h(!1)}}},className:"settings-form",children:[(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsx)("label",{children:"用户名"}),(0,o.jsx)("input",{type:"text",value:f.username,disabled:!0,className:"disabled-input"}),(0,o.jsx)("div",{className:"field-hint",children:"用户名创建后不可修改"})]}),(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsx)("label",{children:"邮箱地址"}),(0,o.jsx)("input",{type:"email",value:f.email,disabled:!0,className:"disabled-input"}),(0,o.jsx)("div",{className:"field-hint",children:f.email?"邮箱已验证":"未设置邮箱"})]}),(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsx)("label",{children:"昵称"}),(0,o.jsx)("input",{type:"text",value:f.nickname,onChange:e=>T("profile","nickname",e.target.value),placeholder:"请输入您的昵称",maxLength:20})]}),(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsx)("label",{children:"个人简介"}),(0,o.jsx)("textarea",{value:f.bio,onChange:e=>T("profile","bio",e.target.value),placeholder:"介绍一下您自己...",rows:"3",maxLength:200}),(0,o.jsxs)("div",{className:"char-count",children:[f.bio.length,"/200"]})]}),(0,o.jsx)("div",{className:"form-actions",children:(0,o.jsx)("button",{type:"submit",className:"save-button",disabled:d,children:d?"保存中...":"保存更改"})})]})]}),"security"===c&&(0,o.jsxs)("div",{className:"tab-content",children:[(0,o.jsx)("h3",{children:"安全设置"}),(0,o.jsxs)("div",{className:"security-section",children:[(0,o.jsx)("h4",{children:"邮箱验证"}),(0,o.jsxs)("div",{className:"security-item",children:[(0,o.jsxs)("div",{className:"security-info",children:[(0,o.jsx)("span",{className:"security-label",children:"邮箱状态"}),(0,o.jsx)("span",{className:"security-status "+(A.emailVerified?"verified":"unverified"),children:A.emailVerified?"已验证":"未验证"})]}),!A.emailVerified&&(0,o.jsx)("button",{className:"security-action-btn",onClick:async()=>{if(t&&t.getEmail()){l(!0);try{await u().User.requestEmailVerify(t.getEmail()),D("success","验证邮件已发送，请检查您的邮箱")}catch(e){console.error("发送验证邮件失败:",e),D("error",`发送验证邮件失败: ${e.message}`)}finally{l(!1)}}else D("error","请先设置邮箱地址")},disabled:r||!f.email,children:r?"发送中...":"发送验证邮件"})]})]}),(0,o.jsxs)("div",{className:"security-section",children:[(0,o.jsx)("h4",{children:"修改密码"}),(0,o.jsxs)("form",{onSubmit:async e=>{if(e.preventDefault(),b.newPassword===b.confirmPassword)if(b.newPassword.length<6)D("error","新密码至少需要6位字符");else{h(!0);try{await t.updatePassword(b.currentPassword,b.newPassword),D("success","密码修改成功！"),C({currentPassword:"",newPassword:"",confirmPassword:""})}catch(e){console.error("修改密码失败:",e),D("error",`密码修改失败: ${e.message}`)}finally{h(!1)}}else D("error","新密码和确认密码不一致")},className:"settings-form",children:[(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsx)("label",{children:"当前密码"}),(0,o.jsx)("input",{type:"password",value:b.currentPassword,onChange:e=>T("password","currentPassword",e.target.value),placeholder:"请输入当前密码",required:!0})]}),(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsx)("label",{children:"新密码"}),(0,o.jsx)("input",{type:"password",value:b.newPassword,onChange:e=>T("password","newPassword",e.target.value),placeholder:"请输入新密码（至少6位）",minLength:6,required:!0})]}),(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsx)("label",{children:"确认新密码"}),(0,o.jsx)("input",{type:"password",value:b.confirmPassword,onChange:e=>T("password","confirmPassword",e.target.value),placeholder:"请再次输入新密码",minLength:6,required:!0})]}),(0,o.jsxs)("div",{className:"password-strength",children:[(0,o.jsx)("div",{className:"strength-bar",children:(0,o.jsx)("div",{className:"strength-fill "+(b.newPassword.length>=6?"strong":"weak"),style:{width:`${Math.min(b.newPassword.length/6*100,100)}%`}})}),(0,o.jsx)("div",{className:"strength-text",children:b.newPassword.length>=6?"密码强度足够":"密码至少需要6位"})]}),(0,o.jsx)("div",{className:"form-actions",children:(0,o.jsx)("button",{type:"submit",className:"save-button",disabled:d,children:d?"更新中...":"修改密码"})})]})]}),(0,o.jsxs)("div",{className:"security-section",children:[(0,o.jsx)("h4",{children:"密码重置"}),(0,o.jsxs)("div",{className:"security-item",children:[(0,o.jsxs)("div",{className:"security-info",children:[(0,o.jsx)("span",{className:"security-label",children:"忘记密码？"}),(0,o.jsx)("span",{className:"security-description",children:"通过邮箱重置您的密码"})]}),(0,o.jsx)("button",{className:"security-action-btn secondary",onClick:async()=>{if(t&&t.getEmail()){l(!0);try{await u().User.requestPasswordReset(t.getEmail()),D("success","密码重置邮件已发送，请检查您的邮箱")}catch(e){console.error("发送重置邮件失败:",e),D("error",`发送重置邮件失败: ${e.message}`)}finally{l(!1)}}else D("error","请先设置邮箱地址")},disabled:r||!f.email,children:r?"发送中...":"发送重置邮件"})]})]})]}),"preferences"===c&&(0,o.jsxs)("div",{className:"tab-content",children:[(0,o.jsx)("h3",{children:"偏好设置"}),(0,o.jsxs)("form",{onSubmit:async e=>{if(e.preventDefault(),t){h(!0);try{console.log("开始更新偏好设置...",S);const e=await u().Cloud.run("updateUserPreferences",{theme:S.theme,language:S.language,notifications:S.notifications,emailUpdates:S.emailUpdates});if(!e.success)throw new Error(e.message||"更新失败");D("success","偏好设置更新成功！"),setTimeout(async()=>{try{const e=await u().User.current().fetch();n(e)}catch(e){console.error("获取更新后的用户数据失败:",e)}},500)}catch(e){console.error("更新偏好设置失败:",e),D("error",`更新失败: ${e.message}`)}finally{h(!1)}}},className:"settings-form",children:[(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsx)("label",{children:"主题模式"}),(0,o.jsxs)("div",{className:"radio-group",children:[(0,o.jsxs)("label",{className:"radio-option",children:[(0,o.jsx)("input",{type:"radio",name:"theme",value:"light",checked:"light"===S.theme,onChange:e=>T("preferences","theme",e.target.value)}),(0,o.jsxs)("span",{className:"radio-label",children:[(0,o.jsx)("span",{className:"radio-icon",children:"🌞"}),"浅色模式"]})]}),(0,o.jsxs)("label",{className:"radio-option",children:[(0,o.jsx)("input",{type:"radio",name:"theme",value:"dark",checked:"dark"===S.theme,onChange:e=>T("preferences","theme",e.target.value)}),(0,o.jsxs)("span",{className:"radio-label",children:[(0,o.jsx)("span",{className:"radio-icon",children:"🌙"}),"深色模式"]})]})]})]}),(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsx)("label",{children:"语言"}),(0,o.jsxs)("select",{value:S.language,onChange:e=>T("preferences","language",e.target.value),children:[(0,o.jsx)("option",{value:"zh-CN",children:"简体中文"}),(0,o.jsx)("option",{value:"en-US",children:"English"})]})]}),(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsx)("label",{children:"通知设置"}),(0,o.jsxs)("div",{className:"switch-group",children:[(0,o.jsxs)("label",{className:"switch",children:[(0,o.jsx)("input",{type:"checkbox",checked:S.notifications,onChange:e=>T("preferences","notifications",e.target.checked)}),(0,o.jsx)("span",{className:"slider"})]}),(0,o.jsx)("span",{className:"switch-label",children:"启用浏览器通知"})]})]}),(0,o.jsxs)("div",{className:"form-group",children:[(0,o.jsx)("label",{children:"邮件更新"}),(0,o.jsxs)("div",{className:"switch-group",children:[(0,o.jsxs)("label",{className:"switch",children:[(0,o.jsx)("input",{type:"checkbox",checked:S.emailUpdates,onChange:e=>T("preferences","emailUpdates",e.target.checked)}),(0,o.jsx)("span",{className:"slider"})]}),(0,o.jsx)("span",{className:"switch-label",children:"接收产品更新邮件"})]})]}),(0,o.jsx)("div",{className:"form-actions",children:(0,o.jsx)("button",{type:"submit",className:"save-button",disabled:d,children:d?"保存中...":"保存设置"})})]})]}),"data"===c&&(0,o.jsxs)("div",{className:"tab-content",children:[(0,o.jsx)("h3",{children:"学习统计"}),(0,o.jsx)("div",{className:"stats-overview",children:(0,o.jsxs)("div",{className:"stats-grid",children:[(0,o.jsxs)("div",{className:"stat-card",children:[(0,o.jsx)("div",{className:"stat-icon",children:"📚"}),(0,o.jsxs)("div",{className:"stat-content",children:[(0,o.jsx)("div",{className:"stat-number",children:N.totalCategories}),(0,o.jsx)("div",{className:"stat-label",children:"知识分类"})]})]}),(0,o.jsxs)("div",{className:"stat-card",children:[(0,o.jsx)("div",{className:"stat-icon",children:"❓"}),(0,o.jsxs)("div",{className:"stat-content",children:[(0,o.jsx)("div",{className:"stat-number",children:N.totalQuestions}),(0,o.jsx)("div",{className:"stat-label",children:"题目总数"})]})]}),(0,o.jsxs)("div",{className:"stat-card",children:[(0,o.jsx)("div",{className:"stat-icon",children:"📖"}),(0,o.jsxs)("div",{className:"stat-content",children:[(0,o.jsx)("div",{className:"stat-number",children:N.reviewQuestions}),(0,o.jsx)("div",{className:"stat-label",children:"待复习"})]})]}),(0,o.jsxs)("div",{className:"stat-card",children:[(0,o.jsx)("div",{className:"stat-icon",children:"⚡"}),(0,o.jsxs)("div",{className:"stat-content",children:[(0,o.jsx)("div",{className:"stat-number",children:N.todayReviewed}),(0,o.jsx)("div",{className:"stat-label",children:"今日复习"})]})]})]})}),(0,o.jsx)("div",{className:"progress-section",children:(0,o.jsxs)("div",{className:"progress-item",children:[(0,o.jsxs)("div",{className:"progress-header",children:[(0,o.jsx)("span",{className:"progress-label",children:"复习进度"}),(0,o.jsxs)("span",{className:"progress-percent",children:[N.totalQuestions>0?Math.round((N.totalQuestions-N.reviewQuestions)/N.totalQuestions*100):0,"%"]})]}),(0,o.jsx)("div",{className:"progress-bar",children:(0,o.jsx)("div",{className:"progress-fill",style:{width:(N.totalQuestions>0?(N.totalQuestions-N.reviewQuestions)/N.totalQuestions*100:0)+"%"}})}),(0,o.jsxs)("div",{className:"progress-text",children:["已复习 ",N.totalQuestions-N.reviewQuestions," / ",N.totalQuestions," 题目"]})]})}),(0,o.jsxs)("div",{className:"data-section",children:[(0,o.jsx)("h4",{children:"数据导出"}),(0,o.jsxs)("div",{className:"data-item",children:[(0,o.jsxs)("div",{className:"data-info",children:[(0,o.jsx)("span",{className:"data-label",children:"导出学习数据"}),(0,o.jsx)("span",{className:"data-description",children:"导出您的所有分类和题目数据为 JSON 格式"})]}),(0,o.jsx)("button",{className:"data-action-btn",onClick:async()=>{l(!0);try{const[e,s]=await Promise.all([new(u().Query)("Category").equalTo("createdBy",t).find(),new(u().Query)("Question").equalTo("createdBy",t).include("category").find()]),a={exportTime:(new Date).toISOString(),user:{username:t.getUsername(),email:t.getEmail(),nickname:t.get("nickname")},categories:e.map(e=>({id:e.id,name:e.get("name"),description:e.get("description"),questionCount:e.get("questionCount")||0,createdAt:e.get("createdAt"),updatedAt:e.get("updatedAt")})),questions:s.map(e=>({id:e.id,title:e.get("title"),detailedAnswer:e.get("detailedAnswer"),oralAnswer:e.get("oralAnswer"),code:e.get("code"),difficulty:e.get("difficulty"),proficiency:e.get("proficiency"),appearanceLevel:e.get("appearanceLevel"),tags:e.get("tags")||[],category:e.get("category")?{id:e.get("category").id,name:e.get("category").get("name")}:null,createdAt:e.get("createdAt"),updatedAt:e.get("updatedAt")}))},n=JSON.stringify(a,null,2),c=new Blob([n],{type:"application/json"}),i=URL.createObjectURL(c),r=document.createElement("a");r.href=i,r.download=`knowledge-base-export-${(new Date).toISOString().split("T")[0]}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i),D("success","数据导出成功！")}catch(e){console.error("数据导出失败:",e),D("error",`数据导出失败: ${e.message}`)}finally{l(!1)}},disabled:r,children:r?"导出中...":"导出数据"})]})]}),(0,o.jsxs)("div",{className:"data-section",children:[(0,o.jsx)("h4",{children:"数据清理"}),(0,o.jsxs)("div",{className:"data-item danger",children:[(0,o.jsxs)("div",{className:"data-info",children:[(0,o.jsx)("span",{className:"data-label",children:"删除账户数据"}),(0,o.jsx)("span",{className:"data-description",children:"永久删除您的所有学习数据，此操作不可撤销"})]}),(0,o.jsx)("button",{className:"data-action-btn danger",disabled:!0,children:"即将开放"})]})]})]})]})]})]})}):null},vs=new i.E({defaultOptions:{queries:{staleTime:3e5,cacheTime:6e5,retry:1}}}),Ns=()=>{const e=(0,c.Zp)(),[s,t]=(0,a.useState)([]),[n,i]=(0,a.useState)(!0),[l,d]=(0,a.useState)(null),[h,m]=(0,a.useState)(7),[g,x]=(0,a.useState)([]),[j,p]=(0,a.useState)(!1),[v,N]=(0,a.useState)(null);(0,a.useEffect)(()=>{const e=u().User.current();N(e),e?y():i(!1)},[]);const y=async()=>{try{const e=await R();t(e),i(!1)}catch(e){d(e.message),i(!1)}};return(0,a.useEffect)(()=>{s.length>0&&(()=>{const e=new Date,t=24*h*60*60*1e3,a=s.filter(s=>{const a=new Date(s.updatedAt||s.createdAt);return e-a>=t}).sort((e,s)=>new Date(e.updatedAt||e.createdAt)-new Date(s.updatedAt||s.createdAt));x(a)})()},[s,h]),v?n?(0,o.jsx)("div",{className:"review-page",children:(0,o.jsxs)("div",{className:"loading-container",children:[(0,o.jsx)("div",{className:"modern-spinner"}),(0,o.jsx)("p",{children:"加载复习数据中..."})]})}):l?(0,o.jsx)("div",{className:"review-page",children:(0,o.jsxs)("div",{className:"error-container",children:[(0,o.jsx)("h2",{children:"加载失败"}),(0,o.jsx)("p",{children:l}),(0,o.jsx)("button",{onClick:()=>window.location.reload(),className:"retry-btn",children:"重试"})]})}):(0,o.jsx)(r.Ht,{client:vs,children:(0,o.jsxs)("div",{className:"review-page",children:[(0,o.jsx)("header",{className:"review-hero-section",children:(0,o.jsxs)("div",{className:"hero-content",children:[(0,o.jsxs)("div",{className:"user-welcome",children:[(0,o.jsx)("h1",{className:"hero-title",children:"📚 复习提醒"}),(0,o.jsxs)("p",{className:"hero-subtitle",children:["智能管理您的学习进度，",g.length>0?`有 ${g.length} 道题目需要复习`:"所有题目都已及时复习"]})]}),(0,o.jsxs)("div",{className:"review-stats-overview",children:[(0,o.jsxs)("div",{className:"stat-card",children:[(0,o.jsx)("div",{className:"stat-number",children:s.length}),(0,o.jsx)("div",{className:"stat-label",children:"总题目数"})]}),(0,o.jsxs)("div",{className:"stat-card warning",children:[(0,o.jsx)("div",{className:"stat-number",children:g.length}),(0,o.jsx)("div",{className:"stat-label",children:"待复习"})]}),(0,o.jsxs)("div",{className:"stat-card success",children:[(0,o.jsx)("div",{className:"stat-number",children:s.length-g.length}),(0,o.jsx)("div",{className:"stat-label",children:"已复习"})]})]})]})}),(0,o.jsx)(se,{reviewQuestions:g,setReviewQuestions:x,reviewThreshold:h,setReviewThreshold:m,showReviewSettings:j,setShowReviewSettings:p,onQuestionClick:t=>{const a=s.find(e=>e.id===t);a&&a.category&&e(`/category/${a.category.id}`)},onUpdateQuestionTime:async e=>{try{console.log("更新题目复习时间:",e);const s=(new Date).toISOString();return await M(e,{updatedAt:s}),t(t=>t.map(t=>t.id===e?{...t,updatedAt:s}:t)),console.log(`题目 ${e} 复习时间已更新`),!0}catch(e){throw console.error("更新题目时间失败:",e),e}},questions:s}),(0,o.jsx)("footer",{className:"review-footer",children:(0,o.jsxs)("div",{className:"footer-actions",children:[(0,o.jsx)("button",{onClick:()=>e("/"),className:"back-to-home-btn",children:"← 返回首页"}),(0,o.jsx)("div",{className:"footer-info",children:"基于间隔重复原理，帮助您高效记忆"})]})})]})}):(0,o.jsx)("div",{className:"review-page",children:(0,o.jsxs)("div",{className:"auth-required-container",children:[(0,o.jsx)("div",{className:"auth-required-icon",children:"🔐"}),(0,o.jsx)("h2",{children:"请先登录"}),(0,o.jsx)("p",{children:"登录后即可使用复习提醒功能"}),(0,o.jsxs)("div",{className:"auth-required-actions",children:[(0,o.jsx)("button",{onClick:()=>{window.dispatchEvent(new CustomEvent("showAuthModal",{detail:{tab:"login"}}))},className:"login-btn primary",children:"🚀 立即登录"}),(0,o.jsx)("button",{onClick:()=>{window.dispatchEvent(new CustomEvent("showAuthModal",{detail:{tab:"register"}}))},className:"login-btn secondary",children:"📝 注册账号"})]})]})})},ys=()=>{const[e,s]=(0,a.useState)(null),[t,n]=(0,a.useState)(!1);return(0,a.useEffect)(()=>{const e=e=>{e.preventDefault(),s(e),n(!0)};return window.addEventListener("beforeinstallprompt",e),()=>{window.removeEventListener("beforeinstallprompt",e)}},[]),t?(0,o.jsxs)("div",{style:{position:"fixed",bottom:"20px",right:"20px",background:"white",padding:"16px",borderRadius:"8px",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",zIndex:1e3,maxWidth:"300px"},children:[(0,o.jsx)("h4",{children:"安装应用"}),(0,o.jsx)("p",{children:"将此应用安装到您的设备上以获得更好的体验"}),(0,o.jsxs)("div",{style:{display:"flex",gap:"8px",marginTop:"12px"},children:[(0,o.jsx)("button",{onClick:async()=>{if(!e)return;e.prompt();const{outcome:t}=await e.userChoice;"accepted"===t?console.log("用户接受了安装"):console.log("用户拒绝了安装"),s(null),n(!1)},style:{background:"#007bff",color:"white",border:"none",padding:"8px 16px",borderRadius:"4px",cursor:"pointer"},children:"安装"}),(0,o.jsx)("button",{onClick:()=>{s(null),n(!1)},style:{background:"transparent",border:"1px solid #ccc",padding:"8px 16px",borderRadius:"4px",cursor:"pointer"},children:"稍后"})]})]}):null},fs=({questionId:e,onBack:s,onNavigateToQuestion:t})=>{const[n,c]=(0,a.useState)(null),[i,r]=(0,a.useState)(!0),[l,d]=(0,a.useState)(null),[h,u]=(0,a.useState)([]),[m,g]=(0,a.useState)(0);(0,a.useEffect)(()=>{x()},[e]);const x=async()=>{try{r(!0);const s=(await S.getCachedQuestions()).questions||[];u(s);let t=null,a=0;e?(t=s.find(s=>s.id===e),a=s.findIndex(s=>s.id===e)):(t=s[0]||null,a=0),t?(c(t),g(a)):d("未找到该题目或题目不在缓存中")}catch(e){console.error("加载离线题目失败:",e),d("加载离线题目失败: "+e.message)}finally{r(!1)}},j=()=>{if(m>0){const e=m-1;g(e),c(h[e]),t&&t(h[e].id)}},p=()=>{if(m<h.length-1){const e=m+1;g(e),c(h[e]),t&&t(h[e].id)}};return i?(0,o.jsx)("div",{className:"offline-detail-container",children:(0,o.jsxs)("div",{className:"loading-container",children:[(0,o.jsx)("div",{className:"modern-spinner"}),(0,o.jsx)("p",{children:"加载离线题目..."})]})}):l?(0,o.jsx)("div",{className:"offline-detail-container",children:(0,o.jsxs)("div",{className:"error-container",children:[(0,o.jsx)("div",{className:"error-icon",children:"❌"}),(0,o.jsx)("h3",{children:"加载失败"}),(0,o.jsx)("p",{children:l}),(0,o.jsx)("button",{onClick:s,className:"back-btn",children:"返回列表"})]})}):n?(0,o.jsxs)("div",{className:"offline-detail-container",children:[(0,o.jsxs)("div",{className:"offline-detail-header",children:[(0,o.jsxs)("div",{className:"header-left",children:[(0,o.jsx)("button",{onClick:s,className:"back-button",children:"← 返回"}),(0,o.jsx)("div",{className:"offline-badge",children:"离线模式"})]}),(0,o.jsxs)("div",{className:"header-center",children:[(0,o.jsx)("h3",{children:"题目详情"}),(0,o.jsxs)("span",{className:"question-counter",children:[m+1," / ",h.length]})]}),(0,o.jsxs)("div",{className:"header-right",children:[(0,o.jsx)("button",{onClick:j,disabled:0===m,className:"nav-button",children:"← 上一题"}),(0,o.jsx)("button",{onClick:p,disabled:m===h.length-1,className:"nav-button",children:"下一题 →"})]})]}),(0,o.jsxs)("div",{className:"offline-notice",children:[(0,o.jsx)("div",{className:"notice-icon",children:"📶"}),(0,o.jsxs)("div",{className:"notice-content",children:[(0,o.jsx)("strong",{children:"离线模式"}),(0,o.jsx)("span",{children:"当前处于离线状态，部分功能受限"})]})]}),(0,o.jsx)("div",{className:"question-card-wrapper",children:(0,o.jsxs)("div",{className:"offline-question-card",children:[(0,o.jsxs)("div",{className:"question-header",children:[(0,o.jsx)("h2",{className:"question-title",children:n.title}),(0,o.jsxs)("div",{className:"question-meta",children:[(0,o.jsx)("span",{className:"difficulty-badge",style:{backgroundColor:ws(n.difficulty)},children:bs(n.difficulty)}),(0,o.jsx)("span",{className:"category-tag",children:n.category?.name||"未分类"})]})]}),(0,o.jsxs)("div",{className:"question-content",children:[(0,o.jsxs)("div",{className:"answer-section",children:[(0,o.jsx)("h4",{children:"详细答案"}),(0,o.jsx)("div",{className:"answer-text",children:n.detailedAnswer||n.oralAnswer||"暂无答案"})]}),n.code&&(0,o.jsxs)("div",{className:"code-section",children:[(0,o.jsx)("h4",{children:"代码"}),(0,o.jsx)("pre",{className:"code-block",children:(0,o.jsx)("code",{children:n.code})})]})]})]})}),(0,o.jsxs)("div",{className:"offline-detail-footer",children:[(0,o.jsx)("button",{onClick:j,disabled:0===m,className:"footer-nav-button",children:"← 上一题"}),(0,o.jsxs)("div",{className:"progress-info",children:[(0,o.jsx)("div",{className:"progress-bar",children:(0,o.jsx)("div",{className:"progress-fill",style:{width:(m+1)/h.length*100+"%"}})}),(0,o.jsxs)("span",{children:["进度: ",m+1," / ",h.length]})]}),(0,o.jsx)("button",{onClick:p,disabled:m===h.length-1,className:"footer-nav-button",children:"下一题 →"})]})]}):(0,o.jsx)("div",{className:"offline-detail-container",children:(0,o.jsxs)("div",{className:"empty-state",children:[(0,o.jsx)("div",{className:"empty-icon",children:"📭"}),(0,o.jsx)("h3",{children:"题目不存在"}),(0,o.jsx)("p",{children:"该题目可能已被删除或不在缓存中"}),(0,o.jsx)("button",{onClick:s,className:"back-btn",children:"返回列表"})]})})},ws=e=>{switch(e){case"easy":return"#52c41a";case"medium":return"#faad14";case"hard":return"#f5222d";default:return"#666"}},bs=e=>{switch(e){case"easy":return"简单";case"medium":return"中等";case"hard":return"困难";default:return e}},Cs=e=>{const s=e.oralAnswer||e.detailedAnswer||"";return s.substring(0,120).replace(/[#*`]/g,"")+(s.length>120?"...":"")},Ss=()=>{const{categoryName:e,questionId:s}=(0,c.g)(),t=(0,c.Zp)(),[n,i]=(0,a.useState)([]),[r,l]=(0,a.useState)([]),[d,h]=(0,a.useState)(!0),[u,m]=(0,a.useState)("list");(0,a.useEffect)(()=>{g()},[e,s]);const g=async()=>{try{const t=(await S.getCachedQuestions()).questions||[];if(i(t),e&&"all"!==e){const s=t.filter(s=>s.category?.name===e||"未分类"===e);l(s)}else l(t);s&&m("detail")}catch(e){console.error("加载离线题目失败:",e)}finally{h(!1)}};return"detail"===u?(0,o.jsx)(fs,{questionId:s,onBack:()=>{m("list"),t("/offline/questions")},onNavigateToQuestion:e=>{t(`/offline/questions/${e}`)}}):d?(0,o.jsx)("div",{className:"offline-page",children:(0,o.jsxs)("div",{className:"loading-container",children:[(0,o.jsx)("div",{className:"modern-spinner"}),(0,o.jsx)("p",{children:"加载离线数据..."})]})}):0===r.length?(0,o.jsx)("div",{className:"offline-page",children:(0,o.jsxs)("div",{className:"empty-state",children:[(0,o.jsx)("div",{className:"empty-icon",children:"📦"}),(0,o.jsx)("h3",{children:"暂无离线题目"}),(0,o.jsx)("p",{children:"当前没有缓存的题目数据，请连接网络后缓存题目"}),(0,o.jsx)("button",{onClick:()=>window.history.back(),className:"back-btn",children:"返回"})]})}):(0,o.jsxs)("div",{className:"offline-page",children:[(0,o.jsxs)("div",{className:"offline-header",children:[(0,o.jsx)("button",{onClick:()=>window.history.back(),className:"back-button",children:"← 返回主页"}),(0,o.jsx)("h2",{children:"📦 离线题目"}),e&&"all"!==e&&(0,o.jsxs)("p",{children:["分类: ",e]}),(0,o.jsxs)("div",{className:"offline-stats",children:["共 ",r.length," 道题目 • 离线模式"]})]}),(0,o.jsxs)("div",{className:"offline-actions",children:[(0,o.jsxs)("div",{className:"view-options",children:[(0,o.jsx)("span",{children:"排序方式:"}),(0,o.jsxs)("select",{className:"sort-select",children:[(0,o.jsx)("option",{value:"default",children:"默认顺序"}),(0,o.jsx)("option",{value:"difficulty",children:"按难度"}),(0,o.jsx)("option",{value:"title",children:"按标题"})]})]}),(0,o.jsxs)("div",{className:"cache-info",children:["缓存时间: ",(new Date).toLocaleString()]})]}),(0,o.jsx)("div",{className:"offline-questions-list",children:r.map((e,s)=>(0,o.jsxs)("div",{className:"offline-question-card",onClick:()=>(e=>{m("detail"),t(`/offline/questions/${e.id}`)})(e),children:[(0,o.jsxs)("div",{className:"question-card-header",children:[(0,o.jsx)("h4",{className:"question-title",children:e.title}),(0,o.jsx)("span",{className:"difficulty-badge",style:{backgroundColor:ws(e.difficulty)},children:bs(e.difficulty)})]}),(0,o.jsxs)("div",{className:"question-card-body",children:[(0,o.jsx)("p",{className:"question-preview",children:Cs(e)}),(0,o.jsxs)("div",{className:"question-meta",children:[(0,o.jsx)("span",{className:"category-tag",children:e.category?.name||"未分类"}),(0,o.jsx)("span",{className:"offline-tag",children:"离线"})]})]}),(0,o.jsxs)("div",{className:"question-card-footer",children:[(0,o.jsxs)("span",{className:"question-date",children:["创建: ",new Date(e.createdAt).toLocaleDateString()]}),(0,o.jsx)("button",{className:"view-detail-btn",children:"查看详情 →"})]})]},e.id||s))})]})},ks=new i.E({defaultOptions:{queries:{refetchOnWindowFocus:!1,retry:1,staleTime:3e5,gcTime:6e5}}}),As=function(){const[e,s]=(0,a.useState)(!1),[t,n]=(0,a.useState)("login"),[i,l]=(0,a.useState)(!1),[d,h]=(0,a.useState)("profile");return(0,a.useEffect)(()=>{const e=e=>{const t=e.detail?.tab||"login";n(t),s(!0)},t=e=>{const s=e.detail?.tab||"profile";h(s),l(!0)};return window.addEventListener("showAuthModal",e),window.addEventListener("showUserSettings",t),()=>{window.removeEventListener("showAuthModal",e),window.removeEventListener("showUserSettings",t)}},[]),(0,o.jsx)(r.Ht,{client:ks,children:(0,o.jsxs)(c.Kd,{children:[(0,o.jsx)(xs,{onShowAuthModal:(e="login")=>{n(e),s(!0)}}),(0,o.jsxs)(c.BV,{children:[(0,o.jsx)(c.qh,{path:"/",element:(0,o.jsx)(Ne,{})}),(0,o.jsx)(c.qh,{path:"/init",element:(0,o.jsx)(ss,{})}),(0,o.jsx)(c.qh,{path:"/category/:categoryId",element:(0,o.jsx)(rs,{})}),(0,o.jsx)(c.qh,{path:"/test",element:(0,o.jsx)(gs,{})}),(0,o.jsx)(c.qh,{path:"/review",element:(0,o.jsx)(Ns,{})}),(0,o.jsx)(c.qh,{path:"/offline/questions",element:(0,o.jsx)(Ss,{})}),(0,o.jsx)(c.qh,{path:"/offline/questions/:questionId",element:(0,o.jsx)(Ss,{})}),(0,o.jsx)(c.qh,{path:"/offline/category/:categoryName",element:(0,o.jsx)(Ss,{})}),(0,o.jsx)(c.qh,{path:"/offline/category/:categoryName/question/:questionId",element:(0,o.jsx)(Ss,{})})]}),(0,o.jsx)(js,{isOpen:e,onClose:()=>s(!1),defaultTab:t,onAuthSuccess:()=>{window.location.reload()}}),(0,o.jsx)(ps,{isOpen:i,onClose:()=>l(!1)}),(0,o.jsx)(ys,{})]})})};n.createRoot(document.getElementById("root")).render((0,o.jsx)(a.StrictMode,{children:(0,o.jsx)(As,{})})),"serviceWorker"in navigator&&window.addEventListener("load",async()=>{try{const e=await fetch("/sw.js");if(!e.ok)throw new Error(`sw.js not found: ${e.status}`);const s=e.headers.get("content-type");if(!s||!s.includes("javascript"))throw new Error(`Invalid MIME type: ${s}`);const t=await navigator.serviceWorker.register("/sw.js");console.log("SW registered successfully: ",t)}catch(e){console.log("SW registration failed: ",e),console.log("Error details:",e.message)}})}},e=>{e.O(0,[96],()=>e(e.s=1674)),e.O()}]);
//# sourceMappingURL=main.00a31b2a.js.map